<html>
<style type=text/css >
.h { display:none;}
.sel1 { background-color:#ccf;border:2px solid #448;}
.sel0 { background-color:transparent;border:2px solid transparent;}
</style>
<form name=f>
<table>
<tr><td style=height:100% >
<select style=margin-bottom:2px; onchange=setchg() name=set >
<option value=0 >*</option>
<option value=stan >Standard</option>
<option value=euro >European</option>
<option value=asym >Asymetric</option>
<option value=diam >Diamond</option>
<option value=onoff >On&amp;Off</option>
<option value=ono_diam >Diamonds</option>
</select>
<select style=float:right;margin-bottom:2px; onchange=setchg(1) name=uset >
</select>
<br>
<input type=button onclick=transf(0,event) value="v-" title="rotate text (Ctrl) rotate game" />
<input type=button onclick=transf(1,event) value="|" />
<input type=button onclick=transf(2,event) value="-" />
<input type=button onclick=transf(4,event) value="<" />
<input type=button onclick=transf(7,event) value=">" />
<input type=button onclick=transf(3,event) value="*>" />
<input type=button onclick=transf(5,event) value="bw" />
<input type=button onclick=transf(6,event) value="O" />
<input style=float:right; type=button onclick=game2txt(1) value="&lt;text&lt;game&lt;" />
</td><td>
<input name=onoff type=radio value=0 checked onclick=onoffchg(1,0,this,event) style="margin:0px;" title="soliter" />
<input name=onoff type=radio value=2 onclick=onoffchg(1,0,this,event) style="margin:0px;" title="shifter" />
<input name=onoff type=radio value=3 onclick=onoffchg(1,0,this,event) style="margin:0px;" title="faller" />
<input name=onoff type=radio value=1 onclick=onoffchg(1,0,this,event) style="margin:0px;" title="on&amp;off" />
<input name=diag type=checkbox onclick=onoffchg(0,0,this,event) title="enable diagonal" />X
<select style=margin-bottom:2px; name=onoff6 title="on&amp;off hexa and penta mode">
<option value=0 >*</option>
<option value=1 selected >&#x25b3</option>
<option value=2 >&#x2312</option>
<option value=3 >X</option>
<option value=4 >-</option>
<option value=6 >^</option>
<option value=7 >T</option>
<option value=8 >S</option>
<option value=9 >]</option>
</select>
<input name=ooo type=checkbox onclick=onoffchg(0,0,this,event) title="onoff around" />O
<input name=oo3 type=checkbox onclick=onoffchg(0,0,this,event) title="onoff 3 state" />3
<input name=ooc type=checkbox onclick=onoffchg(0,0,this,event) title="onoff 3 cross" />C
<input name=oox type=checkbox onclick=onoffchg(0,0,this,event) title="onoff extent" />&#x2191
|
<input class=h name=hexa type=radio checked value=4 title=squares />
<svg id=hexa0 width=20 height=20 style=vertical-align:middle onclick=_sethex(0) >
<rect x=2 y=2 width=8 height=8 stroke=black stroke-width=1 fill=none />
<rect x=10 y=2 width=8 height=8 stroke=black stroke-width=1 fill=none />
<rect x=2 y=10 width=8 height=8 stroke=black stroke-width=1 fill=none />
<rect x=10 y=10 width=8 height=8 stroke=black stroke-width=1 fill=none />
</svg>
<input class=h name=hexa type=radio value=6 title=hexagons />
<svg id=hexa1 width=24 height=20 style=vertical-align:middle onclick=_sethex(1) >
<polygon points="10,2 14,5 14,9 10,12 6,9 6,5 " style="fill:none;stroke:black;stroke-width:1;stroke-linejoin:round" />
<polygon points="6,9 10,12 10,16 6,19 2,16 2,12 " style="fill:none;stroke:black;stroke-width:1;stroke-linejoin:round" />
<polygon points="18,2 22,5 22,9 18,12 14,9 14,5 " style="fill:none;stroke:black;stroke-width:1;stroke-linejoin:round" />
<polygon points="14,9 18,12 18,16 14,19 10,16 10,12 " style="fill:none;stroke:black;stroke-width:1;stroke-linejoin:round" />
</svg>
<input class=h name=hexa type=radio value=3 title=triangles />
<svg id=hexa2 width=20 height=20 style=vertical-align:middle onclick=_sethex(2) >
<polygon points="10,1,5.5,10,14.5,10 " style="fill:none;stroke:black;stroke-width:1;stroke-linejoin:round" />
<polygon points="10,19,5.5,10,14.5,10 " style="fill:none;stroke:black;stroke-width:1;stroke-linejoin:round" />
<polygon points="5.5,10,1,19,10,19 " style="fill:none;stroke:black;stroke-width:1;stroke-linejoin:round" />
<polygon points="14.5,10,19,19,10,19 " style="fill:none;stroke:black;stroke-width:1;stroke-linejoin:round" />
</svg>
<input class=h name=hexa type=radio value=34 title="2 triangles in squares" />
<svg id=hexa3 width=20 height=20 style=vertical-align:middle onclick=_sethex(3) >
<polygon points="1,1 19,1 19,19 1,19" style="fill:none;stroke:black;stroke-width:1;stroke-linejoin:round" />
<polygon points="10,1 1,10 10,19 19,10" style="fill:none;stroke:black;stroke-width:1;stroke-linejoin:round" />
<polyline points="10,1 10,19" style="stroke:black;stroke-width:1;stroke-linejoin:round" />
<polyline points="1,10 19,10" style="stroke:black;stroke-width:1;stroke-linejoin:round" />
</svg>
<input class=h name=hexa type=radio value=34 title="4 triangles in squares" />
<svg id=hexa4 width=20 height=20 style=vertical-align:middle onclick=_sethex(4) >
<rect x=1 y=1 width=18 height=18 style="fill:none;stroke:black;stroke-width:1;stroke-linejoin:round" />
<line x1=1 y1=1 x2=19 y2=19 style="fill:none;stroke:black;stroke-width:1;stroke-linejoin:round" />
<line x1=1 y1=19 x2=19 y2=1 style="fill:none;stroke:black;stroke-width:1;stroke-linejoin:round" />
</svg>

<input class=h name=hexa type=radio value=5 title="pentagons" />
<svg id=hexa5 width=20 height=20 style=vertical-align:middle onclick=_sethex(5) >
<polygon points="1,14 1,6 10,2 19,6 19,14 10,18" style="fill:none;stroke:black;stroke-width:1;stroke-linejoin:round" />
<polyline points="4,4 8,10 12,10 16,16" style="stroke:black;fill:none;stroke-width:1;stroke-linejoin:round" />
<polyline points="16,4 12,10 8,10 4,16" style="stroke:black;fill:none;stroke-width:1;stroke-linejoin:round" />
</svg>

<input class=h name=hexa type=radio value=6 title="cubes" />
<svg id=hexa6 width=20 height=20 style=vertical-align:middle onclick=_sethex(6) >
<polygon points="1,5 10,1 19,5 19,15 10,19 1,15" style="fill:none;stroke:black;stroke-width:1;stroke-linejoin:round" />
<polyline points="1,5 10,10 19,5" style="stroke:black;fill:none;stroke-width:1;stroke-linejoin:round" />
<polyline points="10,10 10,19" style="stroke:black;fill:none;stroke-width:1;stroke-linejoin:round" />
</svg>

<input class=h name=hexa type=radio value=7 title="delta" />
<svg id=hexa7 width=20 height=20 style=vertical-align:middle onclick=_sethex(7) >
<polygon points="1,19 10,1 19,19 " style="fill:none;stroke:black;stroke-width:1;stroke-linejoin:round" />
<polyline points="5,10 10,13 15,10" style="stroke:black;fill:none;stroke-width:1;stroke-linejoin:round" />
<polyline points="10,13 10,19" style="stroke:black;fill:none;stroke-width:1;stroke-linejoin:round" />
</svg>

<input class=h name=hexa type=radio value=8 title="trapez" />
<svg id=hexa8 width=20 height=20 style=vertical-align:middle onclick=_sethex(8) >
<polygon points="1,5 10,1 19,5 19,15 10,19 1,15" style="fill:none;stroke:black;stroke-width:1;stroke-linejoin:round" />
<polyline points="10,1 10,19" style="stroke:black;fill:none;stroke-width:1;stroke-linejoin:round" />
</svg>

<input class=h name=hexa type=radio value=9 title="dodeca" />
<svg id=hexa9 width=20 height=20 style=vertical-align:middle onclick=_sethex(9) >
<polygon points="1,5 10,1 19,5 19,15 10,19 1,15" style="fill:none;stroke:black;stroke-width:1;stroke-linejoin:round" />
<polyline points="14.5,3 10,10 1,10" style="stroke:black;fill:none;stroke-width:1;stroke-linejoin:round" />
<polyline points="14.5,17 10,10" style="stroke:black;fill:none;stroke-width:1;stroke-linejoin:round" />
</svg>

<br>
<input style=margin-bottom:2px type=button onclick=draw(1) value="&gt;text&gt;game&gt;" />
<input type=button onclick=_undo(event.ctrlKey?10:1) value="undo &#x21a9;" />
<input type=button onclick=_redo(event.ctrlKey?10:1) value="&#x21aa; redo" />
pegs:<span style="font-size:18px;font-weight:bold;" id=pegs>0</span>
moves:<span style="font-size:18px;font-weight:bold;" id=moves>0</span><input style=margin-left:2px; type=button onclick=_moves(-moves); value=x /> 
|
<input name=peg type=checkbox onclick=_drawboard() title="polygon peg"/>
<input name=rou type=checkbox onclick="window.rou=+f.rou.checked;_drawboard()" title="rounded cell"/>
<input name=corn type=checkbox onclick=cornchg(1,this,event) title="corner mark" />
|
<input name=mono type=radio checked value=1 />
<svg width=20 height=20 style=vertical-align:middle onclick=_setclr(0) >
<rect x=2 y=2 width=16 height=16 stroke=black stroke-width=1 fill=#fff />
</svg>
<input name=mono type=radio value=2 />
<svg width=20 height=20 style=vertical-align:middle onclick=_setclr(1) >
<rect x=2 y=2 width=8 height=8 stroke=black stroke-width=1 fill=#feb />
<rect x=10 y=10 width=8 height=8 stroke=black stroke-width=1 fill=#db9 />
</svg>
<input name=mono type=radio value=21 />
<input name=mono type=radio value=30 />
<svg width=20 height=20 style=vertical-align:middle onclick=_setclr(3) >
<rect x=7 y=2 width=8 height=8 stroke=black stroke-width=1 fill=#bbf />
<rect x=2 y=10 width=8 height=8 stroke=black stroke-width=1 fill=#fbb />
<rect x=10 y=10 width=8 height=8 stroke=black stroke-width=1 fill=#ffb />
</svg>
<input name=mono type=radio value=31 />
<input name=mono type=radio value=4 />
<svg width=20 height=20 style=vertical-align:middle onclick=_setclr(5) >
<rect x=2 y=2 width=8 height=8 stroke=black stroke-width=1 fill=#ffc />
<rect x=10 y=2 width=8 height=8 stroke=black stroke-width=1 fill=#c88 />
<rect x=2 y=10 width=8 height=8 stroke=black stroke-width=1 fill=#88c />
<rect x=10 y=10 width=8 height=8 stroke=black stroke-width=1 fill=#cff />
</svg>

<input name=grd1 type=checkbox onclick=grdchg(1,this,event) title="background gradient mode
ctrl - radial
shift - center radial" />
<input name=grd2 type=checkbox onclick=grdchg(2,this,event) title="peg gradient" />

</td>
</tr>
<tr><td style=vertical-align:top >

<textarea name=ta type=textarea style="xfont-family:fixed;" wrap=off rows=25 cols=40 style="width:600px;overflow:scroll;">
            OOO
  OOO       OOO
 OOOOO      OOO
OOOOOOO  OOOOOOOOO
OOOOOOO  OOOOxOOOO
OOOOOOO  OOOOOOOOO
 OOOOO      OOO
  OOx       OOO
            OOO
</textarea>
<br/>
 <a download="out.txt" target=_blank id=asave ></a>
 <input type=file name=file id=file onchange=_file_open() title="open text from disk file ..." />
 <input type=button value=Save onclick=_file_save() title="save text to disk file ..."/>
 <br>
 <input type=button value=svg onclick=_svg_save() title="export svg to disk file ..."/>
 <input type=button value=pdf onclick=_pdf_save() title="export pdf to disk file ..."/>
</td> <td style=vertical-align:top >
<canvas id="cv1" width="640" height="480" style="border:1px solid black;"></canvas>
<br>
<input name=des type=radio checked value=0 />
<x onclick=_setdes(0)>play</x>
<input name=des type=radio value=1 />
<x onclick=_setdes(1)>
<svg width=20 height=20 style=vertical-align:bottom >
<circle cx=6 cy=6 r=3 stroke=black stroke-width=1 fill=#ff0 />
<circle cx=8 cy=12 r=3 stroke=black stroke-width=1 fill=#ddd />
<circle cx=14 cy=14 r=3 stroke=black stroke-width=1 fill=#000 />
</svg>
free</x>
<input name=des type=radio value=2 />
<x onclick=_setdes(2)>
<svg width=20 height=20 style=vertical-align:bottom >
<polygon points="4,8 8,4 18,14 14,18" 
 stroke-width=1 stroke=black stroke-linejoin=round fill=#ddd />
<circle cx=6 cy=6 r=3 stroke=black stroke-width=1 fill=#ff0 />
<circle cx=16 cy=16 r=3 stroke=black stroke-width=1 fill=#000 />
</svg>
line</x>
<input name=des type=radio value=3 />
<x onclick=_setdes(3)>
<svg width=20 height=20 style=vertical-align:bottom >
<rect x=4 y=4 width=12 height=12 stroke=black stroke-width=1 fill=#ddd />
<circle cx=6 cy=6 r=3 stroke=black stroke-width=1 fill=#ff0 />
<circle cx=14 cy=14 r=3 stroke=black stroke-width=1 fill=#000 />
</svg>
rect</x>
<input style="margin:3px 0 0 3px" name=des type=radio value=4 />
<x onclick=_setdes(4)>
<svg width=20 height=20 style=vertical-align:bottom >
<circle cx=10 cy=10.5 r=9 stroke=black stroke-width=1 fill=#ddd />
<circle cx=10 cy=10 r=3 stroke=black stroke-width=1 fill=#ff0 />
<circle cx=16 cy=16 r=3 stroke=black stroke-width=1 fill=#000 />
</svg>
</x>
<input style="margin:3px 3px 0 0" name=des type=radio value=5 />
<x onclick=_setdes(5)>
<svg width=20 height=20 style=vertical-align:bottom >
<circle cx=10 cy=10.5 r=9 stroke=black stroke-width=1 fill=#ddd />
<circle cx=4 cy=4 r=3 stroke=black stroke-width=1 fill=#ff0 />
<circle cx=16 cy=16 r=3 stroke=black stroke-width=1 fill=#000 />
</svg>
circl</x>
<input name=des type=radio value=6 />
<x onclick=_setdes(6)>
<svg width=20 height=20 style=vertical-align:bottom >
<polygon points="10,7 10,2 15,2 19,10 16,16 12,19 10,17 6,19 2,13" 
 stroke-width=1 stroke=black stroke-linejoin=round fill=#ddd />
<circle cx=5 cy=5 r=3 stroke=black stroke-width=1 fill=#ff0 />
<circle cx=12 cy=12 r=3 stroke=black stroke-width=1 fill=#000 />
</svg>
fill</x>
<input name=des type=radio value=7 />
<x onclick=_setdes(7)>
<svg width=20 height=20 style=vertical-align:bottom >
<line x1=5 y1=5 x2=15 y2=15 style="fill:none;stroke:black;stroke-width:2;stroke-linejoin:round" />
<circle cx=5 cy=5 r=3 stroke=black stroke-width=1 fill=#000 />
<circle cx=15 cy=15 r=3 stroke=black stroke-width=1 fill=#00 />
</svg>
edge</x>
<input name=des type=radio value=9 />
<x onclick=_setdes(9)>
<svg width=16 height=16 style=vertical-align:bottom >
<rect x="02" y="2" width="4" height="4" style="fill:#f8c;stroke:#000;" />
<rect x="06" y="2" width="4" height="4" style="fill:#cf8;stroke:#000;" />
<rect x="10" y="2" width="4" height="4" style="fill:#8cf;stroke:#000;" />
<rect x="02" y="6" width="4" height="4" style="fill:#8ff;stroke:#000;" />
<rect x="06" y="6" width="4" height="4" style="fill:#f8f;stroke:#000;" />
<rect x="10" y="6" width="4" height="4" style="fill:#ff8;stroke:#000;" />
<rect x="02" y="10" width="4" height="4" style="fill:#fc8;stroke:#000;" />
<rect x="06" y="10" width="4" height="4" style="fill:#8fc;stroke:#000;" />
<rect x="10" y="10" width="4" height="4" style="fill:#c8f;stroke:#000;" />
</svg>
color
</x>
<input name=des type=radio value=10 />
<!--
<input name=des type=radio value=8 />
<x onclick=_setdes(8)>
<svg width=22 height=20 style=vertical-align:bottom >
<polygon points="4.5,4 10.5,10 4.5,16 " style="fill:#ddd;stroke:black;stroke-width:1;stroke-linejoin:round" />
<polygon points="10.5,4 16.5,10 10.5,16 " style="fill:#ddd;stroke:black;stroke-width:1;stroke-linejoin:round" />
<circle cx=3.5 cy=10 r=3 stroke=black stroke-width=1 fill=#ff0 />
<circle cx=16.5 cy=10 r=3 stroke=black stroke-width=1 fill=#000 />
&gt;&gt;&gt;</x>
-->
<br>
<input name=white type=checkbox title="edit with white" />&#9898; white
<table title="black&amp;white jump rules" style=text-align:center ><tr><td colspan=4>
<select style=margin-bottom:2px; name=white2 onchange=whitechg(1)>
<option value=xxxx selected>xxxx : all clears</option>
<option value=wxwx >wxwx : black to white</option>
<option value=xxff >xxff : white jump flips</option>
<option value=xffx >xffx : cross jump flips</option>
<option value=xbxb >xbxb : white to black</option>
<option value=xffe >xffe : black only</option>
<option value=xxee >xxee : white just jump</option>
<option value=xxwe >xxwe : white makes white</option>
</select></td></tr>
<tr><th>jump</th><th>over</th><td>result</td><td>
</td></tr>
<tr><td>&#9899;</td><td>&#9899;</td> <td><select name=w0 onchange=whitechg(2)><option value=x>X</option><option value=b>&#9899;</option><option value=w>&#9898;</option></select> </td></tr>
<tr><td>&#9899;</td><td>&#9898;</td> <td><select name=w1 onchange=whitechg(2)><option value=x>X</option><option value=b>&#9899;</option><option value=w>&#9898;</option></select> </td></tr>
<tr><td>&#9898;</td><td>&#9899;</td> <td><select name=w2 onchange=whitechg(2)><option value=x>X</option><option value=b>&#9899;</option><option value=w>&#9898;</option></select> </td></tr>
<tr><td>&#9898;</td><td>&#9898;</td> <td><select name=w3 onchange=whitechg(2)><option value=x>X</option><option value=b>&#9899;</option><option value=w>&#9898;</option></select> </td></tr>
<tr><td colspan=3><input type=color name=uco value=#6688aa onchange=ucochg(this,event); onclick=ucoclick(this,event) title="ctrl,shift rotate mem colors, ctrl&shift reset mem colors" /></td></tr>
</table>

<script type="text/javascript">
var cv1=document.getElementById("cv1");
var ctx=cv1.getContext("2d");
var grd,mp,mm,mm1,drawms,tdraw,design;

var cell=32,cell2=36,cell5=48,cell7=48,brd=-8,mono=f.mono.value,grdm=0,grdx=15,grdy=16,edgew=1.5;
var cell6x=40,cell6y=Math.round(cell6x*Math.sqrt(3)/2);
var cell8y=60,cell8x=Math.round(cell8y*Math.sqrt(3)/2);
var onoff=0,oox,ooo,ooc,oo3;
var faller=0,shifter=0,diag=0,quad=0,hexa=0,tria=0,tria2=0,tria4=0,penta=0,cubes=0,delta=0,trap=0,deca=0,white=0,rou=0,corn=2;
var cell3x=48,cell3y=Math.round(cell3x*Math.sqrt(3)/2);
var cell9x=64,cell9y=Math.round(cell9x*Math.sqrt(3)/2);
var clr2=['#feb','#db9','#a86'],clr3=['#bbf','#fbb','#ffb'],clr4=['#ffc','#c88','#88c','#cff'];
var board,undo,redo,moves=0,sele=[],block,uco,pgc;

function click(name,func) {
  var i,x=document.querySelectorAll('input[name="'+name+'"]');
  for(i=0;i<x.length;i++) x[i].addEventListener("click",func);
  return x;
}
cv1.onmousedown=_mdown;
cv1.onmousemove=_mmove;
cv1.onmouseup=_mup;
window.onkeyup=_kup;
var i,hxa=click('hexa',hexachg),dxa=click('des',deschg),mxa=click('mono',monochg),depth=0,game={},ugame={};
grdchg();monochg();hexachg();onoffchg();deschg();whitechg(1);cornchg();
draw(1);
game['stan']='//@Standard,quad,sol\n\
  OOO  \n\
  OOO  \n\
OOOOOOO\n\
OOO.OOO\n\
OOOOOOO\n\
  OOO  \n\
  OOO  ';
game['asym']='//@Asymetric,quad,sol\n\
  OOO  \n\
  OOO  \n\
  OOO  \n\
OOOOOOOO\n\
OOO.OOOO\n\
OOOOOOOO\n\
  OOO   \n\
  OOO   ';
game['euro']='//@European,quad,sol\n\
  OOO  \n\
 OOOOO \n\
OOO.OOO\n\
OOOOOOO\n\
OOOOOOO\n\
 OOOOO \n\
  OOO  ';
game['diam']='//@Diamond,quad,sol\n\
    O   \n\
   OOO  \n\
  OOOOO \n\
 OOOOOOO\n\
OOOO.OOOO\n\
 OOOOOOO\n\
  OOOOO \n\
   OOO  \n\
    O   ';
game['onoff']='//@on&off,quad,onoff\n\
OOOO     OOOOO\n\
OOOO     OOOOO\n\
OOOO     OOOOO\n\
OOOO     OOOOO\n\
         OOOOO\n\
OOOOOOO\n\
OOOOOOO OOOOOO\n\
OOOOOOO OOOOOO\n\
OOOOOOO OOOOOO\n\
OOOOOOO OOOOOO\n\
OOOOOOO OOOOOO\n\
OOOOOOO OOOOOO\n\
';
game['ono_diam']='//@Diamonds,tria,onoff\n\
    OOO        OOO\n\
   OOOOO      OOOOO\n\
  OOOOOOO    OOOOOOO\n\
 OOOOOOOOO  OOOOOOOOO\n\
 OOOOOOOOO  OOOOOOOOO\n\
  OOOOOOO    OOOOOOO\n\
   OOOOO      OOOOO\n\
    OOO        OOO\n\
';

function sgn(x) { return x<0?-1:x>0?1:0;}
function sgn2(x) { return x<0?-1:1;}
function setchg(u) {
  var s=(u?f.uset:f.set).value,txt=(u?ugame:game)[s];
  if(txt) f.ta.value=txt,draw(1);
}
function rol(n,x,c,r) {
  if(r) c=n-c;
  c=(c%n);if(c<0) c+=n;
  return ((x<<c)|(x>>(n-c)))&((1<<n)-1);
}
function _encode(x) { return x.replace('&','&amp;').replace('<','&lt;').replace('>','&gt;');}
function _uadd(id,name,txt) {
  ugame[id]=txt;
  f.uset.innerHTML+='<option value='+id+'>'+_encode(name)+'</option>';
  if(!f.ta.value) f.ta.value=txt,draw(1);
}
function _uset(txt) {
  var i,j=0,ln=txt.split(/\r?\n/g),m,n,id=1;
  for(i=0;i<=ln.length;i++) {
    if(i==ln.length||(m=/^\/\/.*@([^,]+)/.exec(ln[i]))) {
      if(i>0&&!n) _uadd(id++,'^',ln.slice(0,i).join('\n'));
      if(n) _uadd(id++,n,ln.slice(j,i).join('\n'));
      j=i;if(m) n=m[1];
    }
  }
  if(!n) _uadd(id++,'*',txt);
}
  
function _pegs(x) { document.getElementById('pegs').innerText=x; }
function _moves(x) {
  moves+=x;
  document.getElementById('moves').innerText=moves;
}
function _max() {
  var mx=0,my=0,r,x,y,c;
  for(y=0;y<board.length;y++)
    for(r=board[y],x=r.length;x-->0;)
      if(_xo(r[x])) {
        if((x=2*x+(y&1))>mx) mx=x;
        my=y;
        break;
      }
  return [mx,my];
}

function _resizea(mx,my) {
  var s=_max();
  if(mx>0&&mx>s[0]) s[0]=mx;
  if(my>0&&my>s[1]) s[1]=my;
  _resize2(s[0]+4,s[1]+2);
}
function _resize2(w2,h) {
  var wn,hn;
  if(deca) {
    wn=2*brd+((w2+14)/4|0)*cell8x,hn=2*brd+h*cell8y*3/4;
  } else if(trap) {
    wn=2*brd+((w2+14)/4|0)*cell8x,hn=2*brd+h*cell8y*3/4;
  } else if(delta) {
    wn=2*brd+((w2+26)/12|0)*cell9x,hn=2*brd+h*cell9y;
  } else if(cubes) {
    wn=2*brd+((w2+14)/6|0)*cell8x,hn=2*brd+h*cell8y*3/4;
  } else if(penta) {
    wn=2*brd+(((w2+2)>>2)+1)*cell7,hn=2*brd+h*cell7;
  } else if(tria4) {
    wn=2*brd+(((w2+2)>>2)+1)*cell5,hn=2*brd+((h+3)>>1)*cell5;
  } else if(tria2) {
    wn=2*brd+(((w2+2)>>2)+1)*cell2,hn=2*brd+h*cell2;
  } else if(tria) {
    wn=2*brd+((w2>>1)+1)*cell3x/2,hn=2*brd+h*cell3y;
  } else if(hexa) {
    wn=2*brd+w2*cell6y/2,hn=2*brd+(h*cell6x*3+1)/4;
  } else wn=2*brd+(w2>>1)*cell,hn=2*brd+h*cell;
  _resize(wn,hn);
}

function _resize(w,h) {
  if(cv1.width==w&&cv1.height==h) return;
  cv1.width=w; cv1.height=h;
  grd = ctx.createLinearGradient(0, 0, w, h);
  grd.addColorStop(0, "#CCBBAA");
  grd.addColorStop(1, "#AABBCC");
}

function _extentx() {
  for(lx=1,e=1,y=0;y<board.length;y++) board[y].splice(0,0,' ');
  _blockmove(1,0);
}
function _extenty() {
  board.splice(0,0,[]);
  for(e=0;e<board[1].length;e++) board[0].push(' ');
  _blockmove(0,1);
}

function _extent(x,y) {
  var s=_max(),w=(s[0]>>1)+2,h=s[1]+2,w2=w,h2=h;
  if(x+2>w2) w2=x+2;if(y+2>h2) h2=y+2;
  if(w2<=w&&h2<=h) return 0;
  while(h2>board.length) board.push([]);
  for(y=0;y<h2;y++)
    for(r=board[y];w2>r.length;) r.push(' ');
  return 1;
}

function _extent2(bo,x,y) {
  var b;
  while(y>=bo.length) bo.push([]);
  for(y=0;y<bo.length;y++)
    for(b=bo[y];x>=b.length;b.push(' '));
    
}

function _rotate(txt) {
  var x,y,o,i,r=txt.split(/\r?\n/g),rl=r.length,m=0,l;
  for(i=0;i<rl;i++) if((l=r[i].length)>m) m=l;
  o='';
  for(x=m;x-->0;) {
    if(o) o+='\n';
    for(y=0,l=0;y<rl;y++) 
      if(x<r[y].length) {
        for(;l<y;l++) o+=' ';
        o+=r[y][x],l++;
      }
  }
  return o;
}

function _reverse(txt,m) {
  var o='',a=0,b=m-1,o='',l=txt.length;
  for(a=0,b=m-1;b>=0;b--)
    o+=b<l?txt[b]:' ';
  return o;
}

function _vmirr(txt) {
  var x,y,o,i,r=txt.split(/\r?\n/g),rl=r.length,m=0,l;
  for(i=0;i<rl;i++) if((l=r[i].length)>m) m=l;
  o='';
  for(y=0;y<rl;y++) {
    if(o) o+='\n';
    o+=_reverse(r[y],m);
  }
  return o;
}

function _hmirr(txt) {
  var r=txt.replace(/(\s+)$/,'').split(/\r?\n/g);
  return r.reverse().join('\n');
}

function _right(txt,dup) { 
  var i,a=txt.split('\n');
  for(i=0;i<a.length;i++)
    a[i]=(dup&&a[i].length>0?a[i][0]:' ')+a[i];
  return a.join('\n');
}
function _left(txt) { return txt.replace(/^.|(\n)./g,'$1'); }

function _iscmd(txt) { return txt.match(/^\s*\/\//);}
function transf(mode,e) {
  if(e.ctrlKey) {
    if(!mode||mode<3) transf2(mode);
    else transf3(mode);
    return;
  }
  var i,txt=f.ta.value,t,ta=txt.split(/\r?\n/);
  for(i=0,txt='';i<ta.length;) {
    if(_iscmd(ta[i])) { txt+=(i?'\n':'')+ta[i];i++;continue;}
    for(j=i+1,t1=ta[i];j<ta.length&&!_iscmd(ta[j]);j++) t1+='\n'+ta[j];
    if(mode==1) t1=_vmirr(t1);
    else if(mode==2) t1=_hmirr(t1);
    else if(mode==3) t1=_right(t1,1);
    else if(mode==4) t1=_left(t1);
    else if(mode==5) t1=t1.replace(/[WwOo]/g,function(x) { return x=='W'||x=='w'?'O':'W';});
    else if(mode==6) {t=t1.replace(/[.xX]/g,'O');if(t==t1) t=t.replace(/[Ww]/g,'O');t1=t;}
    else if(mode==7) t1=_right(t1,0);
    else t1=_rotate(t1);
    txt+=(i?'\n':'')+t1;
    i=j;
  }
  f.ta.value=txt;
}

function _div2p(x) { return (x+1)>>1;}
function _div2n(x) { return (x)>>1;}
function transf2(mode) {
  var b,b2,x2,y2,sx,sy,x,x1,y1,x4,y,j,xi=1<<20,xa=0,yi=1<<20,ya=0,bfx;
  _block2board();
  for(j=n=0;j<2;j++) {
    for(y=0;y<board.length;y++)
      for(x=0,b=board[y];x<b.length;x++) {
        if(_xob(b[x])) {
          if(trap) {
            var d=(x+1)%2,cx=(x+1-d)/2,dx=y&1?0:-2,dd=(cx+2*(y&1))%3;
            y2=y;
            if(mode==1)  cx=-cx,d=1-d,cx+=1^y&1;
            else if(mode==2) cx+=0,d=dd==1?d:1-d,y2=-y;
            else m=cx,y2=m-_div2n(y),cx=-y-_div2p(y2),d=(d+2)%3;
            x2=2*cx+d-1;
          } else if(deca) {
            var d=(x+2)%3,cx=(x+2-d)/3,dx=y&1?0:-3;
            y2=y;
            if(mode==1)  cx=-cx,cx+=1^y&1;
            else if(mode==2) cx+=0,y2=-y,d=d==1?d:2-d;
            else m=cx,y2=m-_div2n(y),cx=-y-_div2p(y2),d=(d+1)%3;
            x2=3*cx+d-2;
          } else if(cubes) {
            var d=(x+2)%3,cx=(x+2-d)/3,dx=y&1?0:-3;
            y2=y;
            if(mode==1)  cx=-cx,d=d?3-d:d,cx+=1^y&1;
            else if(mode==2) cx+=(d==2&&(y&1)?1:0)+(d==1&&!(y&1)?-1:0),y2=-y+(d?-1:0),d=d?3-d:d;
            //else m=cx,y2=m-(y>>1),cx=-y+((y+1)/3|0)-_div2p(m)+((((m^1)&(y2^0))&1)^1),d=(d+2)%3;
            //else m=cx,y2=m-_div2n(y),cx=-y-_div2n(m)-_div2p(y2),d=(d+2)%3;
            else m=cx,y2=m-_div2n(y),cx=-y-_div2p(y2),d=(d+2)%3;
            x2=3*cx+d-2;
          } else if(penta) {
            var cx=(x+1)/2|0,x1=x&1,v=(cx+y)&1;
            y2=y;
            if(mode==1) cx=-cx,x1^=v;
            else if(mode==2) y2=-y,x1^=!v;
            else m=cx,cx=-y2+1,y2=m,x1^=!v;
            x2=2*cx-x1;
          } else if(tria4) {
            var dx=1^x&1,dy=1^y&1,m;
            r=dx+2*dy,x2=x-dx,y2=y-dy;
            if(mode==1) r=r==0?3:r==3?0:r,x2=-x2;
            else if(mode==2) r=r==1?2:r==2?1:r,y2=-y2;
            else r=r==1?3:r==3?2:r==2?0:1,m=x2,x2=-y2,y2=m;
            x2+=r&1,y2+=r&2?1:0;
          } else if(mode==1) x2=(hexa?(1^y&1):tria2?1:0)-x,y2=y;
          else if(mode==2) x2=x,y2=(tria?1:tria2?1:0)-y;
          else {
            if(tria2) {
              x1=x-1,y1=y-1,d=(0^x1^(x1>>1)^y1)&1;
              y2=-(x1>>1)+1,x2=2*y1+d+1;
            } else if(tria) {
              //y2=_div2p(-x-y+((y^x)&1)),x2=-x+y+-y2;
              y2=-_div2p(x-y),x2=x+y+y2;
            } else if(hexa) {
             x1=2*x+(y&1),y2=_div2n(y+x1),x4=_div2p(x1-3*y),x2=_div2p(x4+(y2&1));
             bfx=function(e) { e=(((e&63)>>5)|(e<<1))&63;return e;}
            } else {
              x2=-y,y2=x;
              bfx=function(e) { e=(((e&15)>>3)|(e<<1))&15;return e;}
            }
          }
          if(j) b2[sy+y2][sx+x2]=b[x];
          else {
            if(!n) xi=xa=x2,yi=ya=y2,n=1;
            else {
             if(x2<xi) xi=x2;else if(x2>xa) xa=x2;
             if(y2<yi) yi=y2;else if(y2>ya) ya=y2;
            }
          }
        }
      }
    if(!j) {
      sx=1-xi,sy=1-yi;
      if(!mode) {
        if(tria2) sx-=(sx-6)%4,sy-=(sy-6)%4,sx+=sx<1-xi?4:0,sy+=sy<1-yi?4:0;
        //if(tria&&((0^yi^xi)&1)) sy+=1;
        if(tria&&((1^yi^xi)&1)) sy+=1;
        if(hexa&&(yi&1)) sy+=1;
        if(penta) {
          var dx=sx&3,dy=sy&1;
          if(dx) dx=4-dx;
          if(dx>2) dy^=1,dx-=2;
          sx+=dx,sy+=dy;
        }
        if(cubes||deca) {
          var d=sx%3;if(d) sx+=d>0?3-d:-d;
          if(sy&1) sy++;
        }
      } else if(mode==1||mode==2) { 
        if((penta|hexa|tria||tria2||tria4)&&(sy&1)) sy++;
        if((tria||tria4)&&(sx&1)) sx++;
        if((penta|tria2)&&(sx&3)) sx+=4-(sx&3);
        if(cubes||deca) {
          var d=sx%3;
          if(cubes) {
            if(d) sx+=d>0?3-d:-d;
          } else {
            if(mode==1) { if(d) sx+=d>0?3-d:-d;}
          }
          if(sy&1) sy++;
        }
        if(trap) {
          var d=sx%2;if(d) sx+=d>0?2-d:-d;
          if(sy&1) sy++;
        }
      }
      b2=[];
      _extent2(b2,xa+sx+1,ya+sy+1);
    }
  }
  board=b2;
  _board2block(bfx);
  _resizea();
  _drawboard()
}

function transf3(mode) {
  var x,y,b,c,d,a=0,n=0;
  _block2board();
 while(1) {
  for(y=0;b=board[y];y++) {
    if(mode==4) { if(b.length>2) b.splice(1,1);}
    else if(mode==7) { b.splice(1,0,[' ']);}
    else if(mode==3) { b.splice(1,0,[b[1]]);}
    else {
      for(x=0;c=b[x];x++) {
        if(mode==5) { if((d=c[0]=='w')||c[0]=='o') b[x]=(d?'o':'w')+c.substr(1);}
        else if(mode==6) { if((d=c[0]=='x')||(a&&c[0]=='w')) n++,b[x]='o'+c.substr(1);}
      }
    }
  }
  if(mode==6&&!n&&!a) {a=1;continue;}
  break;
 }
  _board2block();
  if(mode==4||mode==3||mode==7) _resizea();
  _drawboard()
}


function monochg(e) { 
  mono=mxa[1].checked?2:mxa[2].checked?e&&e.ctrlKey?22:21:mxa[3].checked?30:mxa[4].checked?31:mxa[5].checked?4:1;
  if(e) _drawboard(); 
}
function grdchg(i,t,e,x) {
  grdm2=f.grd2.checked;
  if(i!=2) {
    if(!x) grdm=f.grd1.checked*(e?1+e.ctrlKey+2*e.shiftKey:1);
    if(e&&(e.ctrlKey||e.shiftKey)&&!grdm) {
      grdm=5+e.shiftKey*(1+e.ctrlKey);
      f.grd1.checked=1;
    }
    if(tria||tria2||tria4) grdx=1,grdy=2;
    else grdx=grdy=1;
  }
  if(e) _drawboard();
}
function cornchg(i,t,e) {
  if(i) corn=(corn+1)%3;
  f.corn.checked=!!corn;
  if(e) _drawboard();
}

function onoffchg(dr,m,src,e) { 
  if(src&&src.checked&&/oo/.test(src.name)&&!f.onoff[2].checked)
    f.onoff[2].checked=true;
  var x=+f.onoff.value;
  if(m) x=1,f.onoff[2].checked=true;
  onoff=x==1;
  shifter=x==2;
  faller=x==3;
  diag=+f.diag.checked;
  if(src&&src.name=='diag') diag=diag?e.ctrlKey?2:1:0;
  oox=f.oox.checked;
  ooo=f.ooo.checked;
  oo3=f.oo3.checked;
  ooc=f.ooc.checked;
  if(dr&&!depth)  _drawboard();
}
function _wx(e,x) {
  if(x=='e') x=e;else if(x=='f') x=e=='w'?'b':'w';
  return x;
}
function whitechg(src,value) {
 if(!src) white=value;
 else if(src==1) white=f.white2.value;
 else if(src==2) white=f.w0.value+f.w1.value+f.w2.value+f.w3.value;
 var e='bwbw';
 if(src!=1) f.white2.value=white;
 if(src!=2) {
   f.w0.value=_wx('b',white[0]);
   f.w1.value=_wx('w',white[1]);
   f.w2.value=_wx('b',white[2]);
   f.w3.value=_wx('w',white[3]);
 }
}
function el(id) { return document.getElementById(id);}
function cl(e,cls,on,cls2) { var cl=e.classList;if(on) cl.add(cls),cls2&&cl.remove(cls2);else cl.remove(cls),cls2&&cl.add(cls2);} 
function hexachg(e) {
  var i,m;
  for(m=0;m<10&&!hxa[m].checked;m++);
  for(i=0;i<10;i++) cl(el('hexa'+i),'sel1',i==m,'sel0');
  quad=m==0,hexa=m==1;tria=m==2,tria2=m==3,tria4=m==4,penta=m==5,cubes=m==6,delta=m==7,trap=m==8,deca=m==9;
  grdchg(0,0,0,1);
  if(e&&!depth) _resizea(),_drawboard();
}
function _sethex(i) { hxa[i].checked=true; hexachg(1);}
function deschg(e) {
  for(var i=0;i<dxa.length;i++)
    if(dxa[i].checked) design=+dxa[i].value;
}
function _setdes(i) { dxa[i].checked=true;deschg(); }
function _setclr(i) { mxa[i].checked=true; monochg(1); }


function _cmd(a) {
  if(a) a.forEach(function(x) {
    x=x.trim();
    if(/^@|^$/.test(x)) return;
    else if(/quad|hexa|tria|penta|cubes|delta|trap|deca/.test(x)) hexa=hxa[x=='hexa'?1:x=='tria'?2:x=='tria2'?3:x=='tria4'?4:x=='penta'?5:x=='cubes'?6:x=='delta'?7:x=='trap'?8:x=='deca'?9:0].checked=1,hexachg();
    else if(/sol|shift|onoff/.test(x)) {
      var oo;
      if(x=='onoff') onoff=1,oox=oo3=ooc=ooo=0;
      if(x=='onoffx') onoff=1,oox=1;
      if(x=='onoffo') onoff=1,ooo=1;
      if(x=='onoff3') onoff=1,oo3=1;
      if(x=='onoffc') onoff=1,ooc=1;
      f.onoff.value=oo=x=='sol'?0:x=='shift'?2:1
      if(oo-1) onoff=0,shifter=oo==2;
    } else if(/white_/.test(x)) whitechg(0,x.substr(6));
    else if(/(no)?diag/.test(x)) f.diag.checked=(diag=x=='diag');
    else if(/col\d+/.test(x))
      x=+x.substr(3),depth++,mxa[x==2?1:x==23?2:x==3?3:x==4?4:0].checked=1,monochg();
  });
}

function _getblock1(c) {
  c=c.toLowerCase();
  if(c=='.'||c=='+'||c=='*') c='x';
  else if(c=='q') c='w';
  var cc=c.charCodeAt(0),e=0;
  if(cc>=48&&cc<=57) e=cc-48,c='o';
  else if(cc>=97&&cc<=106) e=cc-97,c='w';
  else switch(c) {
   case '.':c='x',e=0;break;
   case ',':c='x',e=1;break;
   case '(':c='x',e=2;break;
   case ')':c='x',e=3;break;
   case '[':c='x',e=4;break;
   case ']':c='x',e=5;break;
   case '{':c='x',e=6;break;
   case '}':c='x',e=7;break;
   case '<':c='x',e=8;break;
   case '>':c='x',e=9;break;
  }
  return [c,e];
}

//function _xob(x) { return _xo()||x>='0'&&x<='9'||x>='A'&&x<='J'||'.,()[]()<>'.indexOf(x)>=0;}
function _xob(x) { return x>' ';}

function _setblock1(c,e) {
  if(!e) return c;
  if(c=='w') return 'ABCDEFGHIJ'[e];
  if(c=='x') return '.,()[]{}<>'[e];
  return '0123456789'[e];
}

function _setblock(x,y,e) {
  if(!block) block={};
  var b=block[y];
  if(!b) block[y]=b={};
  if(b[x]|=e);
}

function _rstblock(x,y,e) {
  var a2,a,b;
  if(block&&(b=block[y])&&x in b) {
    a2=b[x];
    a=a2&~e;
    if(a!=a2) {
      if(a) b[x]=a;else delete b[x];
    }
  }
}

function _getblock(x,y) {
  var b;
  if(!block||!(b=block[y])) return 0;
  return 0|b[x];
}

function _getuco(x,y,c) {
  var cy=uco&&uco[y];
  return (cy&&cy[x])||c;
}

function _setuco(x,y,c) {
  if(!uco) uco={};
  var cy=uco[y];
  if(!cy) {
    if(!c) return;
    cy=uco[y]={};
  }
  if(!c) delete cy[x];
  else cy[x]=c;
}

var ucol=[],ucoi=0;
function ucochg(th,e) {
  var c=f.uco.value,p=ucol.indexOf(c);
  if(p<0) ucoi=ucol.length,ucol.push(c);
  else ucoi=p;
} 
function ucoclick(th,e) { 
  var sh=event.shiftKey,ct=event.ctrlKey;
  if(sh||ct) {
    if(sh&&ct) ucol=[];
    else {
      var l=ucol.length;
      ucoi=(ucoi+(sh?l-1:1))%l;
      f.uco.value=ucol[ucoi];
      e.preventDefault();
    }
    //e.stopPropagation();
    //return 0;
  }
}

function _getpgc(x,y,c) {
  var cy=pgc&&pgc[y];
  return (cy&&cy[x])||c;
}

function _setpgc(x,y,c) {
  if(!pgc) pgc={};
  var cy=pgc[y];
  if(c=='#000'||c=='#000000') c=0;
  if(!cy) {
    if(!c) return;
    cy=pgc[y]={};
  }
  if(!c) delete cy[x];
  else cy[x]=c;
}

function _dub1(x,y,i) {
  if(quad) {
    if(i==0) return [x-1,y,2];
    if(i==1) return [x,y-1,3];
    if(i==2) return [x+1,y,0];
    if(i==3) return [x,y+1,1];
  } else if(hexa) {
    var b=_border16(x,y),x2,y2;
    if(i==0) return [x+b[0],y+b[1],3];
    if(i==1) return [x+b[2],y+b[3],4];
    if(i==2) return [x+b[4],y+b[5],5];
    if(i==3) return [x+b[6],y+b[7],0];
    if(i==4) return [x+b[8],y+b[9],1];
    if(i==5) return [x+b[10],y+b[11],2];
  } else if(tria) {
    var d=(1^y^x)&1,dy=d?-1:1;
    if(i==0) return d?[x,y-dy,0]:[x,y-dy,0];
    if(i==1) return d?[x-1,y,1]:[x+1,y,1];
    if(i==2) return d?[x+1,y,2]:[x-1,y,2];
  } else if(tria2) {
     var xx=(x+1+2*(y&1))&3,r;
     if(xx==0) r=i==0?[-1,0,1]:i==1?[0,-1,0]:[1,0,2];
     if(xx==1) r=i==0?[1,0,1]:i==1?[0,1,0]:[-1,0,2];
     if(xx==2) r=i==0?[0,1,1]:i==1?[-1,0,0]:[1,0,2];
     if(xx==3) r=i==0?[0,-1,1]:i==1?[1,0,0]:[-1,0,2];
     r[0]+=x,r[1]+=y;
     return r;
  } else if(tria4) {
     var xx=(((y+1)&1)<<1)|((x+1)&1);
     if(xx==0) r=i==0?[1,0,1]:i==1?[0,1,0]:[-1,1,2];
     if(xx==1) r=i==0?[0,1,1]:i==1?[-1,0,0]:[-1,-1,2];
     if(xx==2) r=i==0?[0,-1,1]:i==1?[1,0,0]:[1,1,2];
     if(xx==3) r=i==0?[-1,0,1]:i==1?[0,-1,0]:[1,-1,2];
     //console.log('i',i,'xx',xx);
     r[0]+=x,r[1]+=y;
     return r;
  } else if(trap) {
     var i2=i,d=(x+1)%2,cx=(x+1)>>1,dd=(cx+2*(y&1))%3+3*d,dx=y&1?0:-2,b=_border11(x,y);
     if(dd==0) i2=i==0?1:i==1?0:i==2?0:3;
     if(dd==1) i2=i==0?2:i==1?2:i==2?1:3;
     if(dd==2) i2=i==0?1:i==1?0:i==2?0:3;
     if(dd==3) i2=i==0?2:i==1?2:i==2?1:3;
     if(dd==4) i2=i==0?1:i==1?0:i==2?0:3;
     if(dd==5) i2=i==0?2:i==1?2:i==2?1:3;
     r=[b[2*i],b[2*i+1],i2];
     r[0]+=x,r[1]+=y;
     return r;
  } else if(deca) {
    var i2=i==1?2:i==2?1:i==3?4:i==4?3:i==5?0:5,b=_border7(x,y);
    console.log(i,i2);
    r=[b[2*i],b[2*i+1],i2];
    r[0]+=x,r[1]+=y;
    return r;
  } else if(cubes) {
    var i2=i==1?2:i==2?1:i==3?0:3,b=_border8(x,y);
    r=[b[2*i],b[2*i+1],i2];
    r[0]+=x,r[1]+=y;
    return r;
  } else if(delta) {
    var i2=i==0?1:i==1?0:i==2?3:2,r=(x+2)%3,cx=(x+2-r)/3,d=1^(y&1)^(cx&1),dy=d?-1:1,b=_border9(x,y);
    r=[b[2*i],b[2*i+1],i2];
    r[0]+=x,r[1]+=y;
    return r;
  } else if(penta) {
    var i2=i2=i==0?1:i==1?0:i==2?3:i==3?2:4,b=_border15(x,y);
    r=[b[2*i],b[2*i+1],i2];
    r[0]+=x,r[1]+=y;
    return r;
  }
}
function _dublock(x,y,e) {
  var r=[],x;
  if(quad) {
    if((e&1)&&_xo(board[y][x-1])) r.push(_dub1(x,y,0));
    if((e&2)&&_xo(board[y-1][x])) r.push(_dub1(x,y,1));
    if((e&4)&&_xo(board[y][x+1])) r.push(_dub1(x,y,2));
    if((e&8)&&_xo(board[y+1][x])) r.push(_dub1(x,y,3));
  } else if(hexa||deca) {
    var b=deca?_border7(x,y):_border16(x,y),x2,y2,i,i2;
    for(i=0,i2=10;i<6;i++,i2=(i2+2)%12)
      if((e&(1<<i))&&_xo(board[y2=y+b[i2+1]][x2=x+b[i2]])) r.push(_dub1(x,y,i));
  } else if(tria||tria2||tria4) {
    var b=(tria2?_border2:tria4?_border5:_border3)(x,y),x2,y2,i,i2;
    for(i=0,i2=0;i<3;i++,i2=(i2+2)%6)
      if((e&(1<<i))&&_xo(board[y2=y+b[i2+1]][x2=x+b[i2]])) r.push(_dub1(x,y,i));
  } else if(tria4) {
    var b=(tria2?_border2:tria4?_border5:_border3)(x,y),x2,y2,i,i2;
    for(i=0,i2=2;i<3;i++,i2=(i2+2)%6)
      if((e&(1<<i))&&_xo(board[y2=y+b[i2+1]][x2=x+b[i2]])) r.push(_dub1(x,y,i));
  } else if(trap||cubes||delta) {
    var b=trap?_border11(x,y):cubes?_border8(x,y):_border9(x,y),x2,y2,i,i2;
    for(i=0,i2=0;i<4;i++,i2=(i2+2)%8)
      if((e&(1<<i))&&_xo(board[y2=y+b[i2+1]][x2=x+b[i2]])) r.push(_dub1(x,y,i));
  } else if(penta) {
    var b=_border15(x,y),x2,y2,i,i2;
    for(i=0,i2=0;i<5;i++,i2=(i2+2)%10)
      if((e&(1<<i))&&_xo(board[y2=y+b[i2+1]][x2=x+b[i2]])) r.push(_dub1(x,y,i));
  }
  for(i=0;x=r[i];i++) _setblock(x[0],x[1],1<<x[2]);
}

function _blocked(x,y,x2,y2) {
  var e=_getblock(x,y);
  if(!e) return 0;
  if(quad) {
    var dx=x2-x,dy=y2-y;
    return 0!=(e&(dx>0?4:dx<0?1:dy>0?8:2));
  } else if(hexa) {
    var ax=2*x+(y&1),ax2=2*x2+(y2&1),dx=ax2-ax,dy=y2-y,i=dy?dy>0?dx<0?5:4:dx<0?1:2:dx<0?0:3;
    return 0!=(e&(1<<i));
  } else if(tria) {
    var d=1^(y&1)^(x&1),dx=x2-x,dy=y2-y,dy2=d?-1:1,i;
    if(dy) i=0;
    else i=d^(dx<0)?2:1;
    return 0!=(e&(1<<i));
  } else if(tria2) {
     var xx=(x+1+2*(y&1))&3,r;
     if(xx==0) i=y2<y?1:x2<x?0:2;
     if(xx==1) i=y2>y?1:x2>x?0:2;
     if(xx==2) i=y2>y?0:x2<x?1:2;
     if(xx==3) i=y2<y?0:x2>x?1:2;
     return 0!=(e&(1<<i));
  } else if(tria4) {
    var xx=(((1^y)&1)<<1)|(1^x&1),r;
    if(xx==0) i=x2<x?2:y2>y?1:0;
    if(xx==1) i=y2<y?2:x2<x?1:0;
    if(xx==2) i=y2>y?2:x2>x?1:0;
    if(xx==3) i=x2>x?2:y2<y?1:0;
    return 0!=(e&(1<<i));
  } else if(trap) {
    var xy=_peg(x2,y2),i=_idx(xy[0],xy[1],_points11(x,y));
    return 0!=(e&(1<<i));
  } else if(deca) {
    var xy=_peg(x2,y2),i=_idx(xy[0],xy[1],_points7(x,y));
    return 0!=(e&(1<<i));
  } else if(cubes) {
    var xy=_peg(x2,y2),i=_idx(xy[0],xy[1],_points8(x,y));
    return 0!=(e&(1<<i));
  } else if(delta) {
    var xy=_peg(x2,y2),i=_idx(xy[0],xy[1],_points9(x,y));
    return 0!=(e&(1<<i));
  } else if(penta) {
    var xy=_peg(x2,y2),i=_idx(xy[0],xy[1],_points15(x,y));
    return 0!=(e&(1<<i));
  }
}

function _txt2block(x,y,e,r) {
  if(!e) return e;
  var i;
  /* if(trap) {
    var d=(x+1)%2,cx=(x+1)>>1,dd=(cx+2*(y&1))%3+3*d;
    i=dd==0?2:dd==1?1:dd==2?0:dd==3?0:dd==4?3:3;
    e=rol(4,e,i,r);
  } */
  if(trap||cubes||delta) {e=rol(4,e,1,r);}
  if(tria) {
    //var d=(x^y)&1; e=rol(3,e,d?2:1,r);
  }
  if(tria2) {
    //var xx=(x+1+2*(y&1))&3;e=rol(3,e,xx==2?1:xx==1?2:0,r);
  }
  if(tria4) {
    //var d=(((y+1)&1)<<1)|((x+1)&1);e=rol(3,e,d==3?1:d==2?0:d==1?1:2,r);
  }
  if(penta) { e=rol(5,e,3,r); }
  if(r) {
    if(quad||delta) e&=3;
    //else if(tria||tria2||tria4) e&=3;
    else e&=7;
  }
  return e;
}

function _dublocka() {
  var b;
  if(block) for(y in block)
    for(x in b=block[y])
      _dublock(+x,+y,b[x]);
}

function _blockmove(dx,dy) { _blockmovef(function(x,y) { return [x+dx,y+dy];});}
function _blockmovef(fxy) {
  if(block) {
    var b2,y2,xy,nx,ny;
    for(y in block) 
      for(x in b=block[y]) {
        xy=fxy(+x,+y),nx=xy[0],ny=xy[1];
        if(!b2) b2={};
        y2=b2[ny];
        if(!y2) b2[ny]=y2={};
        y2[nx]|=b[x];
      }
    block=b2;
  }
}

function _block2board() {
  var b;
  if(block) for(y in block)
    for(x in b=block[y])
      if(b[x]) board[y][x]=board[y][x][0]+''+b[x];
}

function _board2block(fx) {
  var b=0,ce,e;
  block=0;
  for(y in board) {
    b=board[y];
    for(x in b) {
      ce=b[x];
      if(ce[1]) {
        b[x]=ce[0];
        ce=+ce.substr(1);
        if(fx) ce=fx(ce);
        _setblock(x,y,ce);
      }
    }
  }
}

function parse(txt) {
  var cmd=txt.match(/^\s*\/\/(.*)/);
  if(cmd) {
    cmd=cmd[1].split(',');
    _cmd(cmd);
  }
  txt=txt.replace(/\/\/.*(\n|$)/g,'');
  txt=txt.replace(/([ \t]+)($|\r?\n)/g,'$2');
  var c,x,y,b,l,ln=txt.split(/\r?\n/g),m=0,e,ce;
  for(y=0;y<ln.length;y++) {
    if((l=ln[y].length)>m) m=l;
  }
  _alloc(m+2,ln.length+2);
  block=0;
  for(y=0;y<ln.length;y++) {
    l=ln[y],b=board[1+y];
    for(x=0;x<m;x++) {
      c=x<l.length?l[x]:' ';
      ce=_getblock1(c),c=ce[0],e=ce[1];
      b[1+x]=c=='X'||c=='x'||c=='.'||c=='+'?'x'
         :c=='O'||c=='o'||c=='0'?'o':c=='W'||c=='w'||c=='A'?'w':' ';
      if(e) e=_txt2block(1+x,1+y,e,0),_setblock(1+x,1+y,e);
    }
  }
  _dublocka();
}

function draw(auto) {
  if(auto||confirm('draw')) {
    parse(f.ta.value);
    undo=[],redo=moves=0;
    _moves(0);
    _resizea();
    _drawboard()
  }
}

function game2txt() { f.ta.value=_game2txt(); }
function _white() {
  for(y in board) { var by=board[y];for(x in board[y]) if(by[x]=='w') return 1;}
  return 0;
}
function _game2txt() {
  var s=[],c,e,l,r,x,y,xi=-1,yi,ya=0,n,wh=f.white2.value!='xxff'||_white();
  n=f.ta.value.match(/@[^,\r\n]+/);
  n='//'+(n?n[0]+',':'')+(deca?'deca':trap?'trap':delta?'delta':cubes?'cubes':penta?'penta':tria4?'tria4':tria2?'tria2':tria?'tria':hexa?'hexa':'quad')+(faller?',fall':shifter?',shift':onoff?',onoff'+(ooc?',onoffc':oo3?',onoff3':'')+(oox?',onoffx':'')+(ooo?',onoffo':''):',sol')+(wh?',white_'+white:'')+(diag?',diag':'');
  for(y=0;y<board.length;y++) {
    l='',r=board[y];
    for(x=0;x<r.length;x++) {
      c=r[x];
      e=_getblock(x,y);
      if(e) {
        e=_txt2block(x,y,e,1);
        c=e?_setblock1(c,e):c=='x'?'.':c=='o'?'O':c=='w'?'W':c;
      } else
        c=c=='x'?'.':c=='o'?'O':c=='w'?'W':c;
      l+=c;
      if(_xo(r[x])) {
        if(xi<0) xi=x,ya=yi=y;
        else {
          if(x<xi) xi=x;
          ya=y;
        }
      }
    }
    s.push(l);
  }
  var sy=hexa||tria||tria4||penta?2:tria2?4:1,sx=penta?4:hexa?1:sy;
  if(yi>0) { yi=1+(((yi-1)/sy)|0)*sy;s=s.slice(yi);ya-=yi;}
  s=s.slice(0,ya+1);
  if(xi>0) { xi=1+(((xi-1)/sx)|0)*sx;for(y=0;y<s.length;y++) s[y]=s[y].substr(xi); }
  s=s.join('\n');
  return n+'\n'+s.replace(/ +(\n|$)/g,'$1');
}

function _clear() {
  ctx.fillStyle=grd;
  ctx.fillRect(0,0,cv1.width,cv1.height);
}

function _alloc(w,h) {
  var x,y,r;
  board=[];
  for(y=0;y<h+2;y++) {
    board[y]=r=[];
    for(x=0;x<w+2;x++)
      r[x]=' ';
  }
}

function _radialxy(dx,dy,xy,r) {
  var i,j,k,m=1/0,n=-1/0,x,sx,sy;
  if(grdm==3) {
    for(i=sx=sy=0;i<xy.length;i+=2) sx+=xy[i],sy+=xy[i+1];
    i>>=1,sx/=i,sy/=i;
    i=deca?4:trap?4:tria2||tria4?2:0;
    x=_sqr(sx-xy[i],sy-xy[i+1]);
  } else {
    for(i=0;i<xy.length;i+=2) {
      x=dx*xy[i]+dy*xy[i+1];
      if(x<m) {j=i,m=x;if(!i) k=i,n=x;}
      else if(x>n) k=i,n=x;
    }
    sx=xy[j],sy=xy[j+1],x=_sqr(sx-xy[k],sy-xy[k+1]);
  }
  x=Math.sqrt(x);
  return r?[sx,sy,x]:ctx.createRadialGradient(sx,sy,0,sx,sy,x);
}
function _linear(dx,dy,xy,r) {
  var i,j,k,m=1/0,n=-1/0,x,sx,sy,tx,ty;
  for(i=0;i<xy.length;i+=2) {
    x=dx*xy[i]+dy*xy[i+1];
    if(x<m) {j=i,m=x;if(!i) k=i,n=x;}
    else if(x>n) k=i,n=x;
  }
  sx=xy[j],sy=xy[j+1];
  x=(n-m)/_sqr(dx,dy);
  return r?[sx,sy,sx+x*dx,sy+x*dy]:ctx.createLinearGradient(sx,sy,sx+x*dx,sy+x*dy);
}
function _brd(x,y) { var b=board[y];return b?(b=b[x],b&&b!=' '):0;}
function _brdborder(x,y,b) {
  var i,i1,r=[];
  if(!b) b=_border(x,y);
  for(i1=i=0;i<b.length;i1++,i+=2) r[i1]=_brd(x+b[i],y+b[i+1]);
  return r;
}
function _poly(xy) {
  ctx.beginPath();
  ctx.moveTo(xy[0],xy[1]);
  for(i=2;i<xy.length;i+=2) ctx.lineTo(xy[i],xy[i+1]);
  ctx.closePath();
}

function _polyc(xy) {
  var sx=0,sy=0,i;
  for(i=sx=sy=0;i<xy.length;i+=2) sx+=xy[i],sy+=xy[i+1];
  i>>=1,sx/=i,sy/=i;
  return [sx,sy];
}

function _gpoly(xy,c0,c1,s,sx,sy,m) {
  var i,g,x=xy[xy.length-2],y=xy[xy.length-1],x2,y2,x1,y1;
  if(!(sx||sy)) i=_polyc(xy),sx=i[0],sy=i[1];
  _poly(xy);
  ctx.fillStyle=c0;
  ctx.fill();
  for(i=0;i<xy.length;i+=2) {
    x2=x,y2=y,x=xy[i],y=xy[i+1],x1=xy[(i+2)%xy.length],y1=xy[(i+3)%xy.length];
    if(m) {
      _poly([x,y,x2,y2,sx,sy]);
      //ctx.fillStyle=g=ctx.createLinearGradient((x+x2)/2,(y+y2)/2,sx,sy);
      x2=(x+x2)/2,y2=(y+y2)/2,ctx.fillStyle=g=ctx.createRadialGradient(x2,y2,0,x2,y2,Math.sqrt(_sqr(x2-sx,y2-sy)));
    } else {
      _poly([(x+x2)/2,(y+y2)/2,x,y,(x+x1)/2,(y+y1)/2,sx,sy]);
      //ctx.fillStyle=g=ctx.createLinearGradient(x,y,sx,sy);
      ctx.fillStyle=g=ctx.createRadialGradient(x,y,0,x,y,Math.sqrt(_sqr(x-sx,y-sy)));
    }
    g.addColorStop(0,c1);
    g.addColorStop(1,c0);
    ctx.fill();
  }
  if(s) {
    ctx.lineWidth=s;
    _poly(xy);
    ctx.stroke();
  }
}
function _round(xy,b,r) {
  var i1,i,lx,ly,nx,ny,l=xy.length;
  nx=(xy[0]+xy[l-2])/2,ny=(xy[1]+xy[l-1])/2;
  ctx.beginPath();ctx.moveTo(nx,ny);
  for(i1=i=0;i<l;i1++,i+=2) lx=nx,ly=ny,_bez2(b[i1]||b[i1+1],lx,ly,xy[i],xy[i+1],nx=(xy[i]+xy[(i+2)%l])/2,ny=(xy[i+1]+xy[(i+3)%l])/2,r,!i);
  ctx.closePath();
}
function _ground(xy,c0,c1,s,sx,sy,m,b,r) {
  var i,i1,lx,ly,nx,ny,l=xy.length,g,x,y;
  if(!(sx||sy)) i=_polyc(xy),sx=i[0],sy=i[1];
  b.push(b[0],b[1]);
  _round(xy,b,r);
  ctx.fillStyle=c0;
  ctx.fill();
  
  nx=(xy[0]+xy[l-2])/2,ny=(xy[1]+xy[l-1])/2;
  for(i1=i=0;i<l;i1++,i+=2) {
    ctx.beginPath();
    if(m) {
      var mx=xy[(i+2)%l],my=xy[(i+3)%l],px=xy[(i+4)%l],py=xy[(i+5)%l];
      lx=nx,ly=ny,nx=(xy[i]+mx)/2,ny=(xy[i+1]+my)/2;
      _bez3(1,b[i1]||b[i1+1],lx,ly,xy[i],xy[i+1],nx,ny,r,1);
      _bez3(0,b[i1+1]||b[i1+2],nx,ny,mx,my,(mx+px)/2,(my+py)/2,r);
      x=nx,y=ny;
    } else {
      ctx.moveTo(nx,ny);
      lx=nx,ly=ny,_bez2(b[i1]||b[i1+1],lx,ly,xy[i],xy[i+1],nx=(xy[i]+xy[(i+2)%l])/2,ny=(xy[i+1]+xy[(i+3)%l])/2,r,1);
      x=xy[i],y=xy[i+1];
    }
    ctx.lineTo(sx,sy);
    ctx.closePath();
    
    ctx.fillStyle=g=ctx.createRadialGradient(x,y,0,x,y,Math.sqrt(_sqr(x-sx,y-sy)));
    g.addColorStop(0,c1);
    g.addColorStop(1,c0);
    //ctx.fillStyle=i==2?'red':i==4?'green':i==6?'blue':c1;
    ctx.fill();
  }
  if(s) {
    _round(xy,b,r);
    ctx.lineWidth=s;
    ctx.stroke();
  }
}

function _drawcell(x,y) {
  var sx=brd+x*cell,sy=brd+y*cell;
  var c=_getuco(x,y,mono==2?clr2[(x+y)&1]:mono==22?clr2[x&1]:mono==21?clr2[y&1]:mono==4?clr4[(x&1)+2*(y&1)]:mono==30?clr3[(x+9999-y)%3]:mono==31?clr3[(x+y)%3]:'#fff');
  if(grdm) {
    var g;
    //if(grdm=2) g=ctx.createRadialGradient(sx,sy,0,sx+cell/2,sy+cell/2,cell);
    //else g=ctx.createLinearGradient(sx,sy,sx+cell,sy+cell);
    var xy=[sx,sy,sx+cell,sy,sx+cell,sy+cell,sx,sy+cell];
    if(c=='#fff') c=clr2[1];
    if(grdm>=5) {
      if(rou) {
        var b=[_brd(x-1,y),_brd(x,y-1),_brd(x+1,y),_brd(x,y+1)];
        _ground(xy,'#fff',c,0.5,0,0,grdm>5,b,Math.sqrt(2)/3); 
      } else _gpoly(xy,'#fff',c,0.5,0,0,grdm>5);
      return;
    } else if(grdm>1) g=_radialxy(grdx,grdy,xy,0,x,y);
    else g=_linear(grdx,grdy,xy);
    g.addColorStop(0,'#fff');
    g.addColorStop(1,c);
    ctx.fillStyle=g;
  } else
    ctx.fillStyle=c;
  if(rou) {
    var c2=cell/2,cx=sx+c2,cy=sy+c2,b=[_brd(x-1,y),_brd(x,y-1),_brd(x+1,y),_brd(x,y+1)];
    ctx.beginPath();
    ctx.arc(sx+c2,sy+c2,c2+1,0,2*Math.PI);
    ctx.closePath();
    ctx.fill();
    if(b[0]||b[1]) ctx.fillRect(sx,sy,c2,c2);
    if(b[1]||b[2]) ctx.fillRect(sx+c2,sy,c2,c2);
    if(b[2]||b[3]) ctx.fillRect(sx+c2,sy+c2,c2,c2);
    if(b[3]||b[0]) ctx.fillRect(sx,sy+c2,c2,c2);
    ctx.lineWidth=0.5;
    if(b[0]) _rline(sx,sy,0,cell);
    if(b[1]) _rline(sx,sy,cell,0);
  } else {
    ctx.fillRect(sx,sy,cell,cell);
    ctx.lineWidth=0.5;
    ctx.rect(sx,sy,cell,cell);
    ctx.stroke();
  }
}

function _drawsele(x,y) {
  var i,xy=_points(x,y);
  ctx.beginPath();
  ctx.moveTo(xy[0],xy[1]);
  for(i=2;i<xy.length;i+=2) ctx.lineTo(xy[i],xy[i+1]);
  ctx.closePath();
  ctx.lineWidth=3;
  ctx.strokeStyle='#000'
  ctx.stroke();
  ctx.lineWidth=1;
  ctx.strokeStyle='#fff'
  ctx.stroke();
}

function _points(x,y) {
  return deca?_points7(x,y):trap?_points11(x,y):delta?_points9(x,y):cubes?_points8(x,y):penta?_points15(x,y):tria4?_points5(x,y):tria2?_points2(x,y):tria?_points3(x,y):hexa?_points16(x,y):_points14(x,y);
}

function _border(x,y) {
  return deca?_border7(x,y):trap?_border11(x,y):delta?_border9(x,y):cubes?_border8(x,y):penta?_border15(x,y):tria4?_border5(x,y):tria2?_border2(x,y):tria?_border3(x,y):hexa?_border16(x,y):_border4(x,y);
}

function _color(x,y) {
  var c=_getuco(x,y);
  if(c) return c;
  if(trap) c=mono==2?clr2[(x+y)&1]:mono==22?clr2[1&((x+1)>>1)]:mono==21?clr2[x&1]:mono==4?clr4[2*(y&1)+(x&1)]:mono==30?clr2[y&1]:mono==31?clr3[(x+2*(y&1))%3]:'#fff';
  else if(delta) {
     var d=(x+2)%3,cx=(x+2-d)/3;
     c=mono==2?clr2[(x+y)&1]:mono==22?clr2[1&((x+1)>>1)]:mono==21?clr2[x&1]:mono==4?clr4[2*(y&1)+(x&1)]:mono==30?clr2[y&1]:mono==31?clr3[d]:'#fff';
  } else if(cubes||deca) {
    var d=(x+2)%3,cx=(x+2-d)/3;
    c=mono==2?clr2[(x+y)&1]:mono==22?clr2[1&((x+1)>>1)]:mono==21?clr2[x&1]:mono==4?clr4[2*(y&1)+(x&1)]:mono==30?clr2[y&1]:mono==31?clr3[d]:'#fff';
  } else if(penta) {
    var cx=(x+1)/2|0,x1=x&1,v=(cx+y)&1;
    c=mono==2?clr2[(x+y)&1]:mono==22?clr2[1&((x+1)>>1)]:mono==21?clr2[x&1]:mono==4?clr4[2*v+x1]:mono==30?clr2[y&1]:mono==31?clr3[(x+2*(y&1))%3]:'#fff';
  } else if(tria4) {
    var x2=(x-1)>>1,y2=(y-1)>>1,r=(1^x&1)|((1^y&1)<<1),tx=r==0||r==3;
    var dx=2*(x2-y2)+(r==1||r==3),dy=2*(x2+y2)-(r==2||r==3);
    c=mono==2?clr2[(x2^y2^tx)&1]:mono==22?clr2[1&((x+1)>>1)]:mono==21?clr2[1^y&1]:mono==4?clr4['0312'[r]]:mono==30?clr2[+!tx]:mono==31?clr3[(3+dx%3+((dy>>1)&1))%3]:'#fff';
  }
  else if(tria2) c=mono==2?clr2[(x+y)&1]:mono==22?clr2[1&((x+1)>>1)]:mono==21?clr2[x&1]:mono==4?clr4[(x&1)+2*(y&1)]:mono==30?clr2[y&1]:mono==31?clr3[(x+2*(y&1))%3]:'#fff';
  else if(tria) c=mono==2?clr2[(x+y)&1]:mono==22?clr2[((x+y)/2)&1]:mono==21?clr2[x&1]:mono==4?clr4[(x&1)+2*(y&1)]:mono==30?clr2[y&1]:mono==31?clr3[(x+2*(y&1))%3]:'#fff';
  else if(hexa) c=mono==2?clr2[(x+y)&1]:mono==22?clr2[(x+2-(y&1)-(y/2)&1)&1]:mono==21?clr2[(x+(y&1)+y/2)&1]:mono==4?clr4[(x&1)+2*(y&1)]:mono==30?clr2[y&1]:mono==31?clr3[(x+2*(y&1))%3]:'#fff';
  else c=mono==2?clr2[(x+y)&1]:mono==22?clr2[x&1]:mono==21?clr2[y&1]:mono==4?clr4[(x&1)+2*(y&1)]:mono==30?clr3[(x+9999-y)%3]:mono==31?clr3[(x+y)%3]:'#fff';
  return c;
}

function _points2(x,y) {
  var sx=brd+((x+1)>>1)*cell2,sx2=sx+cell2,sy=brd+y*cell2,sy2=sy+cell2,r,xx=(x+1+2*(y&1))&3;
  if(xx==0) return [sx,sy,sx2,sy,sx,sy2];
  if(xx==1) return [sx2,sy2,sx,sy2,sx2,sy];
  if(xx==2) return [sx,sy2,sx,sy,sx2,sy2];
  if(xx==3) return [sx2,sy,sx2,sy2,sx,sy];
  //if(!((x^y^((x+1)>>1))&1)) r=sy,sy=sy2,sy2=r;
  //if(!(x&1)) r=sx,sx=sx2,sx2=r;
  //return [sx,sy,sx2,sy,sx,sy2];
}

function _points5(x,y) {
  var sx=brd+((x+1)>>1)*cell5,sx2=sx+cell5,sy=brd+((y+1)>>1)*cell5,sy2=sy+cell5,cx=sx+cell5/2,cy=sy+cell5/2,r=(((y+1)&1)<<1)|((x+1)&1);
  if(r==3) return [cx,cy,sx2,sy,sx2,sy2];
  if(r==2) return [cx,cy,sx2,sy2,sx,sy2];
  if(r==1) return [cx,cy,sx,sy,sx2,sy];
  return [cx,cy,sx,sy2,sx,sy];
}

function _points14(x,y) {
  var sx=brd+x*cell,sy=brd+y*cell;
  return [sx,sy,sx+cell,sy,sx+cell,sy+cell,sx,sy+cell];
}

function _border4(x,y) {
  return [-1,0,0,-1,1,0,0,1];
}

function _points16(x,y) {
  var sx=brd+(x+(y&1)/2)*cell6y,sy=brd+((1+y*3)/4)*cell6x,x2=sx+cell6y/2,x3=sx+cell6y;
  return [sx,sy,x2,sy-cell6x/4,x3,sy,x3,sy+cell6x/2,x2,sy+cell6x*3/4,sx,sy+cell6x/2];
}

function _border15(x,y) {
  var b,cx=(x+1)/2|0,x1=x&1,v=(cx+y)&1;
  if(v) {
    if(x1) b=[0,1,-1,0,-2,0,1,-1,1,0,];
    else b=[0,-1,1,0,2,0,-1,1,-1,0];
  } else {
    if(x1) b=[-1,0,0,-1,1,-1,2,0,1,0];
    else b=[1,0,0,1,-1,1,-2,0,-1,0];
  }
  return b;
}

function _points15(x,y) {
  var cx=(x+1)/2|0,x1=x&1,sx=brd+cx*cell7,sy=brd+y*cell7,v=(cx+y)&1,c2=cell7/2,c4=c2/2;
  if(v) {
    if(x1) 
      return [sx,sy+cell7,sx-c4,sy+c2,sx,sy,sx+c2,sy+c4,sx+c2,sy+cell7-c4];
    else {
      sx+=cell7;
      return [sx,sy,sx+c4,sy+c2,sx,sy+cell7,sx-c2,sy+cell7-c4,sx-c2,sy+c4];
    }
  } else {
    if(x1) 
      return [sx,sy,sx+c2,sy-c4,sx+cell7,sy,sx+cell7-c4,sy+c2,sx+c4,sy+c2];
    else {
      sy+=cell7;
      return [sx+cell7,sy,sx+c2,sy+c4,sx,sy,sx+c4,sy-c2,sx+cell7-c4,sy-c2];
    }
  }
}

function _border8(x,y) {
  var d=(x+2)%3,dx=y&1?0:-3;
  if(d==1) return [1,0,dx-1,1,-2,0,-1,0];
  if(d==2) return [-2,0,2,0,dx+1,1,-1,0];
  return [1,0,dx+2,-1,dx+4,-1,2,0];
}

function _border7(x,y) {
  var d=(x+2)%3,dx=y&1?0:-3;
  if(d==1) return [2,0,4,0,dx+2,1,1,0,-1,0,dx+4,-1];
  if(d==2) return [dx-1,1,dx-2,1,-4,0,-2,0,-1,0,dx+1,1];
  return [dx+2,-1,dx+1,-1,dx+5,-1,1,0,2,0,-2,0];
}

function _border18(x,y) {
  var d=(x+2)%3,dx=y&1?0:-3;
  if(d==1) return [1,0,3,0,dx+2,1,dx+3,1  ,dx-1,1,dx,1,dx+1,1,dx+3,1  ,-2,0,-3,0,-4,0,dx,-1  ,-1,0,dx+3,-1,dx+1,-1,dx,-1];
  if(d==2) return [-2,0,dx,-1,dx+2,-1,dx+3,-1 ,2,0,3,0,1,0,dx+3,-1 ,dx+1,1,dx+3,1,dx+2,1,dx,1 ,-1,0,-3,0,dx-2,1,dx,1];
  return [1,0,dx,+1,-1,0,-3,0  ,dx+2,-1,dx,-1,dx+1,-1,-3,0  ,dx+4,-1,dx+3,-1,dx+5,-1,3,0  ,2,0,dx+3,1,4,0,3,0];
}

function _points8(x,y) {
  var d=(x+2)%3,cx=(x+2-d)/3;
  var sx=brd+(cx+(y&1)/2)*cell8x,sy=brd+((1+y*3)/4)*cell8y,x2=cell8x/2,y2=cell8y/4;
  if(d==1) return [sx+x2,sy+4*y2,sx,sy+3*y2,sx,sy+y2,sx+x2,sy+2*y2];
  else if(d==2) return [sx+2*x2,sy+y2,sx+2*x2,sy+3*y2,sx+x2,sy+4*y2,sx+x2,sy+2*y2];
  return [sx,sy+y2,sx+x2,sy,sx+2*x2,sy+y2,sx+x2,sy+2*y2];
}

function _points7(x,y) {
  var d=(x+2)%3,cx=(x+2-d)/3;
  var sx=brd+(cx+(y&1)/2)*cell8x,sy=brd+((1+y*3)/4)*cell8y,x2=cell8x/2,y2=cell8y/4,x3,y3;
  if(d==1) return [sx+2*x2,sy+2*y2,sx+2*x2,sy+3*y2,sx+3*x2/2,sy+7*y2/2,sx+x2,sy+2*y2,sx+3*x2/2,sy+y2/2,sx+2*x2,sy+y2];
  else if(d==2) return [sx+x2/2,sy+7*y2/2,sx,sy+3*y2,sx,sy+2*y2,sx+x2,sy+2*y2,sx+3*x2/2,sy+7*y2/2,sx+x2,sy+4*y2];
  return [sx+x2/2,sy+y2/2,sx+x2,sy,sx+3*x2/2,sy+y2/2,sx+x2,sy+2*y2,sx,sy+2*y2,sx,sy+y2];
}

function _border11(x,y) {
  var d=(x+1)%2,cx=(x+1)>>1,dd=(cx+2*(y&1))%3+3*d,dx=y&1?0:-2;
  if(dd==1) return [dx,1,-1,0,dx+1,-1,1,0];
  if(dd==2) return [-1,0,dx,-1,dx+2,-1,1,0];
  if(dd==3) return [dx,-1,dx+2,-1,1,0,-1,0];
  if(dd==4) return [dx+1,-1,1,0,dx+2,1,-1,0];
  if(dd==5) return [1,0,dx+1,1,dx,1,-1,0];
  return [dx+2,1,dx+1,1,-1,0,1,0];
}

function _points11(x,y) {
  var d=(x+1)%2,cx=(x+1)>>1,dd=(cx+2*(y&1))%3+3*d;
  var sx=brd+(cx+(y&1)/2)*cell8x,sy=brd+((1+y*3)/4)*cell8y,x2=cell8x/2,y2=cell8y/4;
  if(dd==1) return [sx,sy+3*y2 ,sx,sy+y2 ,sx+x2,sy,sx+x2,sy+4*y2];
  else if(dd==2) return [sx,sy+y2,sx+x2,sy,sx+2*x2,sy+y2,sx,sy+3*y2];
  else if(dd==3) return [sx+x2,sy ,sx+2*x2,sy+y2 ,sx+2*x2,sy+3*y2,sx,sy+y2 ];
  else if(dd==4) return [sx+2*x2,sy+y2 ,sx+2*x2,sy+3*y2 ,sx+x2,sy+4*y2,sx+x2,sy ];
  else if(dd==5) return [sx+2*x2,sy+3*y2 ,sx+x2,sy+4*y2 ,sx,sy+3*y2,sx+2*x2,sy+y2];
  return [sx+x2,sy+4*y2 ,sx,sy+3*y2,sx,sy+y2,sx+2*x2,sy+3*y2];
}

function _points11h(x,y) {
  var d=(x+1)%2,cx=(x+1)>>1,dd=(cx+2*(y&1))%3+3*d;
  var sx=brd+(cx+(y&1)/2)*cell8x,sy=brd+((1+y*3)/4)*cell8y,x2=cell8x/2,y2=cell8y/4;
  return [sx,sy+3*y2 ,sx,sy+y2 ,sx+x2,sy,sx+2*x2,sy+y2,sx+2*x2,sy+3*y2,sx+x2,sy+4*y2];
}

function _sqr(x,y) { return x*x+y*y;}
function _min(x,y) { return y<x?y:x;}
function _near(x,y,a,b) {
  return _sqr(x-a[0],y-a[1])<_sqr(x-b[0],y-b[1]);
}
function _near2(x,y,x2,y2,a,b) {
  var da=_min(_sqr(x-a[0],y-a[1]),_sqr(x2-a[0],y-a[1]))
  var db=_min(_sqr(x-b[0],y-b[1]),_sqr(x2-b[0],y2-b[1]))
  return da<db;
}

function _idx(ex,ey,xy,v,md) {
  var i=0,d,f=0,m=1/0,n=xy.length,x=xy[n-2],y=xy[n-1],x2,y2,v2=v>1,v3=v>2;
  ex*=2,ey*=2;
  while(i<n) {
    x2=x,y2=y,x=xy[i++],y=xy[i++];
    if(md>0&&md>_sqr(2*x-ex,2*y-ey)) return -1;
    if(v3) {
       var x3=2*x,y3=2*y;
       if((d=_sqr(x3-ex,y3-ey))<m) f=i|64,m=d;
       x2+=x,y2+=y;
    } else if(v2) {
       var x3=(3*x2+x)/2,y3=(3*y2+y)/2;
       if((d=_sqr(x3-ex,y3-ey))<m) f=i|64,m=d;
       x2=(3*x+x2)/2,y2=(3*y+y2)/2;
    } else if(v) x2=2*x,y2=2*y;
    else x2+=x,y2+=y;
    if((d=_sqr(x2-ex,y2-ey))<m) f=i,m=d;
  }
  //console.log('_idx',[(f>>1)-1,m]);
  i=(((f&63)>>1)-1)|(f&64);
  return i;
}

function _drawcell16(x,y) {
  var xy=_points16(x,y);
  //var sx=brd+(x+(y&1)/2)*cell6y,sy=brd+((1+y*3)/4)*cell6x,x2=sx+cell6y/2,x3=sx+cell6y;
  var c=_getuco(x,y,mono==2?clr2[(x+y)&1]:mono==22?clr2[(x+2-(y&1)-(y/2)&1)&1]:mono==21?clr2[(x+(y&1)+y/2)&1]:mono==4?clr4[(x&1)+2*(y&1)]:mono==30?clr2[y&1]:mono==31?clr3[(x+2*(y&1))%3]:'#fff');
  if(grdm) {
    var g;
    if(c=='#fff') c=clr2[1];
    if(grdm>=5) {
      if(rou) {
        var b=_brdborder(x,y);
        _ground(xy,'#fff',c,0.5,0,0,grdm>5,b,Math.sqrt(3)/3); 
      } else _gpoly(xy,'#fff',c,0.5,0,0,grdm>5);
      return;
    } else if(grdm>1) g=_radialxy(grdx,grdy,xy);
    else g=_linear(grdx,grdy,xy);
    //else g=ctx.createLinearGradient(xy[0],xy[1],xy[6],xy[7]);
    g.addColorStop(0,'#fff');
    g.addColorStop(1,c);
    ctx.fillStyle=g;
  } else
    ctx.fillStyle=c;
  ctx.beginPath();
  if(rou) {
    var i,i1,cx=(xy[0]+xy[6])/2,cy=(xy[1]+xy[7])/2,r=Math.sqrt(_sqr(xy[0]-cx,xy[1]-cy)),b2=_border16(x,y),b=[];
    for(i1=i=0;i<12;i1++,i+=2) b[i1]=_brd(x+b2[i],y+b2[i+1]);
    b.push(b[0]);
    xy.push(xy[0],xy[1]);
    ctx.moveTo((xy[0]+xy[10])/2,(xy[1]+xy[11])/2);
    for(i1=i=0;i<12;i1++,i+=2) _arc2(b[i1]||b[i1+1],xy[i],xy[i+1],(xy[i]+xy[i+2])/2,(xy[i+1]+xy[i+3])/2,r);
    ctx.closePath();
    ctx.fill();
    ctx.beginPath();
    ctx.lineWidth=0.5;
    b.push(b[0]);b.shift();
    for(i1=i=0;i<6;i1++,i+=2) if(b[i1]) _line(xy[i],xy[i+1],xy[i+2],xy[i+3]);
  } else {
    ctx.moveTo(xy[0],xy[1]);
    ctx.lineTo(xy[2],xy[3]);
    ctx.lineTo(xy[4],xy[5]);
    ctx.lineTo(xy[6],xy[7]);
    ctx.lineTo(xy[8],xy[9]);
    ctx.lineTo(xy[10],xy[11]);
    ctx.closePath();
    ctx.fill();
    ctx.lineWidth=0.5;
  }
  ctx.stroke();
}

function _points3(x,y) {
  var d=1^(y&1)^(x&1),dy=d?-1:1,sx=brd+x*cell3x/2,sy=brd+(y+d)*cell3y,y2=sy+dy*cell3y;
  return d?[sx,sy,sx+cell3x/2,y2,sx+cell3x,sy]:[sx+cell3x,sy,sx+cell3x/2,y2,sx,sy];
}

function _border3(x,y) {
  var d=1^(y&1)^(x&1),dy=d?-1:1;
  return d?[0,-dy,-1,0,1,0]:[0,-dy,1,0,-1,0];
}

function _drawcell3(x,y) {
  var xy=_points3(x,y);
  var c=_getuco(x,y,mono==2?clr2[(x+y)&1]:mono==22?clr2[((x+y)/2)&1]:mono==21?clr2[x&1]:mono==4?clr4[(x&1)+2*(y&1)]:mono==30?clr2[y&1]:mono==31?clr3[(x+2*(y&1))%3]:'#fff');
  _drawcell3x(x,y,xy,c,_border3);
}

function _drawcell3x(x,y,xy,c,border) {
  if(grdm) {
    var g;
    if(c=='#fff') c=clr2[1];
    if(grdm>=5) {
      if(rou) {
        var b2=border(x,y),b=_brdborder(x,y);
        _ground(xy,'#fff',c,0.5,0,0,grdm>5,b,tria?Math.sqrt(2)/3:0.125); 
      } else _gpoly(xy,'#fff',c,0.5,0,0,grdm>5);
      return;
    } else if(grdm>1) g=_radialxy(grdx,grdy,xy);
    else g=_linear(grdx,grdy,xy);
    //else g=ctx.createLinearGradient(xy[0],xy[1],xy[2],xy[3]);
    g.addColorStop(0,'#fff');
    g.addColorStop(1,c);
    ctx.fillStyle=g;
  } else
    ctx.fillStyle=c;
  if(rou) {
    var i,i,b2=border(x,y),b=[],lx,ly,nx,ny;
    for(i1=i=0;i<6;i1++,i+=2) b[i1]=_brd(x+b2[i],y+b2[i+1]);
    b.push(b[0]);
    xy.push(xy[0],xy[1]);
    ctx.beginPath();
    ctx.moveTo(nx=(xy[0]+xy[4])/2,ny=(xy[1]+xy[5])/2);
    if(tria) for(i1=i=0;i<6;i1++,i+=2) lx=nx,ly=ny,_arc2(b[i1]||b[i1+1],xy[i],xy[i+1],nx=(xy[i]+xy[i+2])/2,ny=(xy[i+1]+xy[i+3])/2,cell3y/3);
    else for(i1=i=0;i<6;i1++,i+=2) lx=nx,ly=ny,_bez2(b[i1]||b[i1+1],lx,ly,xy[i],xy[i+1],nx=(xy[i]+xy[i+2])/2,ny=(xy[i+1]+xy[i+3])/2,0.125);
    ctx.closePath();
    ctx.fill();
    ctx.beginPath();
    ctx.lineWidth=0.5;
    b.push(b[0]);b.shift();
    for(i1=i=0;i<12;i1++,i+=2) if(b[i1]) _line(xy[i],xy[i+1],xy[i+2],xy[i+3]);
  } else {
    ctx.beginPath();
    ctx.moveTo(xy[0],xy[1]);
    ctx.lineTo(xy[2],xy[3]);
    ctx.lineTo(xy[4],xy[5]);
    ctx.closePath();
    ctx.fill();
    ctx.lineWidth=0.5;
    ctx.stroke();
  }
}

function _drawcell2(x,y) {
  var xy=_points2(x,y);
  var c=_getuco(x,y,ctx.fillStyle=mono==2?clr2[(x+y)&1]:mono==22?clr2[1&((x+1)>>1)]:mono==21?clr2[x&1]:mono==4?clr4[(x&1)+2*(y&1)]:mono==30?clr2[y&1]:mono==31?clr3[(x+2*(y&1))%3]:'#fff');
  _drawcell3x(x,y,xy,c,_border2);
}


function _drawcell2x(x,y) {
  var xy=_points2(x,y);
  var c=_getuco(x,y,ctx.fillStyle=mono==2?clr2[(x+y)&1]:mono==22?clr2[1&((x+1)>>1)]:mono==21?clr2[x&1]:mono==4?clr4[(x&1)+2*(y&1)]:mono==30?clr2[y&1]:mono==31?clr3[(x+2*(y&1))%3]:'#fff');
  if(grdm) {
    var g;
    if(grdm>1) g=_radialxy(grdx,grdy,xy);
    else g=_linear(grdx,grdy,xy);
    //else g=ctx.createLinearGradient(xy[0],xy[1],xy[2],xy[3]);
    g.addColorStop(0,'#fff');
    g.addColorStop(1,c=='#fff'?clr2[1]:c);
    ctx.fillStyle=g;
  } else
    ctx.fillStyle=c;
  ctx.beginPath();
  ctx.moveTo(xy[0],xy[1]);
  ctx.lineTo(xy[2],xy[3]);
  ctx.lineTo(xy[4],xy[5]);
  ctx.closePath();
  ctx.fill();
  ctx.lineWidth=0.5;
  ctx.stroke();
}

function _drawcell5(x,y) {
  var xy=_points5(x,y),x2=(x-1)>>1,y2=(y-1)>>1,r=(1^x&1)|((1^y&1)<<1),tx=r==0||r==3;
  var dx=2*(x2-y2)+(r==1||r==3),dy=2*(x2+y2)-(r==2||r==3);
  var c=_getuco(x,y,mono==2?clr2[(x2^y2^tx)&1]:mono==22?clr2[1&((x+1)>>1)]:mono==21?clr2[1^y&1]:mono==4?clr4['0312'[r]]:mono==30?clr2[+!tx]:mono==31?clr3[(3+dx%3+((dy>>1)&1))%3]:'#fff');
  if(grdm) {
    var g;
    if(c=='#fff') c=clr2[1];
    if(grdm>=5) {
      if(rou) {
        var b2=_border5(x,y),b=_brdborder(x,y);
        _ground(xy,'#fff',c,0.5,0,0,grdm>5,b,0.125); 
      } else _gpoly(xy,'#fff',c,0.5,0,0,grdm>5);
      return;
    } else if(grdm>1) g=_radialxy(grdx,grdy,xy);
    else g=_linear(grdx,grdy,xy);
    //else g=ctx.createLinearGradient(xy[0],xy[1],xy[2],xy[3]);
    g.addColorStop(0,'#fff');
    g.addColorStop(1,c);
    ctx.fillStyle=g;
  } else
    ctx.fillStyle=c;
  if(rou) {
    var i,i,b2=_border5(x,y),b=[],lx,ly,nx,ny;
    for(i1=i=0;i<6;i1++,i+=2) b[i1]=_brd(x+b2[i],y+b2[i+1]);
    b.push(b[0]);
    xy.push(xy[0],xy[1]);
    ctx.beginPath();
    ctx.moveTo(nx=(xy[0]+xy[4])/2,ny=(xy[1]+xy[5])/2);
    for(i1=i=0;i<6;i1++,i+=2) lx=nx,ly=ny,_bez2(b[i1]||b[i1+1],lx,ly,xy[i],xy[i+1],nx=(xy[i]+xy[i+2])/2,ny=(xy[i+1]+xy[i+3])/2,0.125);
    ctx.closePath();
    ctx.fill();
    ctx.beginPath();
    ctx.lineWidth=0.5;
    b.push(b[0]);b.shift();
    for(i1=i=0;i<6;i1++,i+=2) if(b[i1]) _line(xy[i],xy[i+1],xy[i+2],xy[i+3]);
  } else {
    ctx.beginPath();
    ctx.moveTo(xy[0],xy[1]);
    ctx.lineTo(xy[2],xy[3]);
    ctx.lineTo(xy[4],xy[5]);
    ctx.closePath();
    ctx.fill();
    ctx.lineWidth=0.5;
    ctx.stroke();
  }
}

function _drawcell15(x,y) {
  var xy=_points15(x,y),cx=(x+1)/2|0,x1=x&1,v=(cx+y)&1;
  var c=_getuco(x,y,mono==2?clr2[(x+y)&1]:mono==22?clr2[1&((x+1)>>1)]:mono==21?clr2[x&1]:mono==4?clr4[2*v+x1]:mono==30?clr2[y&1]:mono==31?clr3[(x+2*(y&1))%3]:'#fff');
  if(grdm) {
    var g;
    if(c=='#fff') c=clr2[1];
    if(grdm>=5) {
      if(rou) {
        var b2=_border15(x,y),b=_brdborder(x,y);
        _ground(xy,'#fff',c,0.5,0,0,grdm>5,b,0.125); 
      } else _gpoly(xy,'#fff',c,0.5,0,0,grdm>5);
      return;
    } else if(grdm>1) g=_radialxy(grdx,grdy,xy);
    else g=_linear(grdx,grdy,xy);
    //else g=ctx.createLinearGradient(xy[0],xy[1],xy[4],xy[5]);
    g.addColorStop(0,'#fff');
    g.addColorStop(1,c);
    ctx.fillStyle=g;
  } else
    ctx.fillStyle=c;
  ctx.beginPath();
  if(rou) {
    var i,i,b2=_border15(x,y),b=[],lx,ly,nx,ny;
    for(i1=i=0;i<10;i1++,i+=2) b[i1]=_brd(x+b2[i],y+b2[i+1]);
    b.push(b[0]);
    xy.push(xy[0],xy[1]);
    ctx.moveTo(nx=(xy[0]+xy[8])/2,ny=(xy[1]+xy[9])/2);
    for(i1=i=0;i<10;i1++,i+=2) lx=nx,ly=ny,_bez2(b[i1]||b[i1+1],lx,ly,xy[i],xy[i+1],nx=(xy[i]+xy[i+2])/2,ny=(xy[i+1]+xy[i+3])/2,0.125);
    ctx.closePath();
    ctx.fill();
    ctx.beginPath();
    ctx.lineWidth=0.5;
    b.push(b[0]);b.shift();
    for(i1=i=0;i<10;i1++,i+=2) if(b[i1]) _line(xy[i],xy[i+1],xy[i+2],xy[i+3]);
  } else {
    ctx.moveTo(xy[0],xy[1]);
    ctx.lineTo(xy[2],xy[3]);
    ctx.lineTo(xy[4],xy[5]);
    ctx.lineTo(xy[6],xy[7]);
    ctx.lineTo(xy[8],xy[9]);
    ctx.closePath();
    ctx.fill();
    ctx.lineWidth=0.5;
    ctx.stroke();
  }
}

function _drawcell8(x,y) {
  var xy=_points8(x,y),d=(x+2)%3,cx=(x+2-d)/3;
  var sx=brd+(cx+(y&1)/2)*cell8x,sy=brd+((1+y*3)/4)*cell8y,x2=cell8x/2,y2=cell8y/4;
  var c=_getuco(x,y,mono==2?clr2[(x+y)&1]:mono==22?clr2[1&((x+1)>>1)]:mono==21?clr2[x&1]:mono==4?clr4[2*(y&1)+(x&1)]:mono==30?clr2[y&1]:mono==31?clr3[d]:'#fff');
  if(grdm) {
    var g;
    if(c=='#fff') c=clr2[1];
    if(grdm>=5) {
      if(rou) {
        var b2=_border8(x,y),b=_brdborder(x,y);
        _ground(xy,'#fff',c,0.5,0,0,grdm>5,b,0.125); 
      } else _gpoly(xy,'#fff',c,0.5,0,0,grdm>5);
      return;
    } else if(grdm>1) g=_radialxy(grdx,grdy,xy);
    else g=_linear(grdx,grdy,xy);
    //else g=ctx.createLinearGradient(xy[0],xy[1],xy[2],xy[3]);
    g.addColorStop(0,'#fff');
    g.addColorStop(1,c);
    ctx.fillStyle=g;
  } else
    ctx.fillStyle=c;
  ctx.beginPath();
  if(rou) {
    var i,i,b2=_border8(x,y),b=[],lx,ly,nx,ny;
    for(i1=i=0;i<8;i1++,i+=2) b[i1]=_brd(x+b2[i],y+b2[i+1]);
    b.push(b[0]);
    xy.push(xy[0],xy[1]);
    ctx.moveTo(nx=(xy[0]+xy[6])/2,ny=(xy[1]+xy[7])/2);
    for(i1=i=0;i<8;i1++,i+=2) lx=nx,ly=ny,_bez2(b[i1]||b[i1+1],lx,ly,xy[i],xy[i+1],nx=(xy[i]+xy[i+2])/2,ny=(xy[i+1]+xy[i+3])/2,0.125);
    ctx.closePath();
    ctx.fill();
    ctx.beginPath();
    ctx.lineWidth=0.5;
    b.push(b[0]);b.shift();
    for(i1=i=0;i<8;i1++,i+=2) if(b[i1]) _line(xy[i],xy[i+1],xy[i+2],xy[i+3]);
  } else {
    ctx.moveTo(xy[0],xy[1]);
    ctx.lineTo(xy[2],xy[3]);
    ctx.lineTo(xy[4],xy[5]);
    ctx.lineTo(xy[6],xy[7]);
    ctx.closePath();
    ctx.fill();
    ctx.lineWidth=0.5;
    ctx.stroke();
  }
}

function _drawcell7(x,y) {
  var xy=_points7(x,y),d=(x+2)%3,cx=(x+2-d)/3;
  var sx=brd+(cx+(y&1)/2)*cell8x,sy=brd+((1+y*3)/4)*cell8y,x2=cell8x/2,y2=cell8y/4;
  var c=_getuco(x,y,mono==2?clr2[(x+y)&1]:mono==22?clr2[1&((x+1)>>1)]:mono==21?clr2[x&1]:mono==4?clr4[2*(y&1)+(x&1)]:mono==30?clr2[y&1]:mono==31?clr3[d]:'#fff');
  if(grdm) {
    var g;
    if(c=='#fff') c=clr2[1];
    if(grdm>=5) {
      if(rou) {
        var b2=_border7(x,y),b=_brdborder(x,y);
        _ground(xy,'#fff',c,0.5,0,0,grdm>5,b,0.125); 
      } else _gpoly(xy,'#fff',c,0.5,0,0,grdm>5);
      return;
    } else if(grdm>1) g=_radialxy(grdx,grdy,xy);
    else g=_linear(grdx,grdy,xy);
    //else g=ctx.createLinearGradient(xy[0],xy[1],xy[2],xy[3]);
    g.addColorStop(0,'#fff');
    g.addColorStop(1,c);
    ctx.fillStyle=g;
  } else
    ctx.fillStyle=c;
  ctx.beginPath();
  if(rou) {
    var i,i,b2=_border7(x,y),b=[],lx,ly,nx,ny;
    for(i1=i=0;i<12;i1++,i+=2) b[i1]=_brd(x+b2[i],y+b2[i+1]);
    b.push(b[0]);
    xy.push(xy[0],xy[1]);
    ctx.moveTo(nx=(xy[0]+xy[10])/2,ny=(xy[1]+xy[11])/2);
    for(i1=i=0;i<12;i1++,i+=2) lx=nx,ly=ny,_bez2(b[i1]||b[i1+1],lx,ly,xy[i],xy[i+1],nx=(xy[i]+xy[i+2])/2,ny=(xy[i+1]+xy[i+3])/2,0.125);
    ctx.closePath();
    ctx.fill();
    ctx.beginPath();
    ctx.lineWidth=0.5;
    b.push(b[0]);b.shift();
    for(i1=i=0;i<12;i1++,i+=2) if(b[i1]) _line(xy[i],xy[i+1],xy[i+2],xy[i+3]);
  } else {
    ctx.moveTo(xy[0],xy[1]);
    ctx.lineTo(xy[2],xy[3]);
    ctx.lineTo(xy[4],xy[5]);
    ctx.lineTo(xy[6],xy[7]);
    ctx.lineTo(xy[8],xy[9]);
    ctx.lineTo(xy[10],xy[11]);
    ctx.closePath();
    ctx.fill();
    ctx.lineWidth=0.5;
    ctx.stroke();
  }
}


function _drawcell11(x,y) {
  var xy=_points11(x,y),cx=(x+1)/2;
  var sx=brd+(cx+(y&1)/2)*cell8x,sy=brd+((1+y*3)/4)*cell8y,x2=cell8x/2,y2=cell8y/4;
  var c=_getuco(x,y,mono==2?clr2[(x+y)&1]:mono==22?clr2[1&((x+1)>>1)]:mono==21?clr2[x&1]:mono==4?clr4[2*(y&1)+(x&1)]:mono==30?clr2[y&1]:mono==31?clr3[(x+2*(y&1))%3]:'#fff');
  if(grdm) {
    var g;
    if(c=='#fff') c=clr2[1];
    if(grdm>=5) {
      if(rou) {
        var b=_brdborder(x,y);
        _ground(xy,'#fff',c,0.5,0,0,grdm>5,b,0.125); 
      } else _gpoly(xy,'#fff',c,0.5,0,0,grdm>5);
      return;
    } else if(grdm>1) g=_radialxy(grdx,grdy,xy);
    else g=_linear(grdx,grdy,xy);
    //else g=ctx.createLinearGradient(xy[0],xy[1],xy[4],xy[5]);
    g.addColorStop(0,'#fff');
    g.addColorStop(1,c);
    ctx.fillStyle=g;
  } else
    ctx.fillStyle=c;
  ctx.beginPath();
  if(rou) {
    var i,i,b2=_border11(x,y),b=[],lx,ly,nx,ny;
    for(i1=i=0;i<8;i1++,i+=2) b[i1]=_brd(x+b2[i],y+b2[i+1]);
    b.push(b[0]);
    xy.push(xy[0],xy[1]);
    ctx.moveTo(nx=(xy[0]+xy[6])/2,ny=(xy[1]+xy[7])/2);
    for(i1=i=0;i<8;i1++,i+=2) lx=nx,ly=ny,_bez2(b[i1]||b[i1+1],lx,ly,xy[i],xy[i+1],nx=(xy[i]+xy[i+2])/2,ny=(xy[i+1]+xy[i+3])/2,0.125);
    ctx.closePath();
    ctx.fill();
    ctx.beginPath();
    ctx.lineWidth=0.5;
    b.push(b[0]);b.shift();
    for(i1=i=0;i<8;i1++,i+=2) if(b[i1]) _line(xy[i],xy[i+1],xy[i+2],xy[i+3]);
  } else {
    ctx.moveTo(xy[0],xy[1]);
    ctx.lineTo(xy[2],xy[3]);
    ctx.lineTo(xy[4],xy[5]);
    ctx.lineTo(xy[6],xy[7]);
    ctx.closePath();
    ctx.fill();
    ctx.lineWidth=0.5;
    ctx.stroke();
  }
}

function _border9(x,y) {
  var r=(x+2)%3,cx=(x+2-r)/3,d=1^(y&1)^(cx&1),dy=d?-1:1;
  if(d) {
    if(r==1) return [-2,0,2,0,1,0,-1,0];
    if(r==2) return [2,0,0,-dy,-2,0,-1,0];
    return [0,-dy,-2,0,1,0,2,0];
  } else {
    if(r==1) return [2,0,-2,0,-1,0,1,0];
    if(r==2) return [0,-dy,2,0,-1,0,-2,0];
    return [-2,0,0,-dy,2,0,1,0];
  }
/*
  if(d) {
    if(r==1) return [2,0,-2,0,-1,0,1,0];
    if(r==2) return [0,-dy,2,0,-1,0,-2,0];
    return [-2,0,0,-dy,2,0,1,0];
  } else {
    if(r==1) return [-2,0,2,0,1,0,-1,0];
    if(r==2) return [2,0,0,-dy,-2,0,-1,0];
    return [0,-dy,-2,0,1,0,2,0];
  }
*/
}

function _border19(x,y) {
  var r=(x+2)%3,cx=(x+2-r)/3,d=1^(y&1)^(cx&1),dy=d?-1:1;
  if(d) {
    if(r==1) return [2,0,4,0,2,-1,3,0 ,-2,0,-4,0,-2,-1,-3,0 ,-1,0,-1,1,-3,0,1,0 ,1,0,1,1,3,0,-1,0];
    if(r==2) return [0,1,-1,1,2,1,-2,1 ,2,0,3,0,4,0,1,0 ,-1,0,-3,0,1,0,-2,0 ,-2,0,-4,0,-2,1,-1,0];
    return [-2,0,-3,0,-4,0,-1,0 ,0,1,0,3,-1,0,2,0 ,2,0,4,0,2,1,1,0 ,1,0,3,0,-1,0,2,0 ];
  } else {
    if(r==1) return [-2,0,-4,0,-2,1,-3,0 ,2,0,4,0,2,1,3,0 ,1,0,1,-1,3,0,-1,0 ,-1,0,-1,-1,-3,0,1,0];
    if(r==2) return [2,0,3,0,4,0,1,0 ,0,-1,-1,-1,2,-1,-2,-1 ,-2,0,-4,0,-2,-1,-1,0 ,-1,0,-3,0,1,0,-2,0];
    return [0,-1,1,-1,-2,-1,2,-1 ,-2,0,-3,0,-4,0,-1,0 ,1,0,3,0,-1,0,2,0  ,2,0,4,0,2,-1,1,0];
  }
}

function _points9(x,y) {
  var r=(x+2)%3,cx=(x+2-r)/3,d=1^(y&1)^(cx&1),dy=d?-1:1;
  var sx=brd+cx*cell9x/2,sy=brd+(y+d)*cell9y,y2=sy+dy*cell9y,y3=(2*sy+y2)/3,y4=(sy+y2)/2,x4=sx+cell9x/2;
  if(d) {
    if(r==1) return [x4,y2,sx+cell9x*3/4,y4,x4,y3,sx+cell9x/4,y4];
    if(r==2) return [sx+cell9x,sy,x4,sy,x4,y3,sx+cell9x*3/4,y4];
    return [sx,sy,sx+cell9x/4,y4,x4,y3,x4,sy];
  } else {
    if(r==1) return [x4,y2,sx+cell9x/4,y4,x4,y3,sx+cell9x*3/4,y4];
    if(r==2) return [sx+cell9x,sy,sx+cell9x*3/4,y4,x4,y3,x4,sy];
    return [sx,sy,x4,sy,x4,y3,sx+cell9x/4,y4];
  }
/*
  if(d) {
    if(r==1) return [x4,y2,sx+cell9x/4,y4,x4,y3,sx+cell9x*3/4,y4];
    if(r==2) return [sx+cell9x,sy,sx+cell9x*3/4,y4,x4,y3,x4,sy];
    return [sx,sy,x4,sy,x4,y3,sx+cell9x/4,y4];
  } else {
    if(r==1) return [x4,y2,sx+cell9x*3/4,y4,x4,y3,sx+cell9x/4,y4];
    if(r==2) return [sx+cell9x,sy,x4,sy,x4,y3,sx+cell9x*3/4,y4];
    return [sx,sy,sx+cell9x/4,y4,x4,y3,x4,sy];
  }
*/
}

function _drawcell9(x,y) {
  var xy=_points9(x,y),d=(x+2)%3,cx=(x+2-d)/3;
  var c=_getuco(x,y,mono==2?clr2[(x+y)&1]:mono==22?clr2[1&((x+1)>>1)]:mono==21?clr2[x&1]:mono==4?clr4[2*(y&1)+(x&1)]:mono==30?clr2[y&1]:mono==31?clr3[d]:'#fff');
  if(grdm) {
    var g;
    if(c=='#fff') c=clr2[1];
    if(grdm>=5) {
      if(rou) {
        var b=_brdborder(x,y);
        _ground(xy,'#fff',c,0.5,0,0,grdm>5,b,0.125); 
      } else _gpoly(xy,'#fff',c,0.5,0,0,grdm>5);
      return;
    } else if(grdm>1) g=_radialxy(grdx,grdy,xy);
    else g=_linear(grdx,grdy,xy);
    //else g=ctx.createLinearGradient(xy[0],xy[1],xy[2],xy[3]);
    g.addColorStop(0,'#fff');
    g.addColorStop(1,c);
    ctx.fillStyle=g;
  } else
    ctx.fillStyle=c;
  ctx.beginPath();
  if(rou) {
    var i,i,b2=_border9(x,y),b=[],lx,ly,nx,ny;
    for(i1=i=0;i<8;i1++,i+=2) b[i1]=_brd(x+b2[i],y+b2[i+1]);
    b.push(b[0]);
    xy.push(xy[0],xy[1]);
    ctx.moveTo(nx=(xy[0]+xy[6])/2,ny=(xy[1]+xy[7])/2);
    for(i1=i=0;i<8;i1++,i+=2) lx=nx,ly=ny,_bez2(b[i1]||b[i1+1],lx,ly,xy[i],xy[i+1],nx=(xy[i]+xy[i+2])/2,ny=(xy[i+1]+xy[i+3])/2,0.125);
    ctx.closePath();
    ctx.fill();
    ctx.beginPath();
    ctx.lineWidth=0.5;
    b.push(b[0]);b.shift();
    for(i1=i=0;i<8;i1++,i+=2) if(b[i1]) _line(xy[i],xy[i+1],xy[i+2],xy[i+3]);
  } else {
    ctx.moveTo(xy[0],xy[1]);
    ctx.lineTo(xy[2],xy[3]);
    ctx.lineTo(xy[4],xy[5]);
    ctx.lineTo(xy[6],xy[7]);
    ctx.closePath();
    ctx.fill();
    ctx.lineWidth=0.5;
    ctx.stroke();
  }
}

function _inv2(t) {
  var c=parseInt(t.substr(1),16),s=t.length==4,r,g,b,i,a,m;
  if(s) m=15,r=(c>>8)&m,g=(c>>4)&m,b=c&m;
  else m=255,r=(c>>16)&m,g=(c>>8)&m,b=c&m;
  i=a=r;
  if(g<i) i=g;else if(g>a) a=g;
  if(b<i) i=b;else if(b>a) a=b;
  i=m-a-i;
  r+=i,g+=i,b+=i;
  c=s?(r<<8)|(g<<4)|b:(r<<16)|(g<<8)|b;
  t=c.toString(16);
  return '#'+'000000'.substr((s?3:0)+t.length)+t;
}

function _whi(t) {
  var c=parseInt(t.substr(1),16),s=t.length==4,r,g,b,m;
  if(s) m=15,r=(c>>8)&m,g=(c>>4)&m,b=c&m;
  else m=255,r=(c>>16)&m,g=(c>>8)&m,b=c&m;
  r=0|(m-(m-r)/3);
  g=0|(m-(m-g)/3);
  b=0|(m-(m-b)/3);
  c=s?(r<<8)|(g<<4)|b:(r<<16)|(g<<8)|b;
  t=c.toString(16);
  return '#'+'000000'.substr((s?3:0)+t.length)+t;
}

function _radial_sph(x,y,r) {
  return [x-r*1/2,y-r*1/2,r];
}

function _radial_xy(xy) {
  var sx,sy,r,i,m=0,n=0,d,x,y,lx=xy[xy.length-2],ly=xy[xy.length-1];
  sx=_polyc(xy),sy=sx[1],sx=sx[0];
  for(i=0;i<xy.length;i+=2) {
    x=xy[i],y=xy[i+1],d=_sqr(x-sx,y-sy);
    if(d>n) n=d;
    d=_sqr((x+lx)/2-sx,(y+ly)/2-sy);
    if(d>m) m=d;
    lx=x,ly=y;
  }
  m=Math.round(Math.sqrt(m));
  return [sx,sy,m];
}

function _radial(x,y,r,c1,c0) {
  g=ctx.createRadialGradient(x,y,0,x,y,r);
  g.addColorStop(1,c1||'#000');
  g.addColorStop(0,c0||'#fff');
  return g;
}

function _drawpeg(x,y,wh,p) {
  var sx=brd+x*cell,sy=brd+y*cell,c2=cell/2,pc=_getpgc(x,y),fs,rp;
  ctx.lineWidth=wh?2:0.5;
  ctx.beginPath();
  fs=pc?wh?_whi(pc):pc:wh?grdm2?'#ccc':'#fff':'#000';
  if(p) {
    if(grdm2) rp=_radial_xy([sx+4,sy+4,sx+cell-4,sy+4,sx+cell-4,sy+cell-4,sx+4,sy+cell-4]),fs=_radial(rp[0],rp[1],rp[2],fs);
    ctx.fillStyle=fs;
    if(rou) {
      var c2=cell/2,cx=sx+c2,cy=sy+c2,d=4,r=c2-d,b=[_brd(x-1,y),_brd(x,y-1),_brd(x+1,y),_brd(x,y+1)];
      ctx.moveTo(sx+4,sy+c2);
      _arc2(b[0]||b[1],sx+d,sy+d,sx+c2,sy+d,r);
      _arc2(b[1]||b[2],sx+cell-d,sy+d,sx+cell-d,sy+c2,r);
      _arc2(b[2]||b[3],sx+cell-d,sy+cell-d,sx+c2,sy+cell-d,r);
      _arc2(b[3]||b[0],sx+d,sy+cell-d,sx+4,sy+c2,r);
    } else 
      ctx.rect(sx+4,sy+4,cell-8,cell-8);
  } else {
    if(grdm2) rp=_radial_sph(sx+c2,sy+c2,c2-3),fs=_radial(rp[0],rp[1],rp[2],fs);
    ctx.fillStyle=fs;
    ctx.arc(sx+c2,sy+c2,c2-3,0,2*Math.PI);
  }
  ctx.fill();
  ctx.stroke();
}

function _polyex2(xy,e,dx,dy) {
  var i,n,x,y,a,b;
  if(e!=1) {
    if(!dx&&!dy) dx=dy=0;
    if(delta||tria2||tria4||trap||deca) {
      _polyex3(xy,e==15/16?1:4);
      dx=dy=0;
      return xy;
    } else {
      for(i=x=y=0;i<xy.length;i+=2) x+=xy[i],y+=xy[i+1];
      i>>=1,x/=i,y/=i;
    } 
    for(i=0;i<xy.length;i+=2) xy[i]=dx+x+e*(xy[i]-x),xy[i+1]=dy+y+e*(xy[i+1]-y);
  }
  return xy;
}

function _polyex(xy,e,dx,dy) {
  var i;
  _polyex2(xy,e,dx,dy);
  ctx.beginPath();
  ctx.moveTo(xy[0],xy[1]);
  for(i=2;i<xy.length;i+=2)
    ctx.lineTo(xy[i],xy[i+1]);
  ctx.closePath();
}

function _polyex3(xy,e) {
  if(!e) return;
  var i,i2,dx,dy,d,da=[],va=[],f;
  for(i2=xy.length-2,i=0;i<xy.length;i2=i,i+=2) {
    d=Math.sqrt(_sqr(dx=xy[i]-xy[i2],dy=xy[i+1]-xy[i2+1]));
    da[i2]=dx/d,da[i2+1]=dy/d;
  }
  for(i2=xy.length-2,i=0;i<xy.length;i2=i,i+=2) {
    va[i]=da[i]-da[i2],va[i+1]=da[i+1]-da[i2+1];
  }
  for(i2=xy.length-2,i=0;i<xy.length;i2=i,i+=2) {
    dx=va[i],dy=va[i+1];
    d=_sqr(dx,dy);
    if(d>0.5) {
      d=Math.sqrt(d);
      dx/=d,dy/=d;
      d=(delta?1:1)/(-da[i+1]*dx+da[i]*dy);
    } else {
      dx=-da[i+1],dy=da[i];
      d=Math.sqrt(_sqr(dx,dy));
    }
    xy[i]+=e*dx*d,xy[i+1]+=e*dy*d;
  }
}

function _drawpeg15(x,y,wh,p) {
  _drawpeg3x(x,y,wh,p,_points15,_border15);
}

/* function _drawpeg15old(x,y,wh,p) {
  if(wh) ctx.lineWidth=2;
  var pc=_getpgc(x,y);
  ctx.beginPath();
  ctx.fillStyle=pc?wh?_whi(pc):pc:wh?'#fff':'#000';
  if(p) {
    if(rou) {
      var xy=_polyex2(_points15(x,y),0.75),b=_border15(x,y);
      var i,i1,o=[],lx,ly,nx,ny;
      for(i1=i=0;i<10;i1++,i+=2) o[i1]=_brd(x+b[i],y+b[i+1]);
      o.push(o[0]);xy.push(xy[0],xy[1]);
      ctx.moveTo(nx=(xy[0]+xy[8])/2,ny=(xy[1]+xy[9])/2);
      for(i1=i=0;i<10;i1++,i+=2)
        lx=nx,ly=ny,_bez2(o[i1]||o[i1+1],lx,ly,xy[i],xy[i+1],nx=(xy[i]+xy[i+2])/2,ny=(xy[i+1]+xy[i+3])/2,0.125);
    } else 
      _polyex(_points15(x,y),0.75);
  } else {
    var p=_peg(x,y);
    ctx.arc(p[0],p[1],p[2],0,2*Math.PI);
  }
  ctx.fill();
  if(wh) ctx.stroke();
}*/

function _drawpeg7(x,y,wh,p) {
  _drawpeg3x(x,y,wh,p,_points7,_border7);
}

function _drawpeg8(x,y,wh,p) {
  _drawpeg3x(x,y,wh,p,_points8,_border8);
}
/* function _drawpeg8old(x,y,wh,p) {
  if(wh) ctx.lineWidth=2;
  var pc=_getpgc(x,y),fs=pc?wh?_whi(pc):pc:wh?'#fff':'#000',rp;
  ctx.beginPath();
  ctx.fillStyle=pc?wh?_whi(pc):pc:wh?'#fff':'#000';
  if(p) {
    var pt=_points8(x,y),rp;
    if(grdm2) rp=_radial_xy(pt),fs=_radial(rp[0],rp[1],rp[2],fs);
    ctx.fillStyle=fs;
    if(rou) {
      var xy=_polyex2(pt,0.75),b=_border8(x,y);
      var i,i1,o=[],lx,ly,nx,ny;
      for(i1=i=0;i<8;i1++,i+=2) o[i1]=_brd(x+b[i],y+b[i+1]);
      o.push(o[0]);xy.push(xy[0],xy[1]);
      ctx.moveTo(nx=(xy[0]+xy[6])/2,ny=(xy[1]+xy[7])/2);
      for(i1=i=0;i<8;i1++,i+=2)
        lx=nx,ly=ny,_bez2(o[i1]||o[i1+1],lx,ly,xy[i],xy[i+1],nx=(xy[i]+xy[i+2])/2,ny=(xy[i+1]+xy[i+3])/2,0.125);
    } else 
      _polyex(pt,0.75);
  } else {
    var p=_peg(x,y);
    if(grdm2) rp=_radial_sph(p[0],p[1],p[2]),fs=_radial(rp[0],rp[1],rp[2],fs);
    ctx.fillStyle=fs;
    ctx.arc(p[0],p[1],p[2],0,2*Math.PI);
  }
  ctx.fill();
  if(wh) ctx.stroke();
}*/

function _drawpeg9(x,y,wh,p) {
  _drawpeg3x(x,y,wh,p,_points9,_border9);
}
/* function _drawpeg9old(x,y,wh,p) {
  if(wh) ctx.lineWidth=2;
  var pc=_getpgc(x,y),fs=pc?wh?_whi(pc):pc:wh?'#fff':'#000',rp;
  ctx.beginPath();
  ctx.fillStyle=pc?wh?_whi(pc):pc:wh?'#fff':'#000';
  if(p) {
    var pt=_points9(x,y),rp;
    if(grdm2) rp=_radial_xy(pt),fs=_radial(rp[0],rp[1],rp[2],fs);
    ctx.fillStyle=fs;
    if(rou) {
      var xy=_polyex2(pt,0.75),b=_border9(x,y);
      var i,i1,o=[],lx,ly,nx,ny;
      for(i1=i=0;i<8;i1++,i+=2) o[i1]=_brd(x+b[i],y+b[i+1]);
      o.push(o[0]);xy.push(xy[0],xy[1]);
      ctx.moveTo(nx=(xy[0]+xy[6])/2,ny=(xy[1]+xy[7])/2);
      for(i1=i=0;i<8;i1++,i+=2)
        lx=nx,ly=ny,_bez2(o[i1]||o[i1+1],lx,ly,xy[i],xy[i+1],nx=(xy[i]+xy[i+2])/2,ny=(xy[i+1]+xy[i+3])/2,0.125);
    } else 
      _polyex(pt,0.75);
  } else {
    var p=_peg(x,y);
    if(grdm2) rp=_radial_sph(p[0],p[1],p[2]),fs=_radial(rp[0],rp[1],rp[2],fs);
    ctx.fillStyle=fs;
    ctx.arc(p[0],p[1],p[2],0,2*Math.PI);
  }
  ctx.fill();
  if(wh) ctx.stroke();
}*/

function _drawpeg11(x,y,wh,p) {
  _drawpeg3x(x,y,wh,p,_points11,_border11);
}
/* function _drawpeg11old(x,y,wh,p) {
  if(wh) ctx.lineWidth=2;
  var pc=_getpgc(x,y);
  ctx.beginPath();
  ctx.fillStyle=pc?wh?_whi(pc):pc:wh?'#fff':'#000';
  if(p) {
    if(rou) {
      var xy=_polyex2(_points11(x,y),0.75),b=_border11(x,y);
      var i,i1,o=[],lx,ly,nx,ny;
      for(i1=i=0;i<8;i1++,i+=2) o[i1]=_brd(x+b[i],y+b[i+1]);
      o.push(o[0]);xy.push(xy[0],xy[1]);
      ctx.moveTo(nx=(xy[0]+xy[6])/2,ny=(xy[1]+xy[7])/2);
      for(i1=i=0;i<8;i1++,i+=2)
        lx=nx,ly=ny,_bez2(o[i1]||o[i1+1],lx,ly,xy[i],xy[i+1],nx=(xy[i]+xy[i+2])/2,ny=(xy[i+1]+xy[i+3])/2,0.125);
    } else 
      _polyex(_points11(x,y),0.75);
  } else {
    var p=_peg(x,y);
    ctx.arc(p[0],p[1],p[2],0,2*Math.PI);
  }
  ctx.fill();
  if(wh) ctx.stroke();
}*/

function _drawpeg16(x,y,wh,p) {
  _drawpeg3x(x,y,wh,p,_points16,_border16);
}
/*function _drawpeg16old(x,y,wh,p) {
  if(wh) ctx.lineWidth=2;
  var pc=_getpgc(x,y),rp;
  fs=pc?wh?_whi(pc):pc:wh?'#fff':'#000';
  ctx.beginPath();
  if(p) {
    var pt=_points16(x,y),rp;
    if(grdm2) rp=_radial_xy(pt),fs=_radial(rp[0],rp[1],rp[2],fs);
    ctx.fillStyle=fs;
    if(rou) {
      var xy=_polyex2(pt,0.75),b=_border16(x,y);
      var i,i1,a,cx=(xy[0]+xy[6])/2,cy=(xy[1]+xy[7])/2,r=Math.sqrt(_sqr((xy[0]+xy[2])/2-cx,(xy[1]+xy[3])/2-cy)),o=[];
      for(i1=i=0;i<12;i1++,i+=2) o[i1]=_brd(x+b[i],y+b[i+1]);
      o.push(o[0]);xy.push(xy[0],xy[1]);
      ctx.moveTo((xy[0]+xy[10])/2,(xy[1]+xy[11])/2);
      for(i1=i=0;i<12;i1++,i+=2)
        _arc2(o[i1]||o[i1+1],xy[i],xy[i+1],(xy[i]+xy[i+2])/2,(xy[i+1]+xy[i+3])/2,r);
    } else 
      _polyex(pt,0.75);
  } else {
    var p=_peg(x,y),r=p[2];
    if(grdm2) rp=_radial_sph(p[0],p[1],p[2]),fs=_radial(rp[0],rp[1],rp[2],fs);
    ctx.fillStyle=fs;
    ctx.arc(p[0],p[1],p[2],0,2*Math.PI);
  }
  ctx.fill();
  if(wh) ctx.stroke();
}*/

function _drawpeg3(x,y,wh,p) {
  _drawpeg3x(x,y,wh,p,_points3,_border3);
}

function _drawpeg3x(x,y,wh,p,points,border) {
  ctx.lineWidth=wh?2:0.5;
  var pc=_getpgc(x,y),fs=pc?wh?_whi(pc):pc:wh?'#fff':'#000',rp;
  ctx.beginPath();
  if(p) {
    var pt=_polyex2(_points(x,y),0.75),rp;
    if(grdm2) rp=_radial_xy(pt),fs=_radial(rp[0],rp[1],rp[2],fs);
    ctx.fillStyle=fs;
    if(rou) {
      var xy=pt,b=border(x,y);
      var i,i1,o=[],lx,ly,nx,ny,n=xy.length;
      for(i1=i=0;i<n;i1++,i+=2) o[i1]=_brd(x+b[i],y+b[i+1]);
      o.push(o[0]);xy.push(xy[0],xy[1]);
      ctx.moveTo(nx=(xy[0]+xy[n-2])/2,ny=(xy[1]+xy[n-1])/2);
      if(tria) 
      for(i1=i=0;i<n;i1++,i+=2)
        lx=nx,ly=ny,_arc2(o[i1]||o[i1+1],xy[i],xy[i+1],nx=(xy[i]+xy[i+2])/2,ny=(xy[i+1]+xy[i+3])/2,cell3y*0.75/3);
      else for(i1=i=0;i<n;i1++,i+=2)
        lx=nx,ly=ny,_bez2(o[i1]||o[i1+1],lx,ly,xy[i],xy[i+1],nx=(xy[i]+xy[i+2])/2,ny=(xy[i+1]+xy[i+3])/2,0.125);
    } else 
      _polyex(pt,1);
  } else {
    var p=_peg(x,y);
    if(grdm2) rp=_radial_sph(p[0],p[1],p[2]),fs=_radial(rp[0],rp[1],rp[2],fs);
    ctx.fillStyle=fs;
    ctx.arc(p[0],p[1],p[2],0,2*Math.PI);
  }
  ctx.closePath();
  ctx.fill();
  ctx.stroke();
}

function _drawpeg2(x,y,wh,p) {
  _drawpeg3x(x,y,wh,p,_points2,_border2);
}
function _drawpeg2x(x,y,wh,p) {
  var xy=_points2(x,y),sx=(45*xy[0]+19*(xy[2]+xy[4]-xy[0]))/64,sy=(45*xy[1]+19*(xy[3]+xy[5]-xy[1]))/64;
  if(wh) ctx.lineWidth=2;
  ctx.beginPath();
  ctx.fillStyle=wh?'#fff':'#000';
  if(p) {
    var dx,dy,d=0.5,r=((x&3)+2*(y&1))&3;
    if(r&2) dy=-d,dx=r&1?-d:d;
    else dy=d,dx=r&1?-d:d;
    _polyex(_points2(x,y),0.70,dx,dy);
  } else 
    ctx.arc(sx,sy,cell*9/32,0,2*Math.PI);
  ctx.fill();
  if(wh) ctx.stroke();
}

function _drawpeg5(x,y,wh,p) {
  _drawpeg3x(x,y,wh,p,_points5,_border5);
}
function _drawpeg5x(x,y,wh,p) {
  if(wh) ctx.lineWidth=2;
  ctx.beginPath();
  ctx.fillStyle=wh?'#fff':'#000';
  if(p) {
    if(rou) {
      var xy=_polyex2(_points5(x,y),0.75),b=_border5(x,y);
      var i,i1,o=[],lx,ly,nx,ny;
      for(i1=i=0;i<6;i1++,i+=2) o[i1]=_brd(x+b[i],y+b[i+1]);
      o.push(o[0]);xy.push(xy[0],xy[1]);
      ctx.moveTo(nx=(xy[0]+xy[4])/2,ny=(xy[1]+xy[5])/2);
      for(i1=i=0;i<6;i1++,i+=2)
        lx=nx,ly=ny,_bez2(o[i1]||o[i1+1],lx,ly,xy[i],xy[i+1],nx=(xy[i]+xy[i+2])/2,ny=(xy[i+1]+xy[i+3])/2,0.125);
    } else 
      _polyex(_points5(x,y),0.75);
  } else {
    var p=_peg(x,y);
    ctx.arc(p[0],p[1],p[2],0,2*Math.PI);
  }
  ctx.closePath();
  ctx.fill();
  if(wh) ctx.stroke();
}

function _drawpeg5xx(x,y,wh,p) {
  var xy=_points5(x,y),sx=(26*xy[0]+19*(xy[2]+xy[4]))/64,sy=(26*xy[1]+19*(xy[3]+xy[5]))/64;
  if(wh) ctx.lineWidth=2;
  ctx.beginPath();
  ctx.fillStyle=wh?'#fff':'#000';
  if(p) {
    var r=(((y+1)&1)<<1)|((x+1)&1),dx=0,dy=0,d=0.6;
    if(r==1) dy=+d; else if(r==2) dy=-d;
    else if(r==3) dx=-d;else dx=d;
    _polyex(xy,0.70,dx,dy);
  } else 
    ctx.arc(sx,sy,cell*8/32,0,2*Math.PI);
  ctx.fill();
  if(wh) {
    ctx.lineJoin='round';
    ctx.stroke();
    ctx.lineJoin='miter';
  }
}

function _xo(x) { return x=='o'||x=='x'||x=='w';}
function _line(x,y,x2,y2) { 
    ctx.beginPath();
    ctx.moveTo(x,y);
    ctx.lineTo(x2,y2);
    ctx.stroke();
}
function _rline(x,y,dx,dy) { _line(x,y,x+dx,y+dy);}
function _arc(x,y,r,a,d,f) { 
  var b=a+d;
  ctx.beginPath();
  ctx.arc(x,y,r,Math.PI*a/180,Math.PI*b/180);
  if(f) ctx.fill();else ctx.stroke();
}
function _circle(r,x,y,f) { _arc(x,y,r,0,360,f);}
function _circle2(r,x,y,x2,y2,f) { _circle(r,x,y,f),_circle(r,x2,y2,f);}
function _arc2(c,x,y,x2,y2,r) { if(c) ctx.lineTo(x,y),ctx.lineTo(x2,y2);else ctx.arcTo(x,y,x2,y2,r); }
function _bez(x,y,x1,y1,x2,y2,r) { 
  var r1=1-r;
  ctx.beginPath();
  ctx.moveTo(x,y);
  ctx.bezierCurveTo(r1*x1+r*x,r1*y1+r*y,r1*x1+r*x2,r1*y1+r*y2,x2,y2);
  ctx.stroke();
}
function _bez2(c,x,y,x1,y1,x2,y2,r) { 
  if(c) ctx.lineTo(x1,y1),ctx.lineTo(x2,y2);
  else {
   var r1=1-r;
   ctx.bezierCurveTo(r1*x1+r*x,r1*y1+r*y,r1*x1+r*x2,r1*y1+r*y2,x2,y2);
  }
}

function _bezsplit(p,s,a,b,c,d) {
  var q=1-p,p2=p*p,q2=q*q;
  if(s) {
    return [q2*q*a+3*q2*p*b+3*q*p2*c+p2*p*d,q2*b+2*p*q*c+p2*d,q*c+p*d,d];
  } else {
    return [a,q*a+p*b,q2*a+2*p*q*b+p2*c,q2*q*a+3*q2*p*b+3*q*p2*c+p2*p*d];
  }
}

function _bez3x(p,s,c,x,y,x1,y1,x2,y2,r,m) {
  if(c) {
    if(s) x=x1,y=y1,x1=x2,y1=y2;
    if(m) p.push('m',x,y);
    p.push('l',x1,y1);
  } else {
    var r1=1-r,xa,ya;
    xa=_bezsplit(0.5,s,x,r1*x1+r*x,r1*x1+r*x2,x2),ya=_bezsplit(0.5,s,y,r1*y1+r*y,r1*y1+r*y2,y2);
    if(m) p.push('m',xa[0],ya[0]);
    p.push('c',xa[1],ya[1],xa[2],ya[2],xa[3],ya[3]);
  }
}

function _bez3(s,c,x,y,x1,y1,x2,y2,r,m) {
  if(c) {
    if(s) x=x1,y=y1,x1=x2,y1=y2;
    if(m) ctx.moveTo(x,y);
    ctx.lineTo(x1,y1);
  } else {
    var r1=1-r,xa,ya;
    xa=_bezsplit(0.5,s,x,r1*x1+r*x,r1*x1+r*x2,x2),ya=_bezsplit(0.5,s,y,r1*y1+r*y,r1*y1+r*y2,y2);
    if(m) ctx.moveTo(xa[0],ya[0]);
    ctx.bezierCurveTo(xa[1],ya[1],xa[2],ya[2],xa[3],ya[3]);
  }
}

function _bezbound(a,b,c,d) {
  var aa=3*(-a+3*b-3*c+d),bb=6*(a-2*b+c),cc=3*(b-a),dd=bb*bb-4*aa*cc,mi,ma,p,q,e;
  if(a<d) mi=a,ma=d;else mi=d,ma=a;
  if(dd>=0) {
    dd=Math.sqrt(dd);
    p=(-bb+dd)/aa/2;
    if(p>0&&p<1) {q=1-p,e=q*q*(q*a+3*p*b)+p*p*(3*q*c+p*d);if(e<mi) mi=e;else if(e>ma) ma=e;}
    p=(-bb-dd)/aa/2;
    if(p>0&&p<1) {q=1-p,e=q*q*(q*a+3*p*b)+p*p*(3*q*c+p*d);if(e<mi) mi=e;else if(e>ma) ma=e;}
  }
  return [mi,ma];
}

function _borderedge(e,xy2) {
 var m,i;
 e=e|rol(xy2.length>>1,e,-1);
 for(m=1,i=0;i<xy2.length;i+=2,m<<=1) 
   if(e&m)
     _circle(4,xy2[i],xy2[i+1],1);
}

function _corn(m,e,n,xy2,b) {
  var a,c,i,i2,n2=n>>1,x3,y3,x2=xy2[n-4],y2=xy2[n-3],x=xy2[n-2],y=xy2[n-1],dx,dy,ex,ey;
  for(i=0,i2=n2-2;i<xy2.length;i+=2,i2=(i2+1)%n2) {
    x3=x2,y3=y2,x2=x,y2=y,x=xy2[i],y=xy2[i+1];
    if(b&&!b[i2]&&!b[(i2+1)%n2]) continue;
    dx=x-x2,dy=y-y2,ex=x3-x2,ey=y3-y2;
    if(Math.abs(dx*ey-dy*ex)<1) continue;
    if(m==2) {
      a=Math.atan2(ey,ex),c=Math.atan2(dy,dx);
      ctx.beginPath();
      ctx.moveTo(x2,y2);
      ctx.arc(x2,y2,e,c,a);
      ctx.fill();
    } else {
      a=Math.sqrt(_sqr(ex,ey));
      c=Math.sqrt(_sqr(dx,dy));
      ctx.beginPath();
      ctx.moveTo(x2,y2);
      ctx.lineTo(x2+e*(x3-x2)/a,y2+e*(y3-y2)/a);
      ctx.lineTo(x2+e*(x-x2)/c,y2+e*(y-y2)/c);
      ctx.fill();
    }
  }
}

function _drawborder(x,y) {
  var sx=brd+x*cell,sy=brd+y*cell,c2=cell/2,e=_getblock(x,y),o;
  if(rou) {
    var c2=cell/2,cx=sx+c2,cy=sy+c2,b=[_brd(x-1,y),_brd(x,y-1),_brd(x+1,y),_brd(x,y+1)];
    if(!b[0]) {
      if(b[1]) _rline(sx,sy,0,c2+1);else _arc(cx,cy,c2,180,90);
      if(b[3]) _rline(sx,sy+c2,0,c2);else _arc(cx,cy,c2,90,90);
    } else {
      if(!b[1]) _rline(sx,sy,c2,0);
      if(!b[3]) _rline(sx,sy+cell,c2+1,0);
    }
    if(!b[2]) {
      if(b[1]) _rline(sx+cell,sy,0,c2);else _arc(cx,cy,c2,270,90);
      if(b[3]) _rline(sx+cell,sy+c2-1,0,c2+1);else _arc(cx,cy,c2,0,90);
    } else {
      if(!b[1]) _rline(sx+c2-1,sy,c2+1,0);
      if(!b[3]) _rline(sx+c2,sy+cell,c2,0);
    }
    if(corn) o=[_brd(x,y-1),_brd(x+1,y),_brd(x,y+1),_brd(x-1,y)];
  } else {
    if(!_xo(board[y][x-1])) _line(sx,sy,sx,sy+cell);
    if(!_xo(board[y-1][x])) _line(sx,sy,sx+cell,sy);
    if(!_xo(board[y][x+1])) _line(sx+cell,sy,sx+cell,sy+cell);
    if(!_xo(board[y+1][x])) _line(sx,sy+cell,sx+cell,sy+cell);
  }
  if(corn) _corn(corn,3,8,[sx,sy,sx+cell,sy,sx+cell,sy+cell,sx,sy+cell],o);
  if(e) {
    ctx.lineWidth=edgew;
    if(e&1) _line(sx+1,sy,sx+1,sy+cell);
    if(e&2) _line(sx,sy,sx+cell,sy);
    if(e&4) _line(sx+cell-1,sy,sx+cell-1,sy+cell);
    if(e&8) _line(sx,sy+cell-1,sx+cell,sy+cell-1);
    _borderedge(e,[sx,sy,sx+cell,sy,sx+cell,sy+cell,sx,sy+cell]);
  }
}

function _border16(x,y) {
  var dx=y&1?0:-1;
  return [-1,0,dx,-1,dx+1,-1,1,0,dx+1,1,dx,1];
}
function _drawborder16(x,y) {
  var xy=_points16(x,y),b=_border16(x,y),i,i2,e=_getblock(x,y),o;
  if(rou) {
    var i1,a,cx=(xy[0]+xy[6])/2,cy=(xy[1]+xy[7])/2,r=Math.sqrt(_sqr((xy[0]+xy[2])/2-cx,(xy[1]+xy[3])/2-cy));
    o=[];for(i1=i=0;i<12;i1++,i+=2) o[i1]=_brd(x+b[i],y+b[i+1]);
    o.push(o[0]);o.shift();
    o.push(o[0]);
    xy.push(xy[0],xy[1],xy[2],xy[3]);
    for(i1=i=0;i<12;i1++,i+=2) {
      if(!o[i1]&&!o[i1+1]) a=i*30-120,_arc(cx,cy,r,a,60);
      else if(!o[i1]) _line((xy[i]+xy[i+2])/2,(xy[i+1]+xy[i+3])/2,xy[i+2],xy[i+3]);
      else if(!o[i1+1]) _line((xy[i+2]+xy[i+4])/2,(xy[i+3]+xy[i+5])/2,xy[i+2],xy[i+3]);
    }
  } else
    for(i=0,i2=10;i<12;i2=i,i+=2)
      if(!_xo(board[y+b[i+1]][x+b[i]])) _line(xy[i],xy[i+1],xy[i2],xy[i2+1]);
  if(corn) _corn(corn,3,12,xy,o);
  if(e) {
    xy.splice(12);
    var i,i2,i3,xy2=xy.slice();
    _polyex2(xy,15/16,0,0);
    for(i=0,i2=10;i<6;i++,i2=(i2+2)%12) if(e&(1<<i)) {
      i3=(i2+2)%12;
      _line(xy[i2],xy[i2+1],xy[i3],xy[i3+1]);
      //_circle2(1,xy[i2],xy[i2+1],xy[i3],xy[i3+1]);
    }
    _borderedge(e,xy2);
  }
}
/*function _drawborder6old(x,y) {
  var xy=_points16(x,y),dx=y&1?0:-1;
  if(!_xo(board[y][x-1])) _line(xy[0],xy[1],xy[10],xy[11]);
  if(!_xo(board[y-1][x+dx])) _line(xy[0],xy[1],xy[2],xy[3]);
  if(!_xo(board[y-1][x+dx+1])) _line(xy[2],xy[3],xy[4],xy[5]);
  if(!_xo(board[y][x+1])) _line(xy[4],xy[5],xy[6],xy[7]);
  if(!_xo(board[y+1][x+dx+1])) _line(xy[6],xy[7],xy[8],xy[9]);
  if(!_xo(board[y+1][x+dx])) _line(xy[8],xy[9],xy[10],xy[11]);
}*/

function _drawborder3(x,y) {
  _drawborder3x(x,y,_points3,_border3);
}
function _drawborder3x(x,y,points,border) {
  var xy=points(x,y),b=border(x,y),d=1^(y&1)^(x&1),dy=d?-1:1,i,j,e=_getblock(x,y),o;
  if(rou) {
    var i2,i1,a,cx=(xy[0]+xy[4])/2,cy=(xy[1]+xy[5])/2,r=Math.sqrt(_sqr((xy[0]+xy[2])/2-cx,(xy[1]+xy[3])/2-cy));
    o=[];for(i1=i=0;i<6;i1++,i+=2) o[i1]=_brd(x+b[i],y+b[i+1]);
    o.push(o[0]);o.shift();
    o.push(o[0]);
    xy.push(xy[0],xy[1],xy[2],xy[3]);
    for(i1=i=0;i<6;i1++,i+=2) {
      if(!o[i1]&&!o[i1+1]) {
        if(tria) i2=i+4,_arc((xy[i2]+xy[i]+xy[i+2])/3,(xy[i2+1]+xy[i+1]+xy[i+3])/3,cell3y/3,d?i*60+210:i*60+30,120);
        else _bez((xy[i]+xy[i+2])/2,(xy[i+1]+xy[i+3])/2,xy[i+2],xy[i+3],(xy[i+2]+xy[i+4])/2,(xy[i+3]+xy[i+5])/2,0.125);
      } else if(!o[i1]) _line((xy[i]+xy[i+2])/2,(xy[i+1]+xy[i+3])/2,xy[i+2],xy[i+3]);
      else if(!o[i1+1]) _line((xy[i+2]+xy[i+4])/2,(xy[i+3]+xy[i+5])/2,xy[i+2],xy[i+3]);
    }
  } else
    for(i=0,i2=4;i<6;i2=i,i+=2)
      if(!_xo(board[y+b[i+1]][x+b[i]])) _line(xy[i],xy[i+1],xy[i2],xy[i2+1]);
  if(corn) _corn(corn,3,6,xy,o);
  if(e) {
    xy.splice(6);
    var i,i2,i3,xy2=xy.slice();
    _polyex2(xy,15/16,0,0);
    ctx.lineWidth=edgew;
    for(i=0,i2=4;i<3;i++,i2=(i2+2)%6) if(e&(1<<i)) {
      i3=(i2+2)%6;
      _line(xy[i2],xy[i2+1],xy[i3],xy[i3+1]);
      //_circle2(1,xy[i2],xy[i2+1],xy[i3],xy[i3+1]);
    }
    _borderedge(e,xy2);
  }
}

function _drawborder2(x,y) {
  _drawborder3x(x,y,_points2,_border2);
}

function _drawborder2x(x,y) {
  var xy=_points2(x,y),dy=0^(y&1)^(x&1)^(((x+1)>>1)&1)?+1:-1,d,p1,p2,xx=(x+1+2*(y&1))&3,e=_getblock(x,y);
  if(!_xo(board[y][x-1])) p1=xx==0?4:xx==1?2:xx==2?0:2,p2=(p1+2)%6,_line(xy[p1],xy[p1+1],xy[p2],xy[p2+1]);
  if(!_xo(board[y][x+1])) p1=xx==0?2:xx==1?4:xx==2?2:0,p2=(p1+2)%6,_line(xy[p1],xy[p1+1],xy[p2],xy[p2+1]);
  if(!_xo(board[y-dy][x])) p1=xx==2?4:xx==3?4:0,p2=(p1+2)%6,_line(xy[p1],xy[p1+1],xy[p2],xy[p2+1]);
  if(e) {
    xy.splice(6);
    var i,i2,i3,xy2=xy.slice();
    _polyex2(xy,15/16,0,0);
    ctx.lineWidth=edgew;
    for(i=0,i2=4;i<3;i++,i2=(i2+2)%6) if(e&(1<<i)) {
      i3=(i2+2)%6;
      _line(xy[i2],xy[i2+1],xy[i3],xy[i3+1]);
      //_circle2(1,xy[i2],xy[i2+1],xy[i3],xy[i3+1]);
    }
    _borderedge(e,xy2);
  }
}

function _drawborder5(x,y) {
  var xy=_points5(x,y),b=_border5(x,y),r=(((y+1)&1)<<1)|((x+1)&1),d,p1,p2,e=_getblock(x,y),o;
  if(rou) {
    var i1,a,cx=(xy[0]+xy[6])/2,cy=(xy[1]+xy[7])/2,r=Math.sqrt(_sqr((xy[0]+xy[2])/2-cx,(xy[1]+xy[3])/2-cy)),o=[];
    o=[];for(i1=i=0;i<6;i1++,i+=2) o[i1]=_brd(x+b[i],y+b[i+1]);
    o.push(o[0]);o.shift();
    o.push(o[0]);
    xy.push(xy[0],xy[1],xy[2],xy[3]);
    for(i1=i=0;i<6;i1++,i+=2) {
      if(!o[i1]&&!o[i1+1]) _bez((xy[i]+xy[i+2])/2,(xy[i+1]+xy[i+3])/2,xy[i+2],xy[i+3],(xy[i+2]+xy[i+4])/2,(xy[i+3]+xy[i+5])/2,0.125);
      else if(!o[i1]) _line((xy[i]+xy[i+2])/2,(xy[i+1]+xy[i+3])/2,xy[i+2],xy[i+3]);
      else if(!o[i1+1]) _line((xy[i+2]+xy[i+4])/2,(xy[i+3]+xy[i+5])/2,xy[i+2],xy[i+3]);
    }
  } else
    for(i=0,i2=4;i<6;i2=i,i+=2)
      if(!_xo(board[y+b[i+1]][x+b[i]])) _line(xy[i],xy[i+1],xy[i2],xy[i2+1]);
  if(corn) _corn(corn,3,6,xy,o);
  if(e) {
    xy.splice(6);
    var i,i2,i3,xy2=xy.slice();
    _polyex2(xy,15/16,0,0);
    ctx.lineWidth=edgew;
    for(i=0,i2=4;i<3;i++,i2=(i2+2)%6) if(e&(1<<i)) {
      i3=(i2+2)%6;
      _line(xy[i2],xy[i2+1],xy[i3],xy[i3+1]);
      //_circle2(1,xy[i2],xy[i2+1],xy[i3],xy[i3+1]);
    }
    _borderedge(e,xy2);
  }
}

function _drawborder15(x,y) {
  var xy=_points15(x,y),b=_border15(x,y),i,i2,e=_getblock(x,y),o;
  if(rou) {
    var i1,a,cx=(xy[0]+xy[6])/2,cy=(xy[1]+xy[7])/2,r=Math.sqrt(_sqr((xy[0]+xy[2])/2-cx,(xy[1]+xy[3])/2-cy));
    o=[];for(i1=i=0;i<10;i1++,i+=2) o[i1]=_brd(x+b[i],y+b[i+1]);
    o.push(o[0]);o.shift();
    o.push(o[0]);
    xy.push(xy[0],xy[1],xy[2],xy[3]);
    for(i1=i=0;i<10;i1++,i+=2) {
      if(!o[i1]&&!o[i1+1]) _bez((xy[i]+xy[i+2])/2,(xy[i+1]+xy[i+3])/2,xy[i+2],xy[i+3],(xy[i+2]+xy[i+4])/2,(xy[i+3]+xy[i+5])/2,0.125);
      else if(!o[i1]) _line((xy[i]+xy[i+2])/2,(xy[i+1]+xy[i+3])/2,xy[i+2],xy[i+3]);
      else if(!o[i1+1]) _line((xy[i+2]+xy[i+4])/2,(xy[i+3]+xy[i+5])/2,xy[i+2],xy[i+3]);
    }
  } else
    for(i=0,i2=8;i<10;i2=i,i+=2)
      if(!_xo(board[y+b[i+1]][x+b[i]])) _line(xy[i],xy[i+1],xy[i2],xy[i2+1]);
  if(corn) _corn(corn,3,10,xy,o);
  if(e) {
    xy.splice(10);
    var i,i2,i3,xy2=xy.slice();
    _polyex2(xy,15/16,0,0);
    ctx.lineWidth=edgew;
    for(i=0,i2=8;i<5;i++,i2=(i2+2)%10) if(e&(1<<i)) {
      i3=(i2+2)%10;
      _line(xy[i2],xy[i2+1],xy[i3],xy[i3+1]);
      //_circle2(1,xy[i2],xy[i2+1],xy[i3],xy[i3+1]);
    }
    _borderedge(e,xy2);
  }
}

function _drawborder8(x,y) {
  var xy=_points8(x,y),b=_border8(x,y),i,i2,e=_getblock(x,y),o;
  if(rou) {
    var i1,a,cx=(xy[0]+xy[4])/2,cy=(xy[1]+xy[5])/2,r=Math.sqrt(_sqr((xy[0]+xy[2])/2-cx,(xy[1]+xy[3])/2-cy));
    o=[];for(i1=i=0;i<8;i1++,i+=2) o[i1]=_brd(x+b[i],y+b[i+1]);
    o.push(o[0]);o.shift();
    o.push(o[0]);
    xy.push(xy[0],xy[1],xy[2],xy[3]);
    for(i1=i=0;i<8;i1++,i+=2) {
      if(!o[i1]&&!o[i1+1]) _bez((xy[i]+xy[i+2])/2,(xy[i+1]+xy[i+3])/2,xy[i+2],xy[i+3],(xy[i+2]+xy[i+4])/2,(xy[i+3]+xy[i+5])/2,0.125);
      else if(!o[i1]) _line((xy[i]+xy[i+2])/2,(xy[i+1]+xy[i+3])/2,xy[i+2],xy[i+3]);
      else if(!o[i1+1]) _line((xy[i+2]+xy[i+4])/2,(xy[i+3]+xy[i+5])/2,xy[i+2],xy[i+3]);
    }
  } else
    for(i=0,i2=6;i<8;i2=i,i+=2)
      if(!_xo(board[y+b[i+1]][x+b[i]])) _line(xy[i],xy[i+1],xy[i2],xy[i2+1]);
  if(corn) _corn(corn,3,8,xy,o);
  if(e) {
    xy.splice(8);
    var i,i2,i3,xy2=xy.slice();
    _polyex2(xy,15/16,0,0);
    ctx.lineWidth=edgew;
    for(i=0,i2=6;i<4;i++,i2=(i2+2)%8) if(e&(1<<i)) {
      i3=(i2+2)%8;
      _line(xy[i2],xy[i2+1],xy[i3],xy[i3+1]);
      //_circle2(1,xy[i2],xy[i2+1],xy[i3],xy[i3+1]);
    }
    _borderedge(e,xy2);
  }
}

function _drawborder7(x,y) {
  var xy=_points7(x,y),b=_border7(x,y),i,i2,e=_getblock(x,y),o;
  if(rou) {
    var i1,a,cx=(xy[0]+xy[4])/2,cy=(xy[1]+xy[5])/2,r=Math.sqrt(_sqr((xy[0]+xy[2])/2-cx,(xy[1]+xy[3])/2-cy));
    o=[];for(i1=i=0;i<12;i1++,i+=2) o[i1]=_brd(x+b[i],y+b[i+1]);
    o.push(o[0]);o.shift();
    o.push(o[0]);
    xy.push(xy[0],xy[1],xy[2],xy[3]);
    for(i1=i=0;i<12;i1++,i+=2) {
      if(!o[i1]&&!o[i1+1]) _bez((xy[i]+xy[i+2])/2,(xy[i+1]+xy[i+3])/2,xy[i+2],xy[i+3],(xy[i+2]+xy[i+4])/2,(xy[i+3]+xy[i+5])/2,0.125);
      else if(!o[i1]) _line((xy[i]+xy[i+2])/2,(xy[i+1]+xy[i+3])/2,xy[i+2],xy[i+3]);
      else if(!o[i1+1]) _line((xy[i+2]+xy[i+4])/2,(xy[i+3]+xy[i+5])/2,xy[i+2],xy[i+3]);
    }
  } else
    for(i=0,i2=10;i<12;i2=i,i+=2)
      if(!_xo(board[y+b[i+1]][x+b[i]])) _line(xy[i],xy[i+1],xy[i2],xy[i2+1]);
  if(corn) _corn(corn,3,12,xy,o);
  if(e) {
    xy.splice(12);
    var i,i2,i3,xy2=xy.slice();
    _polyex2(xy,15/16,0,0);
    ctx.lineWidth=edgew;
    for(i=0,i2=10;i<6;i++,i2=(i2+2)%12) if(e&(1<<i)) {
      i3=(i2+2)%12;
      _line(xy[i2],xy[i2+1],xy[i3],xy[i3+1]);
      //_circle2(1,xy[i2],xy[i2+1],xy[i3],xy[i3+1]);
    }
    _borderedge(e,xy2);
  }
}


function _drawborder9(x,y) {
  var xy=_points9(x,y),b=_border9(x,y),i,i2,e=_getblock(x,y),o;
  if(rou) {
    var i1,a,cx=(xy[0]+xy[4])/2,cy=(xy[1]+xy[5])/2,r=Math.sqrt(_sqr((xy[0]+xy[2])/2-cx,(xy[1]+xy[3])/2-cy));
    o=[];for(i1=i=0;i<8;i1++,i+=2) o[i1]=_brd(x+b[i],y+b[i+1]);
    o.push(o[0]);o.shift();
    o.push(o[0]);
    xy.push(xy[0],xy[1],xy[2],xy[3]);
    for(i1=i=0;i<8;i1++,i+=2) {
      if(!o[i1]&&!o[i1+1]) _bez((xy[i]+xy[i+2])/2,(xy[i+1]+xy[i+3])/2,xy[i+2],xy[i+3],(xy[i+2]+xy[i+4])/2,(xy[i+3]+xy[i+5])/2,0.125);
      else if(!o[i1]) _line((xy[i]+xy[i+2])/2,(xy[i+1]+xy[i+3])/2,xy[i+2],xy[i+3]);
      else if(!o[i1+1]) _line((xy[i+2]+xy[i+4])/2,(xy[i+3]+xy[i+5])/2,xy[i+2],xy[i+3]);
    }
  } else
    for(i=0,i2=6;i<8;i2=i,i+=2)
      if(!_xo(board[y+b[i+1]][x+b[i]])) _line(xy[i],xy[i+1],xy[i2],xy[i2+1]);
  if(corn) _corn(corn,3,8,xy,o);
  if(e) {
    xy.splice(8);
    var i,i2,i3,xy2=xy.slice();
    _polyex2(xy,15/16,0,0);
    ctx.lineWidth=edgew;
    for(i=0,i2=6;i<4;i++,i2=(i2+2)%8) if(e&(1<<i)) {
      i3=(i2+2)%8;
      _line(xy[i2],xy[i2+1],xy[i3],xy[i3+1]);
      //_circle2(1,xy[i2],xy[i2+1],xy[i3],xy[i3+1]);
    }
    _borderedge(e,xy2);
  }
}

function _drawborder11(x,y) {
  var xy=_points11(x,y),b=_border11(x,y),i,i2,e=_getblock(x,y),o;
  if(rou) {
    var i1,a,cx=(xy[0]+xy[4])/2,cy=(xy[1]+xy[5])/2,r=Math.sqrt(_sqr((xy[0]+xy[2])/2-cx,(xy[1]+xy[3])/2-cy));
    o=[];for(i1=i=0;i<8;i1++,i+=2) o[i1]=_brd(x+b[i],y+b[i+1]);
    o.push(o[0]);o.shift();
    o.push(o[0]);
    xy.push(xy[0],xy[1],xy[2],xy[3]);
    for(i1=i=0;i<8;i1++,i+=2) {
      if(!o[i1]&&!o[i1+1]) _bez((xy[i]+xy[i+2])/2,(xy[i+1]+xy[i+3])/2,xy[i+2],xy[i+3],(xy[i+2]+xy[i+4])/2,(xy[i+3]+xy[i+5])/2,0.125);
      else if(!o[i1]) _line((xy[i]+xy[i+2])/2,(xy[i+1]+xy[i+3])/2,xy[i+2],xy[i+3]);
      else if(!o[i1+1]) _line((xy[i+2]+xy[i+4])/2,(xy[i+3]+xy[i+5])/2,xy[i+2],xy[i+3]);
    }
  } else
    for(i=0,i2=6;i<8;i2=i,i+=2)
      if(!_xo(board[y+b[i+1]][x+b[i]])) _line(xy[i],xy[i+1],xy[i2],xy[i2+1]);
  if(corn) _corn(corn,3,8,xy,o);
  if(e) {
    xy.splice(8);
    var i,i2,i3,xy2=xy.slice();
    _polyex2(xy,15/16,0,0);
    ctx.lineWidth=edgew;
    for(i=0,i2=6;i<4;i++,i2=(i2+2)%8) if(e&(1<<i)) {
      i3=(i2+2)%8;
      _line(xy[i2],xy[i2+1],xy[i3],xy[i3+1]);
    }
    _borderedge(e,xy2);
  }
}


function _drawboard() {
  var n,m,b,x,xe,y,c,nx=board[0].length-1,ny=board.length-1,w,ms=+new Date(),p=f.peg.checked;
  n=m=0,_clear();
  ctx.strokeStyle='#000';
  if(rou) ctx.lineJoin='round';
  for(y=0;y<ny;y++)
    for(x=0,b=board[y],xe=b.length;x<xe;x++)
      if((c=b[x])!=' ') {
        deca?_drawcell7(x,y):trap?_drawcell11(x,y):delta?_drawcell9(x,y):cubes?_drawcell8(x,y):penta?_drawcell15(x,y):tria4?_drawcell5(x,y):tria2?_drawcell2(x,y):tria?_drawcell3(x,y):hexa?_drawcell16(x,y):_drawcell(x,y);
        if((w=c=='w')||c=='o') {
          n+=onoff?c=='o':c=='o'||w,deca?_drawpeg7(x,y,w,p):trap?_drawpeg11(x,y,w,p):delta?_drawpeg9(x,y,w,p):cubes?_drawpeg8(x,y,w,p):penta?_drawpeg15(x,y,w,p):tria4?_drawpeg5(x,y,w,p):tria2?_drawpeg2(x,y,w,p):tria?_drawpeg3(x,y,w,p):hexa?_drawpeg16(x,y,w,p):_drawpeg(x,y,w,p);
          m+=onoff?c=='o':+_can(x,y,0,1)+_can(x,y,0,-1)+_can(x,y,1,0)+_can(x,y,-1,0)+(diag?_can(x,y,1,-1)+_can(x,y,1,1)+_can(x,y,-1,-1)+_can(x,y,-1,1):0);
        }
      }
  ctx.lineWidth=2;
  ctx.fillStyle='#000';
  for(y=1;y<ny;y++)
    for(x=1;x<nx;x++)
      if((b=board[y])&&(c=b[x])&&c!=' ') 
        deca?_drawborder7(x,y):trap?_drawborder11(x,y):delta?_drawborder9(x,y):cubes?_drawborder8(x,y):penta?_drawborder15(x,y):tria4?_drawborder5(x,y):tria2?_drawborder2(x,y):tria?_drawborder3(x,y):hexa?_drawborder16(x,y):_drawborder(x,y);
  _pegs(n);
  for(n=0;n<sele.length;n+=2)
    _drawsele(sele[n],sele[n+1]);
  drawms=(drawt=+new Date())-ms;
}

function _svgx(x) { return Math.round(x*1000)/1000; }
function _svgline(w,x,y,x2,y2) {
  return '<line x1="'+x+'" y1="'+y+'" x2="'+x2+'" y2="'+y2+'" style="stroke:#000;stroke-width:'+w+';" />\r\n';
}

function _svgcircle(w,c,r,x,y) {
  return '<circle cx="'+x+'" cy="'+y+'" r="'+r+'" style="fill:'+c+';stroke:#000;stroke-width:'+w+';" />\r\n';
}

function _svgpoly(w,c,xy,gn) {
  var s='',i,s1='';
  for(i=0;i<xy.length;i+=2)
    s+=(s?' ':'')+xy[i]+','+xy[i+1];
  if(gn) {
    var rp=_radial_xy(xy),s1=svgg[gn]='<defs>'+_svg_radialp(gn,c,rp[0],rp[1],rp[2],1)+'</defs>\r\n';
    c='url(#'+gn+')';
  }
  return s1+'<polygon points="'+s+'" style="fill:'+c+';stroke:#000;stroke-width:'+w+';" />\r\n';
}

function _svggpoly(px,py,w,c,xy,b,m) {
  var s='',s2='',s3,k='1',gn,rr=quad?Math.sqrt(2)/3:hexa?Math.sqrt(3)/3:tria?Math.sqrt(2)/3:0.125,l=xy.length;
  var i,i1,g,x=xy[xy.length-2],y=xy[xy.length-1],x2,y2,x1,y1,xy2,sx,sy,d,lx,ly,nx=(xy[0]+xy[l-2])/2,ny=(xy[1]+xy[l-1])/2,mx,my,rx,ry;
  i=_polyc(xy),sx=i[0],sy=i[1];
  if(b) b.push(b[0],b[1]);
  for(i=i1=0;i<xy.length;i1++,i+=2) {
    x2=x,y2=y,x=xy[i],y=xy[i+1],mx=xy[(i+2)%xy.length],my=xy[(i+3)%xy.length];
    lx=nx,ly=ny,nx=(xy[i]+mx)/2,ny=(xy[i+1]+my)/2;
    gn=''+px+'_'+py+'_'+i1;
    rx=m?nx:x,ry=m?ny:y,s+=svgg[gn]='<defs>'+_svg_radialp(gn,0,rx,ry,Math.sqrt(_sqr(rx-sx,ry-sy)),1,c)+'</defs>\r\n';
    if(m) {
      var px=xy[(i+4)%l],py=xy[(i+5)%l],p=[];
      if(!b||((b[i1]||b[i1+1])&&(b[i1+1]||b[i1+2]))) {
        p.push('m',x,y,'l',mx,my);
      } else {
        _bez3x(p,1,!b||b[i1]||b[i1+1],lx,ly,x,y,nx,ny,rr,1);
        _bez3x(p,0,!b||b[i1+1]||b[i1+2],nx,ny,mx,my,(mx+px)/2,(my+py)/2,rr);
      }
      p.push('l',sx,sy);
      d=_svg_pathx(p);
      s+='<path d="'+d+' Z" style="fill:url(#'+gn+');stroke:none;" />\r\n';
    }
    xy2=[lx,ly,x,y,nx,ny,sx,sy];
    if(!s2) s2='M'+lx+','+ly;
    if(!b||b[i1]||b[i1+1]) {
      if(!m) s+=_svgpoly(0,'url(#'+gn+')',xy2);
      s2+=' L'+x+','+y+' L'+nx+','+ny;
    } else {
      d='M'+lx+','+ly+' '+(s3=_svg_bez2(0,lx,ly,x,y,nx,ny,rr))+' L'+sx+','+sy;
      if(!m) s+='<path d="'+d+' Z" style="fill:url(#'+gn+');stroke:none;" />\r\n';
      s2+=s3;
    }
  }
  if(w) {
    if(s3) s+='<path d="'+s2+'" style="fill:none;stroke:#000;stroke-width:'+w+'" />\r\n';
    else s+=_svgpoly(w,'none',xy);
  }
  return s;
}

function _svg_arc(w,x,y,x2,y2,r) { 
  return '<path d="M'+x+','+y+' A'+r+','+r+' 0 0 1 '+x2+','+y2+'" style="fill:none;stroke:#000;stroke-width:'+w+';" />\r\n';
}

function _svg_arcf(x,y,x2,y2,r,sx,sy) { 
  return '<path d="M'+sx+','+sy+' L'+x+','+y+' A'+r+','+r+' 0 0 0 '+x2+','+y2+' Z" style="fill:#000;stroke:none;" />\r\n';
}

function _svg_arc2(c,x,y,x1,y1,x2,y2,r) { 
  if(c) return ' L'+x1+','+y1+' L'+x2+','+y2;
  else {
   return ' A'+r+','+r+' '+' 0 0 1 '+x2+','+y2;
  }
}

function _svg_bez(w,x,y,x1,y1,x2,y2,r,sx,sy) { 
  var r1=1-r;
  return '<path d="M'+x+','+y+' C'+(r1*x1+r*x)+','+(r1*y1+r*y)+' '+(r1*x1+r*x2)+','+(r1*y1+r*y2)+' '+x2+','+y2+'" style="fill:none;stroke:#000;stroke-width:'+w+';" />\r\n';
}

function _svg_bez2(c,x,y,x1,y1,x2,y2,r) { 
  if(c) return ' L'+x1+','+y1+' L'+x2+','+y2;
  else {
   var r1=1-r;
   return ' C'+(r1*x1+r*x)+','+(r1*y1+r*y)+' '+(r1*x1+r*x2)+','+(r1*y1+r*y2)+' '+x2+','+y2;
  }
}

function _svg_pathx(r) { 
  var i,s='',ch;
  for(i=0;i<r.length;)
    switch(r[i++]) {
     case 'm': s+=' M'+r[i]+','+r[i+1],i+=2;break;
     case 'l': s+=' L'+r[i]+','+r[i+1],i+=2;break;
     case 'c': s+=' C'+r[i]+','+r[i+1]+' '+r[i+2]+','+r[i+3]+' '+r[i+4]+','+r[i+5],i+=6;break;
    }
  return s;
}


function _svg_path(w,c,xy,o,rr) {
  var s,i,i1,lx,ly,nx,ny,f2=quad||hexa||tria?_svg_arc2:_svg_bez2;
  o.push(o[0]);xy.push(xy[0],xy[1]);
  nx=(xy[0]+xy[xy.length-4])/2,ny=(xy[1]+xy[xy.length-3])/2;
  s='M'+nx+','+ny;
  for(i1=i=0;i+2<xy.length;i1++,i+=2)
    lx=nx,ly=ny,s+=f2(o[i1]||o[i1+1],lx,ly,xy[i],xy[i+1],nx=(xy[i]+xy[i+2])/2,ny=(xy[i+1]+xy[i+3])/2,rr);
  s='<path d="'+s+' Z" style="fill:'+c+';stroke:#000;stroke-width:'+w+';" />\r\n';
  return s;
}

function _svg_linear(n,c,dx,dy) {
  var s,a=0|(Math.atan2(dy,dx)*180/Math.PI);
  s='<linearGradient id="'+n+'" gradientTransform="rotate('+a+')">\r\n';
  s+='<stop offset="0%" stop-color="#fff" />\r\n'
  s+='<stop offset="100%" stop-color="'+c+'" />\r\n';
  s+='</linearGradient>\r\n';
  return s;
}

function _svg_radialp(n,c,x,y,r,np,c2) {
  var p=np?'':'%',s='<radialGradient id="'+n+'" cx="'+_svgx(x)+p+'" cy="'+_svgx(y)+p+'" r="'+_svgx(r)+p+'"'+(np?' gradientUnits="userSpaceOnUse"':'')+' >\r\n';
  s+='<stop offset="0%" stop-color="'+(c2?c2:'#fff')+'" />\r\n'
  s+='<stop offset="100%" stop-color="'+(c?c:'#fff')+'" />\r\n';
  s+='</radialGradient>\r\n';
  return s;
}
function _svg_radial(n,c,dx,dy) {
  var s,a=Math.atan2(dy,dx),x=Math.cos(a),y=Math.sin(a),e,f,r;
  e=Math.abs(x),f=Math.abs(y);
  if(e<f) e=f;
  //x/=e,y/=e;
  if(grdm==3) x=y=r=50;
  else x=Math.round(50*(1-x)),y=Math.round(50*(1-y)),r=100;
  s+=_svg_radialp(n,c,x,y,r);
  return s;
}
function _svg_radialxy(n,c,x,y) {
  var i,r,xy=_points(x,y),p=_peg(x,y),sx=p[0],sy=p[1],ix,iy,ax=ix=xy[0],iy,ay=iy=xy[1],f=0,m=_sqr(ax-sx,ay-sy),dx,dy;
  for(i=2;i<xy.length;i+=2) {
    if((r=xy[i])<ix) ix=r;else if(r>ax) ax=r; 
    if((r=xy[i+1])<iy) iy=r;else if(r>ay) ay=r; 
    if((r=_sqr(ax-sx,ay-sy))) f=i,m=r;
  }
  dx=ax-ix,dy=ay-iy,cx=(sx-ix)*100/dx,cy=(sy-iy)*100/dy,r=Math.sqrt(r);//*100/(ax-ix);
  return _svg_radialp(n,c,sx,sy,r,1);
}

function _t11(x,y) { var d=(x+1)%2,cx=(x+1)>>1,dd=(cx+2*(y&1))%3+3*d; return dd; }
var svgg={};
function _svgcell(x,y,rr) {
  var s='',c=_color(x,y);
  if(grdm) { 
   if(c=='#fff') c=clr2[1];
   if(grdm<5) {
   var gn=c.replace('#','x'),t,g;
   if(grdm==3) {
     //t=tria2||tria4?(x&1)+2*(y&1):_t11(x,y);
     t=''+x+'_'+y,gn+='_'+t,g=svgg[gn];
     if(!g) s+=svgg[gn]='<defs>'+_svg_radialxy(gn,c,x,y)+'</defs>\r\n';
   } else {
     g=svgg[gn];
     if(!g) s+=svgg[gn]='<defs>'+(grdm>1?_svg_radial:_svg_linear)(gn,c,grdx,grdy)+'</defs>\r\n';
   }
   c='url(#'+gn+')';
  }}
  if(quad&&!rou&&grdm<5) {
    var sx=brd+x*cell,sy=brd+y*cell;
    s+='<rect x="'+sx+'" y="'+sy+'" width="'+cell+'" height="'+cell+'" style="fill:'+c+';stroke:#000;stroke-width:0.5;" />\r\n';
  } else {
    var xy=_points(x,y);
    if(rou) {
      var i,i1,o=[],lx,ly,nx,ny,r=[],r=_border(x,y),s2='';
      for(i1=i=0;i<xy.length;i1++,i+=2) o[i1]=_brd(x+r[i],y+r[i+1]);
      if(grdm>=5) s+=_svggpoly(x,y,0.5,c,xy,o,grdm>5);
      else s+=_svg_path(0.5,c,xy,o,rr);
    } else {
      if(grdm>=5) s+=_svggpoly(x,y,0.5,c,xy,0,grdm>5);
      else s+=_svgpoly(0.5,c,xy);
    }
  }
  return s;
}

function _svgcorn(m,e,n,xy2,b) {
  var s,a,c,i,i2,n2=n>>1,x3,y3,x2=xy2[n-4],y2=xy2[n-3],x=xy2[n-2],y=xy2[n-1],dx,dy,ex,ey,p,fx,fy,gx,gy;
  for(i=0,i2=n2-2;i<xy2.length;i+=2,i2=(i2+1)%n2) {
    x3=x2,y3=y2,x2=x,y2=y,x=xy2[i],y=xy2[i+1];
    if(b&&!b[i2]&&!b[(i2+1)%n2]) continue;
    dx=x-x2,dy=y-y2,ex=x3-x2,ey=y3-y2;
    if(Math.abs(dx*ey-dy*ex)<1) continue;
    a=Math.sqrt(_sqr(ex,ey));
    c=Math.sqrt(_sqr(dx,dy));
    fx=x2+e*(x3-x2)/a,fy=y2+e*(y3-y2)/a,gx=x2+e*(x-x2)/c,gy=y2+e*(y-y2)/c;
    if(m==2) {
      s+=_svg_arcf(fx,fy,gx,gy,e,x2,y2);
    } else {
      s+=_svgpoly(0,'#000',[x2,y2,fx,fy,gx,gy]);
    }
  }
  return s;
}

function _svgborder(x,y,rr) {
  var s='',i,xy=_points(x,y),b2,b=_border(x,y),e=_getblock(x,y),n=xy.length,o;
  if(rou) {
    var i1,a;o=[];
    for(i1=i=0;i<xy.length;i1++,i+=2) o[i1]=_brd(x+b[i],y+b[i+1]);
    o.push(o[0]);o.shift();
    o.push(o[0]);
    xy.push(xy[0],xy[1],xy[2],xy[3]);
    for(i1=i=0;i+4<xy.length;i1++,i+=2) {
      if(!o[i1]&&!o[i1+1]) {
         if(quad||hexa||tria) {
           var ar=tria?cell3y/3:hexa?cell6x/2:cell/2;
           s+=_svg_arc(2,(xy[i]+xy[i+2])/2,(xy[i+1]+xy[i+3])/2,(xy[i+2]+xy[i+4])/2,(xy[i+3]+xy[i+5])/2,ar);
         } else s+=_svg_bez(2,(xy[i]+xy[i+2])/2,(xy[i+1]+xy[i+3])/2,xy[i+2],xy[i+3],(xy[i+2]+xy[i+4])/2,(xy[i+3]+xy[i+5])/2,rr);
      } else if(!o[i1]) s+=_svgline(2,(xy[i]+xy[i+2])/2,(xy[i+1]+xy[i+3])/2,xy[i+2],xy[i+3]);
      else if(!o[i1+1]) s+=_svgline(2,(xy[i+2]+xy[i+4])/2,(xy[i+3]+xy[i+5])/2,xy[i+2],xy[i+3]);
    }
  } else
    for(i=0,i2=b.length-2;i<xy.length;i2=i,i+=2) {
      if((b2=board[y+b[i+1]])&&!_xo(b2[x+b[i]])) s+=_svgline(2,xy[i],xy[i+1],xy[i2],xy[i2+1]);
    }
  if(corn) s+=_svgcorn(corn,3,n,xy,o);
  if(e) {
    xy.splice(n);
    var i,m,i2,i3,xy2=xy.slice();
    _polyex2(xy,15/16,0,0);
    for(m=1,i=0,i2=b.length-2;i<xy.length;i2=i,i+=2,m<<=1) 
      if(e&m) 
        s+=_svgline(2,xy[i],xy[i+1],xy[i2],xy[i2+1]);
    e=e|rol(xy2.length>>1,e,-1);
    for(m=1,i=0;i<xy2.length;i+=2,m<<=1) 
      if(e&m)
        s+=_svgcircle(3,'#000',1,xy2[i],xy2[i+1]);
  }
  return s;
}

function _svg() {
  var c,x,y,ey=board.length-1;
  var s='',p=f.peg.checked,rr=tria?cell3y/3:hexa?cell6x/2:quad?cell/2:0.125,rr2=rr>0?rr*0.75:rr;
  svgg={};
  for(y=0;y<ey;y++)
    for(x=0,b=board[y],xe=b.length;x<xe;x++)
      if((c=b[x])>' ') {
        s+=_svgcell(x,y,rr)+'\r\n';
        if(c!='x') {
          var wh=c=='w',pc=_getpgc(x,y),bw=wh?2:1;
          pc=pc?wh?_whi(pc):pc:wh?grdm2?'#ccc':'#fff':'#000';
          if(p) {
            var xy=_polyex2(_points(x,y),0.75);
            if(rou) {
              var i,i1,o=[],r=_border(x,y);
              for(i1=i=0;i<xy.length;i1++,i+=2) o[i1]=_brd(x+r[i],y+r[i+1]);
              if(grdm2) {
                var gn='xp'+x+'_'+y,rp=_radial_xy(xy);
                s+='<defs>'+_svg_radialp(gn,pc,rp[0],rp[1],rp[2],1)+'</defs>\r\n';
                pc='url(#'+gn+')';
              }
              s+=_svg_path(bw,pc,xy,o,rr2);
            } else 
              s+=_svgpoly(bw,pc,xy,grdm2?'xp'+x+'_'+y:0);
          } else {
            var g=_peg(x,y);
            if(grdm2) {
              var gn=pc.replace('#','xp'),gg=svgg[gn];
              if(!gg) s+=svgg[gn]='<defs>'+_svg_radialp(gn,pc,25,25,75)+'</defs>\r\n';
              pc='url(#'+gn+')';
            }
            s+='<circle cx="'+g[0]+'" cy="'+g[1]+'" r="'+g[2]+'" style="fill:'+pc+';stroke:#000;'+(bw!=1?'stroke-width:'+bw+';':'')+'" />\r\n';
          }
      }
    }
  for(y=0;y<ey;y++)
    for(x=0,b=board[y],xe=b.length;x<xe;x++)
      if((c=b[x])>' ') s+=_svgborder(x,y,rr)+'\r\n';
  return s;
}

function _svg_save() {
  var a=document.getElementById("asave");
  var w=cv1.width,h=cv1.height;
  if(!h) h=w;
  var d,s='<svg width="'+w+'" height="'+h+'" xmlns="http://www.w3.org/2000/svg" >\n'+_svg()+'\n</svg>';
  d=encodeURIComponent(s);//.replace(/#/g,'||'));
  a.href='data:text/svg+xml;charset=utf-8,'+d;
  a.download='out.svg';
  a.click();
}

var pdfh,pdfo,pdfd;
function _pdfx(x) { return Math.round(x*1000)/1000; }
function _pdfy(y) { return Math.round((pdfh-y)*1000)/1000; }

function _pdfm(x,y) { return ''+_pdfx(x)+' '+_pdfy(y)+' m'; }
function _pdfl(x,y) { return ''+_pdfx(x)+' '+_pdfy(y)+' l'; }
function _pdfc(x1,y1,x2,y2,x3,y3) {
  return _pdfx(x1)+' '+_pdfy(y1)+' '+_pdfx(x2)+' '+_pdfy(y2)+' '+_pdfx(x3)+' '+_pdfy(y3)+' c';
}
function _pdf_color(c) {
  var i=parseInt(c.substring(1),16),r,g,b;
  if(c.length==7) r=(i>>16)&255,g=(i>>8)&255,b=i&255;
  else r=17*((i>>8)&15),g=17*((i>>4)&15),b=17*((i>>0)&15);
  return ''+_pdfx(r/255)+' '+_pdfx(g/255)+' '+_pdfx(b/255);
}
function _pdfline(w,x,y,x2,y2) {
  //return '<line x1="'+x+'" y1="'+y+'" x2="'+x2+'" y2="'+y2+'" style="stroke:#000;stroke-width:'+w+';" />\r\n';
  return ' '+w+' w '+_pdfm(x,y)+' '+_pdfl(x2,y2)+' S\r\n';
}
function _pdfcircle(w,c,r,x,y,sh) {
  var x0=x-r,y0=y-r,x1=x+r,y1=y+r,m,s=_pdfm(x0,y);
  m=4*(Math.sqrt(2)-1)/3*r;
  s+=' '+_pdfc(x0,y-m,x-m,y0,x,y0);
  s+=' '+_pdfc(x+m,y0,x1,y-m,x1,y);
  s+=' '+_pdfc(x1,y+m,x+m,y1,x,y1);
  s+=' '+_pdfc(x-m,y1,x0,y+m,x0,y);
  return ' '+w+' w '+(c?_pdf_color(c)+' rg ':'')+s+(sh?sh<0?' s':' q W '+(w>0?'s':'n')+' /Sh'+sh+' sh Q \r\n':' b\r\n');
}

function _pdf_arc(w,x,y,x1,y1,x2,y2,z) { 
  // var a=Math.PI/4,s=Math.sin(a),c=Math.cos(a),x=Math.sqrt(3);[s,c,4/3*(1-c),1-s*s/c,1-4/3*(1-c)/(s*s/c)];
  var r=tria?5/9:hexa?1-4/3*(2*Math.sqrt(3)-3):1-4/3*(Math.sqrt(2)-1),r1=1-r;
  return ' '+w+' w '+_pdfm(x,y)+' '+_pdfc(r1*x1+r*x,r1*y1+r*y,r1*x1+r*x2,r1*y1+r*y2,x2,y2)+' S';
}

function _pdf_arc2(c,x,y,x1,y1,x2,y2,z) { 
  if(c) return  ' '+_pdfl(x1,y1)+' '+_pdfl(x2,y2);
  else {
   var r=tria?5/9:hexa?1-4/3*(2*Math.sqrt(3)-3):1-4/3*(Math.sqrt(2)-1),r1=1-r;
   return ' '+_pdfc(r1*x1+r*x,r1*y1+r*y,r1*x1+r*x2,r1*y1+r*y2,x2,y2);
  }
}

function _pdf_arcf(x1,y1,x2,y2,z,sx,sy) { 
  var mx=(x1+x2)/2,my=(y1+y2)/2,dx=mx-sx,dy=my-sy,d2=_sqr(dx,dy),k=_sqr(x1-mx,y1-my)/d2,ex=mx+k*dx,ey=my+k*dy;
  var r2=Math.sqrt(_sqr(x1-sx,y1-sy)),d3=Math.sqrt(d2),dd=r2-d3,r=1-4/3*dd/(k*d3),r1=1-r;
  return ' 0 0 0 rg 0 w '+_pdfm(sx,sy)+' '+_pdfl(x1,y1)+' '+_pdfc(r1*ex+r*x1,r1*ey+r*y1,r1*ex+r*x2,r1*ey+r*y2,x2,y2)+' b';
}

function _pdf_bez(w,x,y,x1,y1,x2,y2,r) { 
  var r1=1-r;
  //return '<path d="M'+x+','+y+' C'+(r1*x1+r*x)+','+(r1*y1+r*y)+' '+(r1*x1+r*x2)+','+(r1*y1+r*y2)+' '+x2+','+y2+'" style="fill:none;stroke:#000;stroke-width:'+w+';" />\r\n';
  return ' '+w+' w '+_pdfm(x,y)+' '+_pdfc(r1*x1+r*x,r1*y1+r*y,r1*x1+r*x2,r1*y1+r*y2,x2,y2)+' S';
}

function _pdf_bez2(c,x,y,x1,y1,x2,y2,r) { 
  if(c) return ' '+_pdfl(x1,y1)+' '+_pdfl(x2,y2);
  else {
   var r1=1-r;
   return ' '+_pdfc(r1*x1+r*x,r1*y1+r*y,r1*x1+r*x2,r1*y1+r*y2,x2,y2);
  }
}

function _pdfpoly(w,c,xy,sh) {
  var s='',i;
  for(i=0;i<xy.length;i+=2)
    s+=' '+_pdfx(xy[i])+' '+_pdfy(xy[i+1])+(s==''?' m':' l');
  return s=' '+(w>0?''+w+' w ':'')+(c?_pdf_color(c)+' rg':'')+s+' '+(sh?sh<0?'s':'q W '+(w>0?'s':'n')+' /Sh'+sh+' sh Q ':(w>0?'b':'f'));
}

function _pdf_pathx(r) { 
  var i,s='',ch;
  for(i=0;i<r.length;)
    switch(r[i++]) {
     case 'm': s+=_pdfm(r[i],r[i+1]),i+=2;break;
     case 'l': s+=_pdfl(r[i],r[i+1]),i+=2;break;
     case 'c': s+=_pdfc(r[i],r[i+1],r[i+2],r[i+3],r[i+4],r[i+5]),i+=6;break;
    }
  return s;
}

function _pdfgpoly(px,py,w,c,xy,b,m) {
  var sh=-1,s='',s2='',s3,k='1',gn,rr=quad?Math.sqrt(2)/3:hexa?Math.sqrt(3)/3:tria?Math.sqrt(2)/3:0.125,l=xy.length;
  var i,i1,g,x=xy[xy.length-2],y=xy[xy.length-1],x2,y2,x1,y1,xy2,sx,sy,d,lx,ly,nx=(xy[0]+xy[l-2])/2,ny=(xy[1]+xy[l-1])/2,mx,my,rx,ry;
  if(c=='#fff') c=clr2[0];
  i=_polyc(xy),sx=i[0],sy=i[1];
  if(b) b.push(b[0],b[1]);
  for(i=i1=0;i<xy.length;i1++,i+=2) {
    x2=x,y2=y,x=xy[i],y=xy[i+1],mx=xy[(i+2)%l],my=xy[(i+3)%l];
    lx=nx,ly=ny,nx=(xy[i]+mx)/2,ny=(xy[i+1]+my)/2;
    //xy2=[(x2+x)/2,(y2+y)/2,x,y,(x+x1)/2,(y+y1)/2,sx,sy];
    rx=m?nx:x,ry=m?ny:y,sh=_pdf_radial('',0,0,[rx,ry,Math.sqrt(_sqr(rx-sx,ry-sy))],c);
    if(m) {
      var px=xy[(i+4)%l],py=xy[(i+5)%l],p=[];
      if(!b||((b[i1]||b[i1+1])&&(b[i1+1]||b[i1+2]))) {
        p.push('m',x,y,'l',mx,my);
      } else {
        _bez3x(p,1,!b||b[i1]||b[i1+1],lx,ly,x,y,nx,ny,rr,1);
        _bez3x(p,0,!b||b[i1+1]||b[i1+2],nx,ny,mx,my,(mx+px)/2,(my+py)/2,rr);
      }
      p.push('l',sx,sy);
      d=_pdf_pathx(p);
      s+=' '+d+' q W n /Sh'+sh+' sh Q\r\n';
    } 
    xy2=[lx,ly,x,y,nx,ny,sx,sy];
    if(!s2) s2=_pdfm(lx,ly);
    if(!b||b[i1]||b[i1+1]) {
      if(!m) s+=' '+_pdfpoly(0,'#fff',xy2,sh)+'\r\n';
      s2+=' '+_pdfl(x,y)+' '+_pdfl(xy2[4],xy2[5]);
    } else {
      d=_pdfm(xy2[0],xy2[1])+' '+(s3=_pdf_bez2(0,xy2[0],xy2[1],xy2[2],xy2[3],xy2[4],xy2[5],rr))+' '+_pdfl(sx,sy);
      if(!m) s+=' '+d+' q W n /Sh'+sh+' sh Q\r\n';
      s2+=s3;
    }
  }
  if(w) {
    if(s3) s+=' '+w+' w '+s2+' s\r\n';
    else s+=' '+_pdfpoly(w,c,xy,-1)+'\r\n';
  }
  return s;
}

function _pdf_path(w,c,xy,o,rr,sh) {
  var s,i,i1,lx,ly,nx,ny,f2=quad||hexa||tria?_pdf_arc2:_pdf_bez2;
  o.push(o[0]);xy.push(xy[0],xy[1]);
  nx=(xy[0]+xy[xy.length-4])/2,ny=(xy[1]+xy[xy.length-3])/2;
  s=''+_pdf_color(c)+' rg '+_pdfm(nx,ny);
  for(i1=i=0;i+2<xy.length;i1++,i+=2)
    lx=nx,ly=ny,s+=f2(o[i1]||o[i1+1],lx,ly,xy[i],xy[i+1],nx=(xy[i]+xy[i+2])/2,ny=(xy[i+1]+xy[i+3])/2,rr);
  s=''+_pdf_color(c)+(w>0?' '+w+' w ':' ')+s+' '+(sh?sh<0?'s':'q W '+(w>0?'s':'n')+' /Sh'+sh+' sh Q ':'b');
  return s;
}

function _pdf_fx(c0,c1) {
  var s=pdfd[c0+c1];
  if(s) return s;
  pdfo.push('<< /FunctionType 2 /Domain [0 1] /Range [0 1 0 1 0 1] /C0 ['+_pdf_color(c0)+'] /C1 ['+_pdf_color(c1)+'] /N 1 >>');
  return pdfd[c0+c1]=pdfo.length;
}

function _pdf_linear(c,dx,dy,xy) {
  var n,s,fn=_pdf_fx('#fff',c),g=_linear(grdx,grdy,xy,1);
  
  s='<< /ShadingType 2 /ColorSpace /DeviceRGB /Coords ['+_pdfx(g[0])+' '+_pdfy(g[1])+' '+_pdfx(g[2])+' '+_pdfy(g[3])+'] /Domain [0 1] /Extend [true true] /Function '+fn+' 0 R >>';
  pdfo.push(s);
  pdfd['$'+(n=pdfo.length)]=n;
  return n;
}

function _pdf_radial(c,dx,dy,xy,c2) {
  var n,s,fn=_pdf_fx(c2?c2:'#fff',c?c:'#fff'),g=xy.length==3?xy:_radialxy(grdx,grdy,xy,1);
  s='<< /ShadingType 3 /ColorSpace /DeviceRGB /Coords ['+_pdfx(g[0])+' '+_pdfy(g[1])+' 0 '+_pdfx(g[0])+' '+_pdfy(g[1])+' '+_pdfx(g[2])+'] /Domain [0 1] /Extend [true true] /Function '+fn+' 0 R >>';
  pdfo.push(s);
  pdfd['$'+(n=pdfo.length)]=n;
  return n;
}

function _pdfcell(x,y,rr,b) {
  var s='',c=_color(x,y),xy=_points(x,y),sh;
  if(grdm) { 
   if(b) { if(c=='#fff') c=clr2[1];
     if(grdm<5) sh=(grdm>1?_pdf_radial:_pdf_linear)(c,grdx,grdy,xy);
   } else sh=-1;
  }
  if(quad&&!rou&&grdm<5) {
    var sx=brd+x*cell,sy=brd+y*cell;
    s+=' 0.5 w '+_pdf_color(c)+' rg';
    s+=' '+_pdfx(sx)+' '+_pdfy(sy+cell)+' '+_pdfx(cell)+' '+_pdfx(cell)+' re '+(sh?sh<0?'s':'q W n /Sh'+sh+' sh Q':'b')+'\n';
  } else {
    if(rou) {
      var i,i1,o=[],lx,ly,nx,ny,r=[],r=_border(x,y),s2='';
      for(i1=i=0;i<xy.length;i1++,i+=2) o[i1]=_brd(x+r[i],y+r[i+1]);
      if(b&&grdm>=5) s+=_pdfgpoly(x,y,0.5,c,xy,o,grdm>5);
      else s+=_pdf_path(0.5,c,xy,o,rr,sh);
    } else 
      if(b&&grdm>=5) s+=_pdfgpoly(x,y,0.5,c,xy,0,grdm>5);
      else s+=_pdfpoly(0.5,c,xy,sh);
  }
  return s;
}

function _pdfcorn(m,e,n,xy2,b) {
  var s,a,c,i,i2,n2=n>>1,x3,y3,x2=xy2[n-4],y2=xy2[n-3],x=xy2[n-2],y=xy2[n-1],dx,dy,ex,ey,p,fx,fy,gx,gy;
  for(i=0,i2=n2-2;i<xy2.length;i+=2,i2=(i2+1)%n2) {
    x3=x2,y3=y2,x2=x,y2=y,x=xy2[i],y=xy2[i+1];
    if(b&&!b[i2]&&!b[(i2+1)%n2]) continue;
    dx=x-x2,dy=y-y2,ex=x3-x2,ey=y3-y2;
    if(Math.abs(dx*ey-dy*ex)<1) continue;
    a=Math.sqrt(_sqr(ex,ey));
    c=Math.sqrt(_sqr(dx,dy));
    fx=x2+e*(x3-x2)/a,fy=y2+e*(y3-y2)/a,gx=x2+e*(x-x2)/c,gy=y2+e*(y-y2)/c;
    if(m==2) {
      s+=_pdf_arcf(fx,fy,gx,gy,e,x2,y2);
    } else {
      s+=_pdfpoly(0,'#000',[x2,y2,fx,fy,gx,gy]);
    }
  }
  return s;
}

function _pdfborder(x,y,rr) {
  var s='',i,xy=_points(x,y),b2,b=_border(x,y),e=_getblock(x,y),n=xy.length;
  if(rou) {
    var i1,a,o=[];
    for(i1=i=0;i<xy.length;i1++,i+=2) o[i1]=_brd(x+b[i],y+b[i+1]);
    o.push(o[0]);o.shift();
    o.push(o[0]);
    xy.push(xy[0],xy[1],xy[2],xy[3]);
    for(i1=i=0;i+4<xy.length;i1++,i+=2) {
      if(!o[i1]&&!o[i1+1]) {
         if(quad||hexa||tria) {
           var ar=tria?cell3y/3:hexa?cell6x/2:cell/2;
           s+=_pdf_arc(2,(xy[i]+xy[i+2])/2,(xy[i+1]+xy[i+3])/2,xy[i+2],xy[i+3],(xy[i+2]+xy[i+4])/2,(xy[i+3]+xy[i+5])/2,ar);
         } else s+=_pdf_bez(2,(xy[i]+xy[i+2])/2,(xy[i+1]+xy[i+3])/2,xy[i+2],xy[i+3],(xy[i+2]+xy[i+4])/2,(xy[i+3]+xy[i+5])/2,rr);
      } else if(!o[i1]) s+=_pdfline(2,(xy[i]+xy[i+2])/2,(xy[i+1]+xy[i+3])/2,xy[i+2],xy[i+3]);
      else if(!o[i1+1]) s+=_pdfline(2,(xy[i+2]+xy[i+4])/2,(xy[i+3]+xy[i+5])/2,xy[i+2],xy[i+3]);
    }
  } else
    for(i=0,i2=b.length-2;i<xy.length;i2=i,i+=2) {
      if((b2=board[y+b[i+1]])&&!_xo(b2[x+b[i]])) s+=_pdfline(2,xy[i],xy[i+1],xy[i2],xy[i2+1]);
    }
  if(corn) s+=_pdfcorn(corn,3,n,xy,o);
  if(e) {
    xy.splice(n);
    var i,m,i2,i3,xy2=xy.slice();
    _polyex2(xy,15/16,0,0);
    for(m=1,i=0,i2=b.length-2;i<xy.length;i2=i,i+=2,m<<=1) 
      if(e&m) 
        s+=_pdfline(2,xy[i],xy[i+1],xy[i2],xy[i2+1]);
    e=e|rol(xy2.length>>1,e,-1);
    for(m=1,i=0;i<xy2.length;i+=2,m<<=1) 
      if(e&m)
        s+=_pdfcircle(3,'#000',1,xy2[i],xy2[i+1]);
  }
  return s;
}

function _pdf() {
  var w=cv1.width,h=cv1.height;
  var s='1 j 1 J 1 w\n',xr=[];
  var c,x,y,ey=board.length-1;
  var p=f.peg.checked,rr=tria?cell3y/3:hexa?cell6x/2:quad?cell/2:0.125,rr2=rr>0?rr*0.75:rr;
  pdfh=h,pdfo=[],pdfd={};
  pdfo.push('<<\r\n/Type /Catalog\r\n/Pages 2 0 R\r\n>>');
  pdfo.push('<<\r\n/Type /Pages\r\n/Count 1\r\n/Kids[3 0 R]\r\n>>');
  pdfo.push('<<\r\n/Type /Page\r\n/Parent 2 0 R\r\n/Resources << /ProcSet 5 0 R /Shading <<>> >>\r\n/MediaBox[0 0 '+w+' '+h+']\r\n/Contents 4 0 R\r\n>>');
  s+='0 0 0 RG\n';
  if(grdm) {
    for(y=0;y<ey;y++)
      for(x=0,b=board[y],xe=b.length;x<xe;x++)
        if((c=b[x])>' ') s+=_pdfcell(x,y,rr,1)+'\r\n';
  }
  for(y=0;y<ey;y++)
    for(x=0,b=board[y],xe=b.length;x<xe;x++)
      if((c=b[x])>' ') {
        s+=_pdfcell(x,y,rr)+'\r\n';
        if(c!='x') {
          var wh=c=='w',pc=_getpgc(x,y);
          pc=pc?wh?_whi(pc):pc:wh?grdm2?'#ccc':'#fff':'#000';
          if(p) {
            var xy=_polyex2(_points(x,y),0.75),sh,rp;
            if(grdm2) rp=_radial_xy(xy),sh=_pdf_radial(pc,0,0,rp);
            if(rou) {
              var i,i1,o=[],r=_border(x,y);
              for(i1=i=0;i<xy.length;i1++,i+=2) o[i1]=_brd(x+r[i],y+r[i+1]);
              s+=_pdf_path(wh?2:1,pc,xy,o,rr2,sh);
            } else 
              s+=_pdfpoly(wh?2:1,pc,xy,sh);
          } else {
            var g=_peg(x,y),sh;
            if(grdm2) sh=_pdf_radial(pc,0,0,[g[0]-g[2]/2,g[1]-g[2]/2,g[2]]);
            s+=' '+_pdfcircle(wh?2:1,pc,g[2],g[0],g[1],sh);
          }
      }
    }
  for(y=0;y<ey;y++)
    for(x=0,b=board[y],xe=b.length;x<xe;x++)
      if((c=b[x])>' ') s+=_pdfborder(x,y,rr)+'\r\n';
  s='<< /Length '+s.length+' >>\r\nstream\r\n'+s+'\r\nendstream';
  pdfo.push(s);
  s=pdfo[2].replace('5 0 R',''+(pdfo.length+1)+' 0 R').replace('4 0 R',''+(pdfo.length)+' 0 R');
  x='';
  for(i in pdfd)
    if(i[0]=='$') y=pdfd[i],x+='/Sh'+y+' '+y+' 0 R ';
  if(x!='') s=s.replace('<<>>','<<'+x+'>>');
  pdfo[2]=s;
  pdfo.push('[/PDF]');
  s='%PDF-1.0\r\n';
  for(x in pdfo) {
    xr.push(s.length);
    s+=(s[s.length-1]=='\n'?'':'\r\n')+(1+(+x))+' 0 obj '+pdfo[x]+(pdfo[x][pdfo[x].length-1]=='\n'?'':'\r\n')+'endobj\r\n';
  }
  c=s.length;
  s+='xref\r\n0 '+(1+pdfo.length)+'\r\n0000000000 65535 f\r\n'
  for(x in xr) {
    y='00000000'+xr[x];
    s+=y.substring(y.length-10)+' 00000 n\r\n';
  }
  s+='trailer\r\n<<\r\n/Size '+pdfo.length+'\r\n/Root 1 0 R\r\n>>\r\nstartxref\r\n'+c+'\r\n%%EOF'
  pdfo=pdfd=0;
  return s;
}

function _pdf_save() {
  var a=document.getElementById("asave");
  var w=cv1.width,h=cv1.height;
  if(!h) h=w;
  var d,s=_pdf();
  d=encodeURIComponent(s);
  a.href='data:application/pdf;charset=utf-8,'+d;
  a.download='out.pdf';
  a.click();
}

function _mxy(e) {
  var ex=e.offsetX,ey=e.offsetY;
  if(deca) {
    var x=Math.floor((ex-brd)*2/cell8x),y=2+Math.floor((ey-brd)*4/cell8y),y3=y%3;
    var cy=Math.floor(y/3)-1,cx=Math.floor((x-(cy&1))/2);
    var dx=cy&1,sx=brd+(cx+dx/2)*cell8x,sy=brd+((1+cy*3)/4)*cell8y,vx=cell8x,vy=cell8y/2,x2=sx+vx,x3=sx+cell8x,y2=sy+vy;
    var ax=2*(ex-sx)-cell8x,ay=2*(ey-sy)-cell8y;
    var up=Math.abs(ax)*vy-(2*vy+ay)*vx;
    if(up>0) {
      ay+=3*vy,sy-=3*vy,cy--;
      up=ax>0;ax+=(up?-1:1)*cell8x;sx+=cell8x*(up?1:-1)/2;cx+=up+dx-1;
    }
    vx=cell8x/2,vy=3*cell8y/4;
    up=ax*vy-Math.abs(ay)*vx;
    d=up>0?1:ay>0?2:0;
    return [3*cx+d-2,cy,ax-cell8x,ay-cell8y*3/2,2,ex,ey];
  } else if(trap) {
    var dd,x=Math.floor((ex-brd)*2/cell8x),y=2+Math.floor((ey-brd)*4/cell8y),y3=y%3;
    var cy=Math.floor(y/3)-1,cx=Math.floor((x-(cy&1))/2);
    var dx=cy&1,sx=brd+(cx+dx/2)*cell8x,sy=brd+((1+cy*3)/4)*cell8y,vx=cell8x,vy=cell8y/2,x2=sx+vx,x3=sx+cell8x,y2=sy+vy;
    var ax=2*(ex-sx)-cell8x,ay=2*(ey-sy)-cell8y*4/4;
    var up=ax*vy+ay*vx<0&&-ax*vy+ay*vx<0;
    if(up) {
      ay+=2*vy;
      up=ax*vy-ay*vx<0&&-ax*vy-ay*vx<0;
      if(!up) {
        d=ax<0?2:1,cy--,dx^=1,sy-=cell8y*3/4,ay+=2*cell8y*3/4;
        sx+=(1-dx/2)*cell8x,cx-=dx;
        if(d==1) cx++,sx+=cell8x,ax-=2*cell8x;
      }
    }
    d=(cx+2*(cy&1))%3;
    sx=brd+(cx+dx/2)*cell8x,sy=brd+((1+cy*3)/4)*cell8y;
    ax=2*(ex-sx)-cell8x,ay=2*(ey-sy)-cell8y*4/4;
    if(d==1) d=ax>0?1:0;
    else if(d==2) d=ax+ay*cell8x/cell8y*2>0?1:0;
    else d=ax-ay*cell8x/cell8y*2>0?1:0;
    return [2*cx+d-1,cy,ax-cell8x,ay-cell8y*3/2,2,ex,ey];
  } else if(cubes) {
    var x=Math.floor((ex-brd)*2/cell8x),y=2+Math.floor((ey-brd)*4/cell8y),y3=y%3;
    var cy=Math.floor(y/3)-1,cx=Math.floor((x-(cy&1))/2);
    var dx=cy&1,sx=brd+(cx+dx/2)*cell8x,sy=brd+((1+cy*3)/4)*cell8y,vx=cell8x,vy=cell8y/2,x2=sx+vx,x3=sx+cell8x,y2=sy+vy;
    var ax=2*(ex-sx)-cell8x,ay=2*(ey-sy)-cell8y*4/4;
    var up=ax*vy+ay*vx<0&&-ax*vy+ay*vx<0;
    if(!up) d=ax>0?2:1;
    else {
      ay+=2*vy;
      up=ax*vy-ay*vx<0&&-ax*vy-ay*vx<0;
      if(up) d=0;
      else {
        d=ax<0?2:1,cy--,dx^=1,sy-=cell8y*3/4;
        sx+=(1-dx/2)*cell8x,cx-=dx;
        if(d==1) cx++,sx+=cell8x;
      }
    }
    return [3*cx+d-2,cy,ax-cell8x,ay-cell8y*3/2,2,ex,ey];
    //var d=(x+2)%3,cx=(x+2-d)/3;
    //var sx=brd+(cx+(y&1)/2)*cell8x,sy=brd+((1+y*3)/4)*cell8y,x2=cell8x/2,y2=cell8y/4;
  } else if(delta) {
    var c62=cell9x/2,cy=Math.floor((ey-brd)/cell9y),cx=Math.floor((ex-brd)/c62),d=1^(cy&1)^(cx&1),dy=d?1:-1;
    var sx=brd+cx*c62,sy=brd+(cy+d)*cell9y,ax,ay=2*(ey-sy)-dy*cell9y,gx,gy,r,yy;
    gx=ex-sx,gy=ey-sy;
    //alert(''+gx+' '+gy);
    if(dy*(gx*dy*cell9y+gy*c62)<0) cx--,sx-=c62,dy*=-1,d=!d;
    sy=brd+(cy+d)*cell9y;
    ax=2*(ex-sx)-cell9x,yy=dy*(ey-(sy-dy*cell9y/3));
    r=ax>0?2:0;
    if(yy<-Math.abs(ax)/3) r=1;
    //if(dy*yy<0) r=1;else r=0;
    return [3*cx-2+r,cy,ax,ay,0,ex,ey];
  } else if(penta) {
    var cx=Math.floor((ex-brd)/cell7),cy=Math.floor((ey-brd)/cell7),v=(cx+cy)&1,x1,c2=cell7/2,c4=c2/2;
    var sx=brd+cx*cell7,sy=brd+cy*cell7,ax=2*(ex-sx),ay=2*(ey-sy),r;
    if(v) {
      if(ax>2*ay&&(2*cell7-ax)>2*ay) r=-1;
      else if((4*cell7-ax)<2*ay&&(2*cell7+ax)<2*ay) r=1;
      if(r) sy+=r*cell7,ay-=r*2*cell7,cy+=r,v=0;
    } else {
      if(ay>2*ax&&(2*cell7-ay)>2*ax) r=-1;
      else if((4*cell7-ay)<2*ax&&(2*cell7+ay)<2*ax) r=1;
      if(r) sx+=r*cell7,ax-=r*2*cell7,cx+=r,v=1;
    }
    if(v) {
      x1=ax>cell7,ax-=x1?cell7:c2,ay-=cell7;
    } else {
      x1=ay>cell7,ax-=cell7,ay-=x1?cell7:c2;
    }
    return [2*cx-1+x1,cy,ax,ay,0,ex,ey];
  } else if(tria4) {
    var cx=Math.floor((ex-brd)/cell5),cy=Math.floor((ey-brd)/cell5);
    var sx=brd+cx*cell5,sy=brd+cy*cell5,ax,ay,gx,gy,r;
    r=((ex-sx)+(ey-sy-cell5)>0?2:0)|((ex-sx)-(ey-sy)>0?1:0);
    return [2*cx+(r&1)-1,2*cy+((r&2)>>1)-1,ax,ay,0,ex,ey];
  } else if(tria2) {
    var cx=Math.floor((ex-brd)/cell2),cy=Math.floor((ey-brd)/cell2),d=(0^cy^cx)&1;
    var sx=brd+cx*cell2,sy=brd+cy*cell2,ax,ay,n;
    n=d?ex-sx>ey-sy:sx+cell2-ex<ey-sy;
    ax=2*(ex-sx)-cell2,ay=2*(ey-sy)-cell2;
    return [2*cx+n-1,cy,ax,ay,0,ex,ey];
  } else if(tria) {
    var c62=cell3x/2,cy=Math.floor((ey-brd)/cell3y),cx=Math.floor((ex-brd)/c62),d=1^(cy&1)^(cx&1),dy=d?1:-1;
    var sx=brd+cx*c62,sy=brd+(cy+d)*cell3y,ax,ay=2*(ey-sy)-dy*cell3y,gx,gy;
    gx=ex-sx,gy=ey-sy;
    //alert(''+gx+' '+gy);
    if(dy*(gx*dy*cell3y+gy*c62)<0) cx--,sx-=c62,sy+=dy*cell3y,dy*=-1,d=!d;
    ax=2*(ex-sx)-cell3x;
    return [cx,cy,ax,ay,0,ex,ey];
  } else if(!hexa) {
    var cx=Math.floor((ex-brd)/cell),cy=Math.floor((ey-brd)/cell);
    var sx=brd+cx*cell,sy=brd+cy*cell,ax=2*(ex-sx)-cell,ay=2*(ey-sy)-cell,c,gx,gy;
    gx=ax+ay,gy=-ax+ay;
    c=gx<0?2:0,c|=(c>>1)^(gy<0);
    return [cx,cy,ax,ay,c,ex,ey];
  }
  var x=Math.floor((ex-brd)*2/cell6y),y=Math.floor((ey-brd)*4/cell6x),y3=y%3;
  var cy=Math.floor(y/3),cx=Math.floor((x-(cy&1))/2);
  var dx=cy&1?0:-1,sx=brd+(cx+(cy&1)/2)*cell6y,sy=brd+((1+cy*3)/4)*cell6x,x2=sx+cell6y/2,x3=sx+cell6y,ax=2*(ex-sx)-cell6y,ay=2*(ey-sy)-cell6x/2,fx=ex-sx,fy=ey-sy;
  if(y3!=0) {
    fx=ax,fy=ay;
    var c=0;
    if(fx<0) c=3,fx=-fx,fy=-fy;
    if(fx*-cell6x/2-fy*cell6y<0)
      c+=fx*cell6x/2-fy*cell6y>0?1:2;
    return [cx,cy,ax,ay,c,ex,ey];
  }
  if(fx*-cell6x/2-fy*cell6y>0) {
    return [cx+dx,cy-1,ax-cell6y,ay-cell6x*3/2,2,ex,ey];
  }
  fx=ex-sx-cell6y;
  if(fx*cell6x/2-fy*cell6y>0) return [cx+dx+1,cy-1,ax+cell6y,ay-cell6x*3/2,3,ex,ey];
  return [cx,cy,ax,ay,ax>0?0:5,ex,ey];
}
function _mdown(e) { 
  mm=mp=_mxy(e); 
  var b,c; 
  if(design==7) mp[7]=_idx(mp[5],mp[6],_points(mp[0],mp[1])),mp[8]=_getblock(mp[0],mp[1]);
  else if(design==9||design==10)  _mdesign(design,-1,mp,e);
  if(mp&&(b=board[mp[1]])&&(c=b[mp[0]])!=' ') {
    sele=[mp[0],mp[1]];
    _drawboard();
  }
}
function _dline(px,py,mx,my,c) {
  var b,i,x,y,dx=mx-px,dy=my-py,ax=Math.abs(dx),ay=Math.abs(dy),d=ax>ay,a=d?ax:ay;
  for(i=0;i<=a;i++) {
    x=px+(((i*dx+(d?0:a/2))/a)|0),y=py+(((i*dy+(d?a/2:0))/a)|0),b=board[y];
    if(b) if(c<0) sele.push(x,y);else b[x]=c;
  }
}

function _dline3(px,py,mx,my,c) {
  var b,i,x,y,dx=mx-px,dy=my-py,ax=Math.abs(dx),ay=Math.abs(dy),d=ax>ay,a=d?ax:ay,b2,x2,k,m={},xy;
  for(i=0;i<=a;i++) {
    x=px+dx*i/a,y=py+dy*i/a;
    xy=_mxy({offsetX:x,offsetY:y}),x=xy[0],y=xy[1],b=board[y];
    k=''+x+','+y;
    if(!m[k]&&b&&x>=0) {
      m[k]=1;
      if(c<0) sele.push(x,y);else b[x]=c;
    }
  }
}

function _border2(x,y) {
  var xx=(x+1+2*(y&1))&3,r;
  if(xx==0) return [-1,0,0,-1,1,0];
  if(xx==1) return [1,0,0,1,-1,0];
  if(xx==2) return [0,1,-1,0,1,0];
  return [0,-1,1,0,-1,0];
}

function _shiftxy(px,py,b,opt) {
  var xy=[],x,y,p,nx,ny,n,pi,f;
  f=deca?((b^1)+6)%12:penta&&opt?b^4:tria4||penta?(((b+4)^1)&7):quad||tria2?(b=b&3,b^2):(b%=6,(b+3)%6);
  for(x=px,y=py;(n=_next(x,y,b,opt),_xo(board[ny=n[1]][nx=n[0]]))&&!_blocked(x,y,nx,ny);x=nx,y=ny)
    xy.push(ny,nx);
  xy.reverse(),pi=xy.length,xy.push(px,py);
  for(x=px,y=py;(n=_next(x,y,f,opt),_xo(board[ny=n[1]][nx=n[0]]))&&!_blocked(x,y,nx,ny);x=nx,y=ny)
    xy.push(nx,ny);
  xy.push(pi);
  return xy;
}

function _next(x,y,d,opt) {
  if(deca) {
    var e=(x+2)%3,bx=y&1?0:-3,x2,r=d&1,d2=d>>1;
    //console.log(d,d2,r,opt);
    if(opt) {
      if(d2==0) x+=(r?[-2,1,-2]:[2,-1,-4])[e];
      else if(d2==1) x+=(r?[bx+1,1,-2]:[bx+2,-1,-1])[e],y+=e==0?-1:e==1?0:0;
      else if(d2==2) x+=(r?[1,bx+4,-2]:[bx+5,-1,-1])[e],y+=e==(r?1:0)?-1:0;
      else if(d2==3) x+=(r?[1,4,-2]:[2,2,-1])[e];
      else if(d2==4) x+=(r?[1,1,bx+1]:[2,bx+2,-1])[e],y+=e==(r?2:1)?1:0;
      else if(d2==5) x+=(r?[1,1,bx-2]:[2,-1,bx-1])[e],y+=e==2?1:0;
    } else {
      if(d2==0) x+=e==0?-2:e==1?r?-1:1:-4;
      else if(d2==1) x+=e==0?bx+(r?1:2):e==1?-1:-2,y+=e==0?-1:e==1?0:0;
      else if(d2==2) x+=e==0?bx+5:e==1?bx+4:r?-1:-2,y+=e==0?-1:e==1?-1:0;
      else if(d2==3) x+=e==0?1:e==1?r?4:2:-1;
      else if(d2==4) x+=e==0?r?2:1:e==1?bx+2:bx+1,y+=e==0?0:e==1?1:1;
      else if(d2==5) x+=e==0?2:e==1?1:bx+(r?-2:-1),y+=e==0?0:e==1?0:1;
    }

  } else if(cubes) {
    var e=(x+2)%3,bx=y&1?0:-3,x2;
    if(opt) {
      if(d==0) x+=e==0?1:e==1?-2:-2;
      else if(d==1) x+=e==0?bx+2:e==1?-1:-1,y+=e==0?-1:0;
      else if(d==2) x+=e==0?bx+4:e==1?1:-2,y+=e==0?-1:0;
      else if(d==3) x+=e==0?2:e==1?-1:2;
      else if(d==4) x+=e==0?1:e==1?1:bx+1,y+=e==2?1:0;
      else if(d==5) x+=e==0?2:e==1?bx-1:-1,y+=e==1?1:0;
    } else {
      if(d==0) x+=e==0?-3:e==1?-2:-1;
      else if(d==1) x+=e==0?bx+2:e==1?bx:-2,y+=e==0?-1:e==1?-1:0;
      else if(d==2) x+=e==0?bx+4:e==1?-1:bx+3,y+=e==0?-1:e==1?0:-1;
      else if(d==3) x+=e==0?3:e==1?1:2;
      else if(d==4) x+=e==0?2:e==1?bx+3:bx+1,y+=e==0?0:e==1?1:1;
      else if(d==5) x+=e==0?1:e==1?bx-1:bx,y+=e==0?0:e==1?1:1;
    }
  } else if(trap) {
    var e=(x+1)%2,cx=(x+1)>>1,dd=(cx+2*(y&1))%3+3*e,dx=y&1?0:-2;
    if(opt) {
      if(d==0) x+=dd==5?dx:dd==1?dx:-1,y+=dd==5||dd==1?1:0;
      else if(d==1) x+=dd==2?dx:dd==3?dx:-1,y+=dd==2||dd==3?-1:0;
      else if(d==2) x+=dd==0?1:dd==1?dx+1:dd==2?dx+2:dd==3?dx:dd==4?dx+1:-1,y+=dd==0||dd==5?0:-1;
      else if(d==3) x+=dd==2?dx+2:dd==3?dx+2:1,y+=dd==2||dd==3?-1:0;
      else if(d==4) x+=dd==0?dx+2:dd==4?dx+2:1,y+=dd==0||dd==4?1:0;
      else if(d==5) x+=dd==0?dx+1:dd==1?dx:dd==2?1:dd==3?-1:dd==4?dx+2:dx+1,y+=dd==2||dd==3?0:1;
    } else {
      if(d==0) x+=-1;
      else if(d==1) x+=dd==0?1:dd==1?dx+1:dd==2?dx:dd==3?dx:-1,y+=dd==1||dd==2||dd==3?-1:0;
      else if(d==2) x+=dd==2?dx+2:dd==3?dx+2:dd==4?dx+1:dd==5?-1:1,y+=dd==2||dd==3||dd==4?-1:0;
      else if(d==3) x+=1;
      else if(d==4) x+=dd==0?dx+2:dd==3?-1:dd==4?dx+2:dd==5?dx+1:1,y+=dd==4||dd==5||dd==0?1:0;
      else if(d==5) x+=dd==0?dx+1:dd==1?dx:dd==2?1:dd==5?dx:-1,y+=dd==5||dd==0||dd==1?1:0;
    }
  } else if(delta) {
    var r=(x+2)%3,cx=(x+2-r)/3,e=1^(y&1)^(cx&1),dy=e?-1:1,xx=3*e+r;
    if(d==0) x+=2;
    else if(d==1) x+=xx==0||xx==2?0:xx==1?-1:xx==3?-2:xx==4?-2:-1,y+=xx==0||xx==2?-1:0;
    else if(d==2) x+=xx==0||xx==2?0:xx==1?1:xx==3?1:xx==4?2:2,y+=xx==0||xx==2?-1:0;
    else if(d==3) x+=-2;
    else if(d==4) x+=xx==3||xx==5?0:xx==0?1:xx==1?2:xx==2?2:1,y+=xx==3||xx==5?1:0;
    else if(d==5) x+=xx==3||xx==5?0:xx==0?-2:xx==1?-2:xx==2?-1:-1,y+=xx==3||xx==5?1:0;
  } else if(penta) {
    var d2=d>>1,cx=(x+1)>>1,x1=x&1,vx=(((cx+y)&1)<<1)|((x^1)&1);
    if(opt) {
      if(d2==0) x+=vx==2&&d==1?-2:vx==1&&d==1?-2:vx==0&&d==1?1:-1;
      else if(d2==1) x+=vx==0&&d==3?1:vx==3&&d==3?-1:vx==2?1:vx==1?-1:0,y+=vx==1||vx==2&&d==2||vx==3&&d==3?0:-1;
      else if(d2==2) x+=vx==3&&d==5?2:vx==0&&d==5?2:vx==1&&d==5?-1:1;
      else if(d2==3) x+=vx==1&&d==7?-1:vx==2&&d==7?1:vx==3?-1:vx==0?1:0,y+=vx==0||vx==2&&d==7||vx==3&&d==6?0:1;
    } else {
      if(d2==0) x+=vx==2&&d==1?-2:vx==1?-2:-1;
      else if(d2==1) x+=vx==0&&d==3?1:vx==2?1:vx==1?-1:0,y+=vx==1?0:-1;
      else if(d2==2) x+=vx==3&&d==5?2:vx==0?2:1;
      else if(d2==3) x+=vx==1&&d==7?-1:vx==3?-1:vx==0?1:0,y+=vx==0?0:1;
    }
  } else if(tria4) {
    var d2=d>>1,r=(((y+1)&1)<<1)|((x+1)&1);
    if(d2==0) x+=r==3&&d==1?0:r==2?0:-1,y+=r==3&&d==1?-1:r==0?1:r==2?-1:0;
    else if(d2==1) x+=r==2&&d==3?1:r==1?-1:r==0?1:0,y+=r==2&&d==3?0:r==0?0:-1;
    else if(d2==2) x+=r==0&&d==5?0:r==1?0:1,y+=r==0&&d==5?1:r==1?1:r==3?-1:0;
    else if(d2==3) x+=r==1&&d==7?-1:r==2?1:r==3?-1:0,y+=r==1&&d==7?0:r==3?0:1;
  } else if(tria2) {
    var xx=(x+1+2*(y&1))&3;
    if(d==0||d==2) x+=d?1:-1;
    else { x++;if((xx==1||xx==2)==(d>1)) y+=d>1?1:-1;else x^=1;x--;};
  } else if(tria) {
    var dy=(y&1)^(x&1)?-1:1;
    if(dy>0?d==4||d==5:d==1||d==2) y+=dy; 
    else if(d==0||d==1||d==5) x--;
    else x++;
  } else if(hexa) {
    var dx=y&1?0:-1;
    x+=d==0?-1:d==1?dx:d==2?dx+1:d==3?1:d==4?dx+1:d==5?dx:0;
    y+=d==1||d==2?-1:d==4||d==5?1:0;
  } else {
    x+=d==0?-1:d==2?1:0;
    y+=d==1?-1:d==3?1:0;
  }
  return [x,y];
}

function _dir10(ex,ey,px,py) {
  var e=(px+2)%3,b2,p;//,bx=y&1?0:-3;
  var b=_idx(ex,ey,p=_points(px,py)),b2;
  if(b==3||b==4) b2=_idx(ex,ey,p,1),b+=b2==3?3:0;
  b2=b;
  if(e==0) b=[2,3,4,6,11,1,8,9][b];//b==0?2:b==1?3:b==2?4:b==3?6:b==4?11:1;
  else if(e==1) b=[6,7,8,10,3,5,0,1][b];//b==0?3:b==1?5:b==2?0:2;
  else if(e==2) b=[10,11,0,2,7,9,4,5][b];//b==0?1:b==1?3:b==2?4:0;
  return (b2<<4)|b;
}

function _shiftb(px,py,ex,ey) {
  var b;
  if(deca) {
    b=15&_dir10(ex,ey,px,py);
  } else if(cubes) {
    var e=(px+2)%3;//,bx=y&1?0:-3;
    b=_idx(ex,ey,_points(px,py));
    if(e==0) b=b==0?5:b==3?4:b;
    else if(e==1) b=b==0?3:b==1?5:b==2?0:2;
    else if(e==2) b=b==0?1:b==1?3:b==2?4:0;
  } else if(trap) {
    var e=(px+1)%2,cx=(px+1)>>1,dd=(cx+2*(py&1))%3+3*e,opt=diag;
    b=_idx(ex,ey,_points11h(px,py),opt);
    b+=opt?0:5;
    b=b%6;
  } else if(delta) {
    var f,r=(px+2)%3,cx=(px+2-r)/3,e=1^(py&1)^(cx&1),dy=e?-1:1,xx=3*e+r;
    b=_idx(ex,ey,_points(px,py),2);
    b=((f=b&3)<<1)|(b&64?0:1);
    if(xx==0) b=f>1?f+1:b+5;
    else if(xx==1) b=f>1?f-1:b+3;
    else if(xx==2) b=f>1?f+3:b+4;
    else if(xx==3) b=f>1?f:b+4;
    else if(xx==4) b=f>1?f+2:b;
    else if(xx==5) b=f>1?f+4:b+5;
    b%=6;
  } else if(penta) {
    var b2,cx=(px+1)>>1,vx=(((cx+py)&1)<<1)|((px^1)&1);
    b=_idx(ex,ey,_points(px,py),2);
    b=((f=b&7)<<1)|(b&64?0:1);
    if(vx==0) b=b<2?b:b<6?f+1:b+6;
    else if(vx==1) b=b<2?b+4:b<6?f+5:b+2;
    else if(vx==2) b=b<2?b+6:b<6?f+7:b+4;
    else if(vx==3) b=b<2?b+2:b<6?f+3:b+0;
    b&=7;
  } else if(tria4) {
    var r=(((py+1)&1)<<1)|((px+1)&1);
    b=_idx(ex,ey,_points(px,py),2);
    b=((f=b&3)<<1)|(b&64?0:1);
    if(r==0) b+=b>3?4:b==3?4:b>0?3:2;
    else if(r==1) b+=b>3?6:b==3?6:b>0?5:4;
    else if(r==2) b+=b>3?2:b==3?2:b>0?1:0;
    else if(r==3) b+=b>3?0:b==3?0:b>0?7:6;
    b&=7;
  } else if(tria2) {
    var f,xx=(px+1+2*(py&1))&3,r;
    b=_idx(ex,ey,_points(px,py),2);
    b=((f=b&3)<<1)|(b&64?0:1);
    if(xx==0) b=b>=4?b-2:f;
    else if(xx==1) b=b>=4?b-4:f+2;
    else if(xx==2) b=b>=4?b-3:f+3;
    else if(xx==3) b=b>=4?b-1:f+1;
    b&=3;
  } else if(tria) {
    var e=1^(py&1)^(px&1);
    b=_idx(ex,ey,_points(px,py),2);
    b=((b&3)<<1)|(b&64?0:1);
    b=(b+3*e+1)%6;
  } else if(hexa) {
    b=_idx(ex,ey,_points(px,py));
  } else {
    //b=Math.abs(px-mx)>Math.abs(py-my)?0:1,
    b=_idx(ex,ey,_points(px,py));
    b&=3;
  }
  return b;
}

function _shift(xy,d) {
  var n=xy.length>>1,i,j,k,m=[],x,y,pc=[];
  d=(d%n+n)%n;
  for(i=0;i+1<xy.length;i+=2) m.push(board[y=xy[i+1]][x=xy[i]]),pc.push(_getpgc(x,y));
  for(i=j=0;i+1<xy.length;j++,i+=2) {
    board[y=xy[i+1]][x=xy[i]]=m[k=(j+d)%n];
    _setpgc(x,y,pc[k]);
  }
}

function _dshift(px,py,mu,c) {
 var mx=mu[0],my=mu[1],ex=mu[5],ey=mu[6],opt=diag;
  var a,b,d,e,n,m=[],i,j,xy=[],x,y,nx,ny,p,pv,pi,mi,mv;
  b=_shiftbf(px,py,ex,ey);
  xy=_shiftxy(px,py,b,opt);
  pi=xy.pop();
  for(i=0,mv=1<<30;i<xy.length;i+=2) {
    p=_peg(x=xy[i],y=xy[i+1]),pv=_sqr(ex-p[0],ey-p[1]);
    if(pv<mv) mi=i,mv=pv;
  }
  /*
  p=_peg(px,py),mi=-2,mv=_sqr(ex-p[0],ey-p[1]);
  for(x=px,y=py;(n=_next(x,y,b),_xo(board[ny=n[1]][nx=n[0]]))&&!_blocked(x,y,nx,ny);x=nx,y=ny) {
    p=_peg(nx,ny),pv=_sqr(ex-p[0],ey-p[1]);
    if(pv<mv) mi=xy.length,mv=pv;
    xy.push(ny,nx);
  }
  pi=xy.length,mi=pi-2-mi,xy.reverse(),xy.push(px,py);
  for(x=px,y=py;(n=_next(x,y,f),_xo(board[ny=n[1]][nx=n[0]]))&&!_blocked(x,y,nx,ny);x=nx,y=ny) {
    p=_peg(nx,ny),pv=_sqr(ex-p[0],ey-p[1]);
    if(pv<mv) mi=xy.length,mv=pv;
    xy.push(nx,ny);
  }*/
  if(c<0) {
    sele=[];
    for(j=0;j<xy.length;j+=2) if(xy.length==2||xy[j]!=px||xy[j+1]!=py) sele.push(xy[j],xy[j+1]);
  } if(c>=0) {
    _shift(xy,(pi-mi)/2);
    //n=xy.length/2,d=(((pi-mi)/2)%n+n)%n;
    //for(i=0;i<xy.length;i+=2) m.push(board[xy[i+1]][xy[i]]);
    //for(i=j=0;i<xy.length;j++,i+=2) board[xy[i+1]][xy[i]]=m[(j+d)%n];
  }
}

function _shifter(up,mu,ev) {
  var px=mp[0],py=mp[1],ex=mu[5],ey=mu[6],b,m,i,j,pi,opt=diag;
  b=_shiftb(px,py,ex,ey);
  xy=_shiftxy(px,py,b,opt),pi=xy.pop();
  if(up) {
    for(i=0,mv=1<<30;i<xy.length;i+=2) {
      p=_peg(x=xy[i],y=xy[i+1]),pv=_sqr(ex-p[0],ey-p[1]);
      if(pv<mv) mi=i,mv=pv;
    }
    sele=[];
    _shift(xy,i=(pi-mi)/2);
    _moves(1);
    _drawboard();
    _beep();
  } else {
    sele=[];
    for(j=0;j<xy.length;j+=2) if(xy.length==2||xy[j]!=px||xy[j+1]!=py) sele.push(xy[j],xy[j+1]);
    _drawboard();
  }
  return [px,py,[b,opt],i];
}

function _fall(xy,pi) {
  var ch,i,j=pi,x,y,n=xy.length>>1,b;
  for(i=0;i<n;i++,pi=(pi+2)%xy.length) {
    b=board[y=xy[pi+1]];
    if(b&&('o'==(ch=b[x=xy[pi]])||'w'==ch)) {
      if(j!=pi) board[xy[j+1]][xy[j]]=ch,b[x]='x'; 
      j=(j+2)%xy.length;
    }
  }
}
function _faller(up,mu,ev) {
  var x,y,ch,n,nx,ny,px=mp[0],py=mp[1],ex=mu[5],ey=mu[6],b,m,i,j,xy,pi,opt=diag;
  b=_shiftb(px,py,ex,ey);
  xy=_shiftxy(px,py,b,opt),pi=xy.pop();
  if(up) {
    var y,by,n;
    for(y=0;by=board[y];y++) {
      for(x=0;ch=by[x];x++) 
        if(_xo(ch)) {
          n=_next(x,y,b,opt);
          if(!(cy=board[ny=n[1]])||!_xo(cy[nx=n[0]])||_blocked(x,y,nx,ny)) {
            xy=_shiftxy(x,y,b,opt),pi=xy.pop();
            _fall(xy,pi);
          }
        }
    }
    sele=[];
    _moves(1);
    _drawboard();
    _beep();
  } else {
    sele=[];
    for(j=0;j<xy.length;j+=2) if(xy.length==2||xy[j]!=px||xy[j+1]!=py) sele.push(xy[j],xy[j+1]);
    _drawboard();
  }
  return [px,py,[b,opt],i];
}

function _drect(px,py,mx,my,c) {
  var x,y,b,r;
  if(px>mx) r=px,px=mx,mx=r;
  if(py>my) r=py,py=my,my=r;
  for(y=py;y<=my;y++) {
    if(b=board[y]) 
      if(c<0) {
        sele.push(px,y),sele.push(mx,y);
        if(y==py||y==my) for(x=px+1;x<mx;x++) sele.push(x,y);
      } else for(x=px;x<=mx;x++)
        b[x]=c;
  }
}
function _peg(x,y) {
  if(deca) {
    var d=(x+2)%3,cx=(x+2-d)/3;
    var sx=brd+(cx+(y&1)/2)*cell8x,sy=brd+((1+y*3)/4)*cell8y,x2=cell8x/2,y2=cell8y/4,r=y2*3/4-2,bx,by,px=sx+x2,py=sy+2*y2;
    if(d==1) bx=x2,by=0;
    else if(d==2) bx=-x2/2,by=3*y2/2;
    else bx=-x2/2,by=-3*y2/2;
    return [px+1.06*bx/2,py+1.06*by/2,r];
  } else if(trap) {
    var d=(x+1)%2,cx=(x+1)>>1,dd=(cx+2*(y&1))%3+3*d;
    var sx=brd+(cx+(y&1)/2)*cell8x,sy=brd+((1+y*3)/4)*cell8y,x2=cell8x/2,y2=cell8y/4,r2=cell8x/5;
    return dd==1?[sx+x2-x2/2,sy+2*y2,r2]:dd==2?[sx+x2-x2*2/8,sy+2*y2-y2*6/8,r2]:dd==3?[sx+x2+x2*2/8,sy+2*y2-y2*6/8,r2]
      :dd==4?[sx+x2+x2/2,sy+2*y2,r2]:dd==5?[sx+x2+x2*2/8,sy+2*y2+y2*6/8,r2]:[sx+x2-x2*2/8,sy+2*y2+y2*6/8,r2];
  } else if(delta) {
    var r=(x+2)%3,cx=((x+2-r)/3)|0,d=1^(y&1)^(cx&1),dy=d?-1:1,r2=cell9x/7;
    var sx=brd+cx*cell9x/2,sy=brd+(y+d)*cell9y,y2=sy+dy*cell9y,y3=(2*sy+y2)/3,y4=(sy+y2)/2,x4=sx+cell9x/2;
    return r==1?[x4,(5*y3+3*y2)/8,r2]:r==2?[(5*x4+3*(sx+cell9x))/8,(5*y3+3*sy)/8,r2]:[(5*x4+3*sx)/8,(5*y3+3*sy)/8,r2];
  } else if(cubes) {
    var d=(x+2)%3,cx=(x+2-d)/3;
    var sx=brd+(cx+(y&1)/2)*cell8x,sy=brd+((1+y*3)/4)*cell8y,x2=cell8x/2,y2=cell8y/4,r=y2*3/4-2;
    return d?d==1?[sx+x2/2,sy+5*y2/2,r]:[sx+3*x2/2,sy+5*y2/2,r]:[sx+x2,sy+y2,r];
  } else if(penta) {
    var d=4.5,cx=(x+1)/2|0,x1=x&1,sx=brd+cx*cell7,sy=brd+y*cell7,v=(cx+y)&1,c2=cell7/2,c4=c2/2;
    return [sx+(v?x1?c4-d:c2+c4+d:c2),sy+(v?c2:x1?c4-d:c2+c4+d),c4+2];
  } else if(tria2) {
    var xy=_points2(x,y),sx=(45*xy[0]+19*(xy[2]+xy[4]-xy[0]))/64,sy=(45*xy[1]+19*(xy[3]+xy[5]-xy[1]))/64;
    return [sx,sy,cell*9/32];
  } else if(tria4) {
    var xy=_points5(x,y),sx=(26*xy[0]+19*(xy[2]+xy[4]))/64,sy=(26*xy[1]+19*(xy[3]+xy[5]))/64;
    return [sx,sy,cell*8/32];
  } else if(tria) {
    var d=1^(y&1)^(x&1),dy=d?-1:1,sx=brd+(x+1)*cell3x/2,sy=brd+(y+d)*cell3y;
    return [sx,sy+dy*cell3y/3,cell3y*36/128];
  } else if(hexa) {
    var sx=brd+(x+(y&1)/2)*cell6y,sy=brd+((1+y*3)/4)*cell6x,x2=cell6y/2,y2=cell6x/4;
    return [sx+x2,sy+y2,x2-3];
  } else return [brd+(x+0.5)*cell,brd+(y+0.5)*cell,cell/2-3];
}

function _d2(dx,dy) { return dx*dx+dy*dy;}
function _dcircl(px,py,mx,my,c,p2) {
  var s=_peg(px,py),t=_peg(mx,my);
  _dcircl2(s[0],s[1],t[1],t[1],c,p2);
}

function _dcircl2(px,py,mx,my,c,p2,circ) {
  var ix,iy,x,y,sx,sy,r,r1,x2,y2,px,py,mx,my,ml,l=[],l2;
  if(p2) {
    sx=(px+mx)/2,sy=(py+my)/2,r=_d2(sx-mx,sy-my)+1;
  } else sx=px,sy=py,r=_d2(sx-mx,sy-my)+1;
  r1=Math.sqrt(r);
  ml=_mxy({offsetX:sx+r1,offsetY:sy+r1});
  _extent(ml[0]+1,ml[1]+1);
  for(y=1;y+1<board.length;y++) {
    for(x=1,l2=l,l=[],b=board[y];x+1<b.length;x++) {
      s=_peg(x,y);
      if(_d2(sx-s[0],sy-s[1])<r) {
        if(c<0||circ) l[x]=1;
        else b[x]=c;
      }
    }
    if(c<0||circ) for(x=1;x+1<b.length;x++) {
      if(l2[x]==1&&(!l[x-1]||!l[x]||!l[x+1])) c<0?sele.push(x,y-1):board[y-1][x]=c;
      if(l[x]&&(!l[x-1]||!l[x+1]||!l2[x-1]||!l2[x]||!l2[x+1])) c<0?(l[x]=2,sele.push(x,y)):board[y][x]=c;
    }
  }
  return [ml[0]+1,ml[1]+1];
}

function _dfill(px,py,c,k) {
  if(py<1||py+1>board.length) return;
  var b=board[py],s=b[px],fifo=[px,py],n=0,x,y,r,m,dx,dy,u,d,a,t,f,nc=c<0?c-1:c;
  var bf=deca?_border7:trap?_border11:delta?_border9:cubes?_border8:tria4?_border5:tria2?_border2:tria?_border3:hexa?_border16:penta?_border15:_border4;
  if(s==c) return;
  board[py][px]=nc;
  while(n<fifo.length) {
    x=x1=fifo[n],y=fifo[n+1],n+=2,b=board[y],m=fifo.length,u=y>1,d=y+1<board.length;
    t=0;
    var i,d=bf(x,y),l=d.length,x2,y2;
    for(i=0;i<l;i+=2) {
      f=0,x2=x+d[i],y2=y+d[i+1];
      if(y2>0&&y2<board.length&&(f=board[y2][x2])==s&&(k||!_blocked(x,y,x2,y2))) t++,fifo.push(x2,y2);
      else if(f==nc||f=='f') t++;
    }
    if(c<0&&t==(penta?5:hexa||deca?6:tria||tria2||tria4?3:4)) 
       board[fifo[n-1]][fifo[n-2]]='f';
    for(;m<fifo.length;m+=2)
      board[fifo[m+1]][fifo[m]]=nc;
  }
  if(c<0) for(m=0;m<fifo.length;m+=2) {
    f=board[y=fifo[m+1]][x=fifo[m]];
    board[y][x]=s;
    if(f!='f') sele.push(x,y);
  }
}
function _design(e) { return design==7?7:e.ctrlKey?e.shiftKey?4:1:design;}
function _extx() {
  for(y in board) if(board[y][0]!=' ') return 1;
  return 0;
}
function _exty() {
  var b0=board[0];
  for(x in b0) if(b0[x]!=' ') return 1;
  return 0;
}
var dm9c,dm10c;
function _mdesign(dm,up,mu,ev) {
 if(!dm) return;
 var lx=mu[0],ly=mu[1];
 if(dm!=8) {
   if(up) {
     if(lx<1||_extx()) lx=1,_extentx(),mp[0]++;
     if(ly<1||_exty()) ly=1,_extenty(),mp[1]++;
   }
   if(lx>0&&ly>0&&(!board[ly+1]||!board[ly][lx+1])) e=_extent(lx,ly);
 }
 var e,px=mp[0],py=mp[1],ex=lx,ey=ly;
 if(dm==7) {
   if(mu[7]>=0) {
     var a=mp[8]&(1<<mp[7]),i=mu[7],m=1<<i,r=_dub1(lx,ly,i),m2=1<<r[2];
     if(a) _rstblock(lx,ly,m),_rstblock(r[0],r[1],m2);else _setblock(lx,ly,m),_setblock(r[0],r[1],m2);
   }
 } else if(dm==8) {
   _dshift(px,py,mu,up?1:-1);
 } else if(dm==9) {
   var c;
   if(up<0) {
     if(ev.shiftKey) dm9c=_getuco(lx,ly),dm9c=dm9c==f.uco.value||!dm9c?0:(f.uco.value=dm9c);
     else dm9c=f.uco.value;
   }
   _setuco(lx,ly,dm9c);
 } else if(dm==10) {
   var c;
   if(up<0) {
     if(ev.shiftKey) dm10c=_getpgc(lx,ly),dm10c=dm10c==f.uco.value||!dm10c?0:(f.uco.value=dm10c);
     else dm10c=f.uco.value;
   }
   _setpgc(lx,ly,dm10c);
 } else if(dm==1||px==lx&&py==ly) {
    var c=board[py][px],y;
    e=_extent(lx,ly);
    if(up) {
      if(lx==px&&ly==py) {
        var wh=f.white.checked;
        board[ly][lx]=ev&&ev.ctrlKey?wh?c=='o'?'w':'o':c=='o'?' ':'o':c=='o'?wh?'w':'x':c=='w'?'x':c=='x'?' ':'o';
      } else board[ly][lx]=c;
    } else {
      if(Math.abs(mm[0]-lx)>1||Math.abs(mm[1]-ly)>1) _dline(mm[0],mm[1],lx,ly,c);
      else if(ly>=0) board[ly][lx]=c;
    }
 } else {
   sele=[];
   var c=up?board[py][px]:-1;
   if(dm==4||dm==5) e=_dcircl2(mp[5],mp[6],mu[5],mu[6],c,dm==5,ev.shiftKey),ex=e[0],ey=e[1];
   else if(dm==6) _dfill(lx,ly,c,0);
   else if(dm==3) _drect(px,py,lx,ly,c);
   else _dline3(mp[5],mp[6],mu[5],mu[6],c);
   //else _dline(px,py,lx,ly,c);
 }
 _resizea(2*ex+(ey&1),ey);
 _drawboard();
}
function _mmove(e,d) {
  if(!e.buttons||!mp) return;
  var xy=_mxy(e),mm2=mm,b=board[xy[1]],bp=board[mp[1]],bc=bp&&bp[mp[0]],dm,r,x7;
  if(design==7) x7=1,xy[7]=_idx(xy[5],xy[6],_points(xy[0],xy[1]),0,128);
  if(design==8) x7=1,xy[7]=_idx(xy[5],xy[6],_points(xy[0],xy[1]),tria?2:0);
  if((faller||shifter)&&!design) x7=1,xy[7]=_idx(xy[5],xy[6],trap?_points11h(xy[0],xy[1]):_points(xy[0],xy[1]),trap?diag:2)
  dm=_design(e);
  if(dm==5||dm==6) {
    if(!d) {
      r=_d2(xy[5]-mm[5],xy[6]-mm[6]);
      if(r==0) return;
      if(!mm1) mm1=[+new Date()];
      mm1[1]={buttons:e.buttons,offsetX:e.offsetX,offsetY:e.offsetY,shiftKey:e.shiftKey,ctrlKey:e.ctrlKey};
      return;
    }
  } else if((design==7&&xy[7]==-1)||(xy[0]==mm[0]&&xy[1]==mm[1]&&(!x7||xy[7]==mm[7]))) return;
  mm=xy,mm1=0;
  if(dm) _mdesign(dm,0,xy,e);
  else if(shifter) _shifter(0,xy,e); 
  else if(faller) _faller(0,xy,e); 
}

function _full() {
  var x,y,b;
  for(y=1;y+1<board.length;y++)
    for(x=1,b=board[y];x<b.length;x++)
      if(b[x]=='x') return 0;
  return 1;
}

function _fullxy(x,y) {
  if(!_xo(board[y][x])) return 0;
  var d={},f=[x,y],i=0,x2,y2,k,c,b;
  d[''+x+':'+y]=1;
  while(i<f.length) {
    if(i>64) f.splice(0,i),i=0;
    x2=f[i++],y2=f[i++];
    var jp=_jumpsx()(x2,y2),n=_jumpsl(jp);
    for(j=0;j<n;j++) {
      x=x2+jp[j][0],y=y2+jp[j][1];
      if(_blocked(x2,y2,x,y)) continue;
      c=(b=board[y])&&b[x];
      if(c=='x') return 0;
      if((c=='o'||c=='w')&&!d[k=''+x+':'+y]) d[k]=1,f.push(x,y);
    }
  }
  return 1;
}

function _can(x,y,dx,dy) {
  if(!diag&&dx) dy=0;
  if(!dx&&!dy) return 0;
  var c,d,b0=board[y],b1=board[y+dy],b2=board[y+2*dy];
  return !!(b0&&b1&&b2&&((c=b0[x])=='o'||c=='w')&&((d=b1[x+dx])=='o'||d=='w')&&b2[x+2*dx]=='x');
}

function _add2(px,py,xy) {
  var i;
  for(i=0;i<xy.length;i+=2) xy[i]+=px,xy[i+1]+=py;
  return xy;
}
function _jumps5(px,py) {
  var r=(((1^py)&1)<<1)|(1^px&1);
  if(r==0) return [[+1,0,+1,+1],[0,+1,+1,+1],[-1,+1,-1,0],[-1,+1,-2,+1],[+1,0,0,-1],[0,+1,+1,+2] ,[-1,1,-2,0],[1,1,2,0]];
  else if(r==1) return [[0,1,-1,1],[-1,0,-1,1],[-1,-1,-1,-2],[-1,-1,0,-1],[0,1,+1,0],[-1,0,-2,1] ,[-1,1,0,2],[-1,-1,0,-2]];
  else if(r==2) return [[0,-1,+1,-1],[1,0,1,-1],[+1,+1,0,1],[1,1,+1,+2],[0,-1,-1,0],[1,0,2,-1] ,[1,-1,0,-2],[1,1,0,2]];
  else if(r==3) return [[0,-1,-1,-1],[-1,0,-1,-1],[+1,-1,+2,-1],[1,-1,+1,0],[0,-1,-1,-2],[-1,0,0,+1] ,[-1,-1,-2,0],[1,-1,2,0]];
} 
function _jumps15(x,y) {
  var cx=(x+1)/2|0,x1=x&1,v=(cx+y)&1;
  if(v) {
    if(x1) return [[-2,0,-3,0],[-2,0,-2,-1],[1,-1,0,-1],[1,-1,2,-1],[1,0,2,0],[1,0,3,0],[0,1,1,1],[0,1,2,1],[-1,0,-3,0],[-1,0,-2,1] // [-2,0,-3,-1],[-1,0,-4,1],[-1,-1,-1,-2],[-1,1,-2,2]];
                  ,[-2,0,-1,-1],[1,-1,-1,-1],[1,0,1,-1],[0,1,-1,1],[-1,0,-1,1]];// ,[-2,0,-1,0],[1,-1,1,0],[1,0,0,1],[0,1,1,0],[-1,0,-2,0]];
    return [[0,-1,-1,-1],[0,-1,-2,-1],[1,0,3,0],[1,0,2,-1],[2,0,3,0],[2,0,2,1],[-1,1,0,1],[-1,1,-2,1],[-1,0,-2,0],[-1,0,-3,0] // [1,0,4,-1],[2,0,3,1],[1,-1,2,-2],[1,1,1,2]];
                  ,[0,-1,1,-1],[1,0,1,-1],[2,0,1,1],[-1,1,1,1]]; // ,[0,-1,-1,0],[1,0,2,0],[2,0,1,0],[-1,1,-1,0],[-1,0,-1,1],[-1,0,0,-1]];
  } else {
    if(x1) return [[-1,0,-2,0],[-1,0,-2,1],[0,-1,1,-2],[0,-1,-2,-1],[1,-1,1,-2],[1,-1,2,-1],[2,0,3,0],[2,0,2,1],[1,0,1,1],[1,0,0,1]
                  ,[-1,0,-1,-1],[0,-1,-1,-1],[1,-1,3,-1],[2,0,3,-1]];
    return [[-1,1,-1,2],[-1,1,-2,1],[-2,0,-3,0],[-2,0,-2,-1],[-1,0,-1,-1],[-1,0,0,-1],[1,0,2,0],[1,0,2,-1],[0,1,-1,2],[0,1,2,1]
                  ,[-1,1,-3,1],[-2,0,-3,1],[1,0,1,1],[0,1,1,1]];
  }
}

function _jumps6(x,y) {
  var ex=y&1?0:-1;
  return [[-1,0,-2,0],[1,0,2,0],[ex,-1,-1,-2],[ex+1,-1,1,-2],[ex,1,-1,2],[ex+1,1,1,2]
         ,[-1,0,ex-1,-1],[-1,0,ex-1,1],[1,0,ex+2,-1],[1,0,ex+2,1]
         ,[ex,-1,ex-1,-1],[ex,-1,0,-2],[ex+1,-1,ex+2,-1],[ex+1,-1,0,-2]
         ,[ex,1,ex-1,1],[ex,1,0,2],[ex+1,1,ex+2,1],[ex+1,1,0,2]];
}
function _jumps4(x,y) {
  return [[-1,0,-2,0],[1,0,2,0],[0,-1,0,-2],[0,1,0,2]
         ,[-1,0,-1,-1],[-1,0,-1,1],[1,0,1,-1],[1,0,1,1]
         ,[0,-1,-1,-1],[0,-1,1,-1],[0,1,-1,1],[0,1,1,1]];
}

function _jumps8(x,y) {
  var d=(x+2)%3,cx=(x+2-d)/3,dx=y&1?0:-3;
  if(d==1) return [[-2,0,-3,0],[1,0,3,0],[-1,0,dx+3,-1],[dx-1,1,dx,1],[1,0,dx+2,1],[dx-1,1,dx+1,1],[-2,0,-4,0],[-1,0,dx+1,-1]];
  if(d==2) return [[-2,0,dx,-1],[2,0,3,0],[dx+1,1,dx+3,1],[-1,0,-3,0],[-2,0,dx+2,-1],[2,0,1,0],[dx+1,1,dx+2,1],[-1,0,dx-2,1]];
  return [[1,0,dx,+1],[dx+2,-1,dx,-1],[dx+4,-1,dx+3,-1],[2,0,dx+3,1],[1,0,-1,0],[dx+2,-1,dx+1,-1],[dx+4,-1,dx+5,-1],[2,0,4,0]];
}

function _jumps7(x,y) {
  var d=(x+2)%3,cx=(x+2-d)/3,dx=y&1?0:-3;
  if(d==1) return [[4,0,3,0],[4,0,dx+5,1],[dx+2,1,dx+3,1],[dx+2,1,dx+4,1],[1,0,dx,1],[1,0,dx-1,1],[1,0,-3,0],[-1,0,-3,0],[-1,0,dx+1,-1],[-1,0,dx,-1],[dx+4,-1,dx+2,-1],[dx+4,-1,dx+3,-1],[2,0,dx+7,-1],[2,0,3,0]
    ,[4,0,dx+3,1],[dx+2,1,dx,1],[dx+4,-1,dx,-1],[2,0,dx+3,-1]];
  if(d==2) return [[dx-2,1,dx,1],[dx-2,1,dx-4,1],[-4,0,-3,0],[-4,0,-5,0],[-2,0,dx,-1],[-2,0,dx-1,-1],[-2,0,dx+3,-1],[-1,0,dx+3,-1],[-1,0,1,0],[-1,0,3,0],[dx+1,1,dx+2,1],[dx+1,1,dx+3,1],[dx-1,1,-2,2],[dx-1,1,dx,1]
    ,[dx-2,1,-3,0],[-4,0,dx,-1],[dx+1,1,3,0],[dx-1,1,dx+3,1]];
  return [[dx+1,-1,dx,-1],[dx+1,-1,2,-2],[dx+5,-1,dx+3,-1],[dx+5,-1,dx+4,-1],[1,0,3,0],[1,0,5,0],[1,0,dx+3,1],[2,0,dx+3,1],[2,0,dx,1],[2,0,dx+1,1],[-2,0,-1,0],[-2,0,-3,0],[dx+2,-1,dx-2,-1],[dx+2,-1,dx,-1]
   ,[dx+1,-1,dx+3,-1],[dx+4,-1,3,0],[-2,0,dx,1],[dx+2,-1,-3,0]];
}

function _jumps9(x,y) {
  var r=(x+2)%3,cx=(x+2-r)/3,d=1^(y&1)^(cx&1),dy=d?-1:1;
  if(d) {
    if(r==1) return [[-1,0,-1,-dy],[1,0,1,-dy],[2,0,4,0],[-2,0,-4,0],[-2,0,-2,dy],[2,0,2,dy] ,[-2,0,-3,0],[-1,0,-3,0],[1,0,3,0],[2,0,3,0]];
    if(r==2) return [[2,0,3,0],[-1,0,-3,0],[-2,0,-4,0],[0,-dy,-1,-dy],[0,-dy,2,-dy],[2,0,4,0] ,[-2,0,-2,-dy],[0,-dy,-2,-dy],[2,0,1,0],[-1,0,1,0]];
    return [[-2,0,-3,0],[0,-dy,1,-dy],[2,0,4,0],[1,0,3,0],[-2,0,-4,0],[0,-dy,-2,-dy] ,[-2,0,-1,0],[0,-dy,2,-dy],[2,0,2,-dy],[1,0,-1,0]];
    return [[]];
  } else {
    if(r==1) return [[-1,0,-1,-dy],[1,0,1,-dy],[2,0,4,0],[-2,0,-4,0],[-2,0,-2,dy],[2,0,2,dy] ,[-2,0,-3,0],[-1,0,-3,0],[1,0,3,0],[2,0,3,0]];
    if(r==2) return [[2,0,3,0],[-1,0,-3,0],[-2,0,-4,0],[0,-dy,-1,-dy],[0,-dy,2,-dy],[2,0,4,0] ,[-2,0,-2,-dy],[0,-dy,-2,-dy],[2,0,1,0],[-1,0,1,0]];
    return [[-2,0,-3,0],[0,-dy,1,-dy],[2,0,4,0],[1,0,3,0],[-2,0,-4,0],[0,-dy,-2,-dy] ,[-2,0,-1,0],[0,-dy,2,-dy],[2,0,2,-dy],[1,0,-1,0]];
  }
}

function _jumps11(x,y) {
  var d=(x+1)%2,cx=(x+1)>>1,dd=(cx+2*(y&1))%3+3*d,dx=y&1?0:-2;
  console.log(x,y,dd);
  if(dd==1) return [[dx,1,dx-1,1],[-1,0,dx-1,-1],[dx+1,-1,dx,-1],[1,0,2,0] ,[dx,1,-2,0],[dx,1,dx+1,1],[-1,0,-2,0],[dx+1,-1,dx+2,-1],[1,0,dx+2,-1],[1,0,dx+3,1]];
  if(dd==2) return [[-1,0,-2,0],[dx,-1,dx-1,-1],[dx+2,-1,1,-2],[1,0,dx+2,1] ,[-1,0,dx+1,1],[dx,-1,dx+1,-1],[dx+2,-1,dx+1,-1],[dx+2,-1,dx+3,-1],[1,0,2,0],[1,0,dx+1,1]];
  if(dd==3) return [[dx,-1,-1,-2],[dx+2,-1,dx+3,-1],[1,0,2,0],[-1,0,dx,1] ,[dx,-1,dx-1,-1],[dx,-1,dx+1,-1],[dx+2,-1,dx+1,-1],[1,0,dx+1,1],[-1,0,dx+1,1],[-1,0,-2,0]];
  if(dd==4) return [[dx+1,-1,dx+2,-1],[1,0,dx+3,-1],[dx+2,1,dx+3,1],[-1,0,-2,0] ,[dx+1,-1,dx,-1],[1,0,2,0],[dx+2,1,2,0],[dx+2,1,dx+1,1],[-1,0,dx-1,1],[-1,0,dx,-1]];
  if(dd==5) return [[1,0,dx+3,1],[dx+1,1,-1,2],[dx,1,dx-1,1],[-1,0,dx-1,-1],[1,0,2,0],[1,0,dx+2,1],[dx+1,1,dx+2,1],[dx,1,-2,0],[-1,0,-2,0],[-1,0,dx+1,-1]];
  return [[dx+2,1,dx+3,1],[dx+1,1,1,2],[-1,0,dx-1,1],[1,0,dx+3,-1] ,[dx+2,1,2,0],[dx+1,1,dx,1],[-1,0,-2,0],[-1,0,dx,1],[1,0,dx+1,-1],[1,0,2,0]];
/*  if(dd==1) return [dx,1,-1,0,dx+1,-1,1,0];
  if(dd==2) return [-1,0,dx,-1,dx+2,-1,1,0];
  if(dd==3) return [dx,-1,dx+2,-1,1,0,-1,0];
  if(dd==4) return [dx+1,-1,1,0,dx+2,1,-1,0];
  if(dd==5) return [1,0,dx+1,1,dx,1,-1,0];
  return [dx+2,1,dx+1,1,-1,0,1,0];*/
}

function _jumps3(x,y) {
  var d=(y^x)&1,dy=d?-1:1;
  return [[-1,0,-2,0],[-1,0,-1,-dy],[1,0,2,0],[1,0,1,-dy],[0,dy,-1,dy],[0,dy,1,dy] 
    ,[-2,dy,-3,dy],[2,dy,3,dy],[0,-dy,0,-2*dy] ,[-1,0,-3,-dy],[1,0,3,-dy],[0,dy,0,2*dy]];
}

function _jumps2(x,y) {
  var xx=(x+1+2*(y&1))&3;
  if(xx==0) return [[-1,0,-2,0],[-1,0,-1,-1],[0,-1,-1,-1],[0,-1,1,-1],[1,0,1,1],[1,0,2,0] ,[-1,-1,-2,-1],[1,0,2,1]];
  if(xx==1) return [[-1,0,-2,0],[-1,0,-1,-1],[0,1,-1,1],[0,1,1,1],[1,0,1,1],[1,0,2,0] ,[-1,0,-2,-1],[1,1,2,1]];
  if(xx==2) return [[-1,0,-2,0],[-1,0,-1,1],[1,0,1,-1],[1,0,2,0],[0,1,-1,1],[0,1,1,1] ,[-1,1,-2,1],[1,0,2,-1]];
  if(xx==3) return [[-1,0,-2,0],[-1,0,-1,1],[0,-1,1,-1],[0,-1,-1,-1],[1,0,2,0],[1,0,1,-1] ,[1,-1,2,-1],[-1,0,-2,1]];
  return [];
  
}
function _jumpsx() {
  return deca?_jumps7:trap?_jumps11:tria4?_jumps5:tria2?_jumps2:tria?_jumps3:hexa?_jumps6
          :delta?_jumps9:cubes?_jumps8:penta?_jumps15:_jumps4;
}
function _jumpsl(ja) {
  return diag?ja.length:deca?14:trap?4:quad?4:hexa?6:cubes?4:delta?6:tria?6:tria2||tria4?6:10;
}
function _jumps(px,py,dx,dy) {
  var d,ex,qx,qy,rx,ry,j;
  if(deca) return _add2(px,py,_jumps7(px,py)[dx]);
  if(trap) return _add2(px,py,_jumps11(px,py)[dx]);
  if(delta) return _add2(px,py,_jumps9(px,py)[dx]);
  if(cubes) return _add2(px,py,_jumps8(px,py)[dx]);
  if(penta) return _add2(px,py,_jumps15(px,py)[dx]);
  if(hexa) return _add2(px,py,_jumps6(px,py)[dx]);
  if(tria4) return _add2(px,py,_jumps5(px,py)[dx]);
  if(quad) return _add2(px,py,_jumps4(px,py)[dx]);
  if(tria) return _add2(px,py,_jumps3(px,py)[dx]);
  if(tria2) return _add2(px,py,_jumps2(px,py)[dx]);
  if(tria2) {
    if(dy&&!dx) { 
      var dd=(1^px^py^((px+1)>>1))&1?1:-1,sy=dy<0?-1:1;
      rx=((px+1)^1)-1,ry=py+dy;
      if(dd==sy) qx=px,qy=ry;else qx=rx,qy=py;
    } else if(dx&&!dy) { qx=px+dx;rx=qx+dx;qy=ry=py;}
    else {
      var dd=(px^py^(px>>1))&1,dx2=dx<0?-1:1,dy2=dy<0?-1:1;
      rx=px+dx2,ry=py+dy2;
      if(Math.abs(dx)>Math.abs(dy)) qx=rx,qy=py;else qy=ry,qx=px; 
    }
  } else if(tria) {
    qy=py,ry=py+dy;
    if(dy) {
      var dd=(px&1)^(py&1)^(dy>0);
      rx=px+dx;
      if(dd) qy+=dy,qx=px;else qy=py,qx=px+dx;
    } else qx=px+dx,rx=qx+dx;
  }
  return [qx,qy,rx,ry];
}

function _can6(x,y,dx,dy) {
  var qr=_jumps(x,y,dx,dy);
  var b=board[y],b1=board[qr[1]],b2=board[qr[3]],c=b&&b[x],c1,c2;
  c1=b1&&b1[qr[0]],c2=b2&&b2[qr[2]];
  return !!((c=='o'||c=='w')&&(c1=='o'||c1=='w')&&c2=='x');
}
function _can5(x,y,qx,qy,rx,ry) {
  var b=board[y],b1=board[qy],b2=board[ry],c=b&&b[x],c1,c2;
  c1=b1&&b1[qx],c2=b2&&b2[rx];
  if(!((c=='o'||c=='w')&&(c1=='o'||c1=='w')&&c2=='x')) return 0;
  return !(block&&(_blocked(x,y,qx,qy)||_blocked(qx,qy,rx,ry)));
}
//function _can3(x,y,dx,dy) { return _can6(x,y,dx,dy);}

function _switch(x,y) {
  var c=board[y][x],c2=c=='o'?'w':c=='w'?'o':c;
  if(c2!=c) board[y][x]=c2;
}
function _switchP(x,y,px,py) {
  var c=board[y][x],c2=c=='o'?'w':c=='w'?'x':c=='x'?'o':c;
  if(c2!=c) board[y][x]=c2;
}
function _switchN(x,y,px,py) {
  var c=board[y][x],c2=c=='o'?'x':c=='w'?'o':c=='x'?'w':c;
  if(c2!=c) board[y][x]=c2;
}

/* function _switch9(x,y,mask) {
  var a=mask&2,b=mask&4,c=mask&1,xy=[];
  if(a) xy.push(x,y-1,x,y+1,x-1,y,x+1,y);
  if(b) xy.push(x+1,y-1,x+1,y+1,x-1,y-1,x-1,y+1);
  return _switchi(x,y,xy,u);
} */

function _border2(x,y) {
  var xx=(x+1+2*(y&1))&3,r;
  if(xx==0) return [-1,0,0,-1,1,0];
  if(xx==1) return [1,0,0,1,-1,0];
  if(xx==2) return [0,1,-1,0,1,0];
  return [0,-1,1,0,-1,0];
}

function _switch2(x,y,mask,d,u) {
  var xy=[],dy=(1^x^y^((x+1)>>1))&1?1:-1;
  if(!_blocked(x,y,x,y+dy)) xy.push(x,y+dy);
  if(!_blocked(x,y,x-1,y)) xy.push(x-1,y);
  if(!_blocked(x,y,x+1,y)) xy.push(x+1,y);
  return _switchi(x,y,xy,u);
}

function _border5(x,y) {
  var r=(((1^y)&1)<<1)|(1^x&1);
  if(r==1) return [0,1,-1,0,-1,-1];
  else if(r==2) return [0,-1,1,0,1,1];
  else if(r==3) return [-1,0,0,-1,1,-1];
  else return [1,0,0,1,-1,1];
}

function _switch5(x,y,mask,d,u) {
  var i,a,r=(((1^y)&1)<<1)|(1^x&1),xy=[];
  if(r==0) a=[x-1,y+1,x+1,y,x,y+1];
  else if(r==1) a=[x-1,y,x-1,y-1,x,y+1];
  else if(r==2) a=[x,y-1,x+1,y+1,x+1,y];
  else if(r==3) a=[x-1,y,x,y-1,x+1,y-1];
  //if(r==0) _f2(x-1,y+1),_f2(x+1,y),_f2(x,y+1);
  //else if(r==1) _f2(x-1,y),_f2(x-1,y-1),_f2(x,y+1);
  //else if(r==2) _f2(x,y-1),_f2(x+1,y+1),_f2(x+1,y);
  //else if(r==3) _f2(x-1,y),_f2(x,y-1),_f2(x+1,y-1);
  if(a) for(i=0;i<6;i+=2)
    if(!_blocked(x,y,a[i],a[i+1])) xy.push(a[i],a[i+1]);
  return _switchi(x,y,xy,u);
}

function _switch4(x,y,mask,d,u) {
  var xy=[],dy=1^(x&1)^(y&1)?1:-1;
  if(!_blocked(x,y,x,y+dy)) xy.push(x,y+dy);
  if(!_blocked(x,y,x-1,y)) xy.push(x-1,y);
  if(!_blocked(x,y,x+1,y)) xy.push(x+1,y);
  return _switchi(x,y,xy,u);
}

function _border13(x,y,f) {
  var d=1^(y&1)^(x&1);
  return d?[0,1,1,1,-1,1,-2,1,-3,1,1,2,0,2,-1,2 ,-1,0,-2,0,-1,-1,0,-1,0,-2,-3,0,-3,-1,-2,-1 ,1,0,1,-1,2,0,2,1,3,1,2,-1,3,-1,3,0 ]
   :[0,-1,-1,-1,1,-1,2,-1,3,-1,-1,-2,0,-2,1,-2 ,1,0,2,0,1,1,0,1,0,2,3,0,3,1,2,1 ,-1,0,-1,1,-2,0,-2,-1,-3,-1,-2,1,-3,-1,-3,0 ]
}

function _switch3(x,y,mask,d,u) {
  var i,x2,y2,m,xy=[],b=_border13(x,y);
  for(i=2*d,m=1;m<0x1000000;i+=i==46?-46:2,m<<=1) 
   if(mask&m) if(!_blocked(x,y,x2=x+b[i],y2=y+b[i+1])) xy.push(x2,y2);
  return _switchi(x,y,xy,u);
}

function _switchi(x,y,xy,u) {
  var swP=u?_switchN:_switchP,swN=u?_switchP:_switchN;
  var i,x2,y2,xyc=[],c,_f1=ooc?swN:oo3?swP:_switch,_f2=oo3?swP:_switch;
  if(!ooo) _f1(x,y);
  c=_getpgc(x,y);
  for(i=0;i<xy.length;i+=2) {
    _f2(x2=xy[i],y2=xy[i+1]);
    if(!u) xyc.push(x2,y2,_getpgc(x2,y2)),_setpgc(x2,y2,c);
  }
  if(u) for(i=0;i<u.length;i+=3) _setpgc(u[i],u[i+1],u[i+2]);
  return u||xyc;
}

function _border14(x,y,f) {
  return [-1,0,-1,-1,0,-1,1,-1,1,0,1,1,0,1,-1,1];//:[-1,0,0,-1,1,0,0,1];
}

function _switch14(x,y,mask,d,u) {
  var i,x2,y2,m,xy=[],b=_border14(x,y);
  for(i=2*d,m=1;m<256;i+=i==14?-14:2,m<<=1) 
   if(mask&m) if(!_blocked(x,y,x2=x+b[i],y2=y+b[i+1])) xy.push(x2,y2);
  return _switchi(x,y,xy,u);
}

function _switch15(x,y,mask,d,u) {
  var i,m,x2,y2,xy=[],b=_border15(x,y);
  for(i=2*d,m=1;m<32;i+=i==8?-8:2,m<<=1) 
   if(mask&m) if(!_blocked(x,y,x2=x+b[i],y2=y+b[i+1])) xy.push(x2,y2);
  return _switchi(x,y,xy,u);
}

function _switch16(x,y,mask,d,u) {
  var i,m,x2,y2,xy=[],b=_border16(x,y);
  for(i=2*d,m=1;m<64;i+=i==10?-10:2,m<<=1) 
   if(mask&m) if(!_blocked(x,y,x2=x+b[i],y2=y+b[i+1])) xy.push(x2,y2);
  return _switchi(x,y,xy,u);
}

/*function _switch16old(x,y,mask) {
  var dx=y&1?0:-1,a=mask&2,b=mask&4,c=mask&1,xy=[];
  if(a) xy.push(x-1,y);if(b) xy.push(x+1,y);
  if(b) xy.push(x+dx,y-1);if(a) xy.push(x+dx+1,y+1);
  if(a) xy.push(x+dx+1,y-1);if(b) xy.push(x+dx,y+1);
  return _switchi(x,y,xy,u);
}*/

function _switch7(x,y,mask,d,u) {
  var i,m,xy=[],b=_border7(x,y);
  for(i=2*d,m=1;m<64;i+=i==10?-10:2,m<<=1) 
   if(mask&m) if(!_blocked(x,y,x2=x+b[i],y2=y+b[i+1])) xy.push(x2,y2);
  return _switchi(x,y,xy,u);
}

function _switch11(x,y,mask,d,u) {
  var x2,y2,i,m,xy=[],b=_border11(x,y);
  for(i=2*d,m=1;m<16;i+=i==6?-6:2,m<<=1) 
   if(mask&m) if(!_blocked(x,y,x2=x+b[i],y2=y+b[i+1])) xy.push(x2,y2);
  return _switchi(x,y,xy,u);
}

function _switch18(x,y,mask,d,u) {
  var i,m,xy=[],b=_border18(x,y);
  if((mask&0x8)&&(mask&0x80)) mask^=0x8;
  if((mask&0x800)&&(mask&0x8000)) mask^=0x800;
  for(i=2*d,m=1;m<65536;i+=i==30?-30:2,m<<=1) 
   if(mask&m) if(!_blocked(x,y,x2=x+b[i],y2=y+b[i+1])) xy.push(x2,y2);
  return _switchi(x,y,xy,u);
}

function _switch19(x,y,mask,d,u) {
  var i,m,xy=[],b=_border19(x,y);
  if((mask&0x8)&&(mask&0x80)) mask^=0x8;
  if((mask&0x800)&&(mask&0x8000)) mask^=0x800;
  for(i=2*d,m=1;m<65536;i+=i==30?-30:2,m<<=1) 
   if(mask&m) if(!_blocked(x,y,x2=x+b[i],y2=y+b[i+1])) xy.push(x2,y2);
  return _switchi(x,y,xy,u);
}

function _line23(x,y,m,dx,dy,dic,xy) {
  var px=x,py=y,xy1,v,b,k,n=88;
  m&=3;
  if(!m) m=3;
  if(dx&&dy) {
    for(;n--;) {
      var x2=x,y2=y;
      if(1&(1^x^y^(dy>0)^(1))) y+=dy;else x+=dx;
      if(!(b=board[y])||!_xo(b[x])) break;
      if(_blocked(x2,y2,x,y)) break;
      if(!(m&(1<<(1&(px^py^x^y))))) continue;
      if(!dic[k=_k25(x,y)]) dic[k]=1,xy.push(x,y);
    }
  } else {
    for(;n--;) {
      var x2=x,y2=y;
      x+=dx,y+=dy;
      if(!(b=board[y])||!_xo(b[x])) break;
      if(_blocked(x2,y2,x,y)) break;
      if(!(m&(1<<(1&(px^x))))) continue;
      if(!dic[k=_k25(x,y)]) dic[k]=1,xy.push(x,y);
    }
  }
}

function _switch23(x,y,mask,d,u) {
  var i,j,k,k2,j2,c,b,m,xy=[],dic={};

  var e=1^(y&1)^(x&1),dx=e?-1:1,dy=e?1:-1;
  mask&=0xffffff,mask=(mask<<d)|(mask>>(24-d));

  if(mask&0x03) _line23(x,y,mask&3,-dx,dy,dic,xy);
  if(mask&0x0c) _line23(x,y,(mask>>2)&3,dx,dy,dic,xy);
  if(mask&0x0300) _line23(x,y,(mask>>8)&3,+dx,0,dic,xy);
  if(mask&0x0c00) _line23(x,y,(mask>>10)&3,+dx,-dy,dic,xy);
  if(mask&0x030000) _line23(x,y,(mask>>16)&3,-dx,-dy,dic,xy);
  if(mask&0x0c0000) _line23(x,y,(mask>>18)&3,-dx,0,dic,xy);

  //if(mask&0x01)  for(i=1,k2=x,j2=y;(b=board[j=y+dy*i])&&_xo(b[k=x-dx*i])&&!_blocked(k2,j2,k,j);i++,k2=k,j2=j) _f2(k,j);
  //if(mask&0x02)  for(i=1,k2=x,j2=y;(b=board[j=y+dy*i])&&_xo(b[k=x-dx*(i-1)])&&!_blocked(k2,j2,k,j);i++,k2=k,j2=j) _f2(k,j);
  //if(mask&0x04)  for(i=1,k2=x,j2=y;(b=board[j=y+dy*i])&&_xo(b[k=x+dx*i])&&!_blocked(k2,j2,k,j);i++,k2=k,j2=j) _f2(k,j);
  //if(mask&0x08)  for(i=mask&0x02?2:1,k2=x,j2=y;(b=board[j=y+dy*i])&&_xo(b[k=x+dx*(i-1)])&&!_blocked(k2,j2,k,j);i++,k2=k,j2=j) _f2(k,j);
  if(mask&0x10)  for(i=1;(b=board[j=y-dy*i])&&_xo(b[k=x]);i++) xy.push(k,j);
  //if(mask&0x010000)  for(i=1,k2=x,j2=y;(b=board[j=y-dy*i])&&_xo(b[k=x-dx*i])&&!_blocked(k2,j2,k,j);i++,k2=k,j2=j) _f2(k,j);
  //if(mask&0x020000)  for(i=1,k2=x,j2=y;(b=board[j=y-dy*(i-1)])&&_xo(b[k=x-dx*i])&&!_blocked(k2,j2,k,j);i++,k2=k,j2=j) _f2(k,j);
  //if(mask&0x040000) for(i=1,k2=x,j2=y;_xo(board[y][j=x-dx*2*i])&&!_blocked(k2,j2,k,j);i++,k2=k,j2=j) _f2(j,y);
  //if(mask&0x080000) for(i=mask&0x020000?2:1,k2=x,j2=y;_xo(board[y][j=x-dx*(2*i-1)])&&!_blocked(k2,j2,k,j);i++,k2=k,j2=j) _f2(j,y);
  if(mask&0x100000)  for(i=1;(b=board[j=y+dy*((i+1)>>1)])&&_xo(b[k=x+dx*(((i-1)>>1)*3+3-(i&1))]);i++) xy.push(k,j);
  //if(mask&0x0100) for(i=1,k2=x,j2=y;_xo(board[y][j=x+dx*2*i])&&!_blocked(k2,j2,k,j);i++,k2=k,j2=j) _f2(j,y);
  //if(mask&0x0200) for(i=1,k2=x,j2=y;_xo(board[y][j=x+dx*(2*i-1)])&&!_blocked(k2,j2,k,j);i++,k2=k,j2=j) _f2(j,y);
  //if(mask&0x0400)  for(i=1,k2=x,j2=y;(b=board[j=y-dy*i])&&_xo(b[k=x+dx*i])&&!_blocked(k2,j2,k,j);i++,k2=k,j2=j) _f2(k,j);
  //if(mask&0x0800)  for(i=mask&0x0200?2:1,k2=x,j2=y;(b=board[j=y-dy*(i-1)])&&_xo(b[k=x+dx*i])&&!_blocked(k2,j2,k,j);i++,k2=k,j2=j) _f2(k,j);
  if(mask&0x1000)  for(i=1;(b=board[j=y+dy*((i+1)>>1)])&&_xo(b[k=x-dx*(((i-1)>>1)*3+3-(i&1))]);i++) xy.push(k,j);
  return _switchi(x,y,xy,u);
}

function _switch24(x,y,mask,d,u) {
  var i,j,k,c,b,m,xy=[];

  mask&=255,mask=(mask<<d)|(mask>>(8-d));
  if(mask&1) for(i=1;_xo(board[y][j=x-i])&&!_blocked(j+1,y,j,y);i++) xy.push(j,y);
  if(mask&2)  for(i=1;(b=board[j=y-i])&&_xo(b[k=x-i]);i++) xy.push(k,j);
  if(mask&4)  for(i=1;(b=board[j=y-i])&&_xo(b[x])&&!_blocked(x,j+1,x,j);i++) xy.push(x,j);
  if(mask&8) for(i=1;(b=board[j=y-i])&&_xo(b[k=x+i]);i++) xy.push(k,j);
  if(mask&16)  for(i=1;_xo(board[y][j=x+i])&&!_blocked(j-1,y,j,y);i++) xy.push(j,y);
  if(mask&32)  for(i=1;(b=board[j=y+i])&&_xo(b[k=x+i]);i++) xy.push(k,j);
  if(mask&64)  for(i=1;(b=board[j=y+i])&&_xo(b[x])&&!_blocked(x,j-1,x,j);i++) xy.push(x,j);
  if(mask&128)  for(i=1;(b=board[j=y+i])&&_xo(b[k=x-i]);i++) xy.push(k,j);
  return _switchi(x,y,xy,u);
}

function _line27(x,y,m,dx,dy,dic,xy) {
  var px=x,py=y,x2,y2,xy1,v,b,k,n=88;
  if(dx&&dy) {
    for(;n--;) {
      x3=x,y3=y;
      x++;
      x^=1;
      x--;
      if(!(b=board[y])||!_xo(b[x])||_blocked(x,y,x3,y3)) break;
      if(!dic[k=_k25(x,y)]) dic[k]=1,xy.push(x,y);
      x3=x,y3=y;
      var o=0,x2,y2,xx,xy,i,p=0;
      for(i=1;i<=2;i++) {
	if(m&i) { o++;
	  x++,xy=dx==dy;
	  if((i==1)) x2=x-1+(xy?0:dx),y2=y+(xy?dy:0);
	  else x2=x-1+(xy?dx:0),y2=y+(xy?0:dy);
	  x--;
	  if((b=board[y2])&&_xo(b[x2])&&!_blocked(x2,y2,x3,y3)) {
	    if(!dic[k=_k25(x2,y2)]) dic[k]=1,xy.push(x2,y2);
            if(!_blocked(x2,y2,x+dx,y+dy)) p++;
	  }
        }
      }
      if(!p&&!(m&4)) break;
      x3=x,y3=y;
      x+=dx,y+=dy;
      if(!(b=board[y])||!_xo(b[x])) break;
      if(!dic[k=_k25(x,y)]) dic[k]=1,xy.push(x,y);
    }
  } else {
    var x2=(x+1)&3,x3=(x2^(x2>>1))&1,x4;
    for(;n--;) {
      x3=x,y3=y;
      if(dx) {
        x+=dx,x4=((x+1)^((x+1)>>1))&1;
        if(m==1&&x3!=x4) continue;
        if(m==2&&x3==x4) continue;
      } else {
        x++;
        if((dy>0)^(y&1)^(x&1)^!!(x&2)) x^=1;
        else y+=dy;
        x4=x--;
        if(m==1&&(x4&1)!=(x2&1)) continue;
        if(m==2&&(x4&1)==(x2&1)) continue;
      }
      if(!(b=board[y])||!_xo(b[x])||_blocked(x,y,x3,y3)) break;
      if(!dic[k=_k25(x,y)]) dic[k]=1,xy.push(x,y);
    }
  }
}

function _switch27(x,y,mask,d,u) {
  var dd=1^(y&1)^(x&1),xx=x+1+2*(y&1),x1=xx&1,x2=!!(xx&2),b=board[y],dic={};
  var i,m,xy=[];

  //console.log(x,y,d,x1,x2);
  mask&=0xfffff,mask=(mask<<d)|(mask>>(3-d));
  if(mask&1) _line27(x,y,0,x2?0:x1?1:-1,x2?x1?-1:1:0,dic,xy)
  if(mask&2) _line27(x,y,0,x2?x1?1:-1:0,x2?0:x1?1:-1,dic,xy)
  if(mask&4) _line27(x,y,3,x1?-1:1,x1^x2?-1:1,dic,xy)
  return _switchi(x,y,xy,u);
}

function _line22(x,y,m,dx,dy,dic,xy) {
  var x3,y3,px=x,py=y,r,v,b,k,n=88;
  if(dx&&dy) {
    var r=(((y+1)&1)<<1)|((x+1)&1),u=(x+1)&~1,v=(y+1)&~1,p=dx==dy;
    if(p) r=3&(r>>1)|(r<<1);
    for(;n--;) {
      x3=x,y3=y;
      if(p) {
        r=(r+dx)&3;
        if((r&1)==(dx<0)) {if((r&2?0:1)^(dx<0)) u+=2*dx;else v+=2*dy;}
        x=u+(r&2?1:0)-1,y=v+(r&1)-1;
      } else {
        r=(r+dx)&3;
        if((r&1)==(dx<0)) {if((r&2?0:1)^(dx<0)) u+=2*dx;else v+=2*dy;}
        x=u+(r&1)-1,y=v+(r&2?1:0)-1;
      }
      if(!(b=board[y])||!_xo(b[x])||_blocked(x,y,x3,y3)) break;
      if(!dic[k=_k25(x,y)]) dic[k]=1,xy.push(x,y);
    }
  } else {
    var l,p=0,r2,r=(((y+1)&1)<<1)|((x+1)&1),u=(x+1)&~1,v=(y+1)&~1,o=0,t=dx+dy>0?3:0;
    if(dy) r^=1;
    for(;n--;) {
      if(dx) {
        r=(r+dx)&3;
        if(r==3-t) u+=2*dx;
        if(m==1&&r!=(dx<0?1:2)) continue;
        if(m==2&&r!=(dx<0?2:1)) continue;
      } else {
        r=(r+dy)&3;
        if(r==3-t) v+=2*dy;
        if(m==1&&r!=(dy<0?2:1)) continue;
        if(m==2&&r!=(dy<0?1:2)) continue;
      }
      if(r==3-t) o=0;
      else if(!(m&4)&&(r==t-3)) { if(!o) break;}
      //else o++;
      x3=x,y3=y,l=0;
      x=u+((dy?1:0)^(r&1))-1,y=v+(r&2?1:0)-1;
      if(r==t) l=!p,p=0;
      else {
        if(r==(dx?dx>0?2:1:dy>0?3:0)) {
          r2=(r-2*(dx+dy))&3;
          x3=u+((dy?1:0)^(r2&1))-1,y3=v+(r2&2?1:0)-1;
        }
        l=_blocked(x,y,x3,y3);
      }
      console.log('-',r,t,l,x,y,x3,y3,' m=',m,' o=',o);
      if(!(b=board[y])||!_xo(b[x])||l) {
        if(m==1||m==2||r==0||r==3) break;
        o++;if(o==2) break;
        continue;
      }
      if((r==1||r==2)&&!p) {
        r2=t;
        x3=u+((dy?1:0)^(r2&1))-1,y3=v+(r2&2?1:0)-1;
        if(!_blocked(x,y,x3,y3)) p=1;
      }
      if(!dic[k=_k25(x,y)]) dic[k]=1,xy.push(x,y);
      o=0;
    }
  }
}

function _switch22(x,y,mask,d,u) {
  var r=(((y+1)&1)<<1)|((x+1)&1),dic={};
  var i,m,xy=[];

  //console.log(x,y,d,x1,x2);
  mask&=0x7,mask=(mask<<d)|(mask>>(3-d));
  if(mask&1) _line22(x,y,0,r==0||r==1?1:-1,r==0||r==2?-1:1,dic,xy)
  if(mask&2) _line22(x,y,0,r==0||r==2?1:-1,r==2||r==3?-1:1,dic,xy)
  if(mask&4) _line22(x,y,0,r==0?-1:r==3?1:0,r==1?-1:r==2?1:0,dic,xy)
  return _switchi(x,y,xy,u);
}

function _line21(x,y,i,dic,xy) {
  var x3,y3,px=x,py=y,r,v,b,k,n=88;
  var d=(x+1)%2,cx=(x+1)>>1,dd=(cx+2*(y&1))%3+3*d,pdd=dd,xy,dx;
  if(i&1) {
    pdd=(dd+(i==3?3:0))%6;
    for(;n--;) {
      x3=x,y3=y;
      dx=(y&1)?0:-2;
      if(pdd==0) xy=[[1+dx,1,4],[dx,1,2],[1,0,5],[-1,0,0],[-1,0,1],[dx,1,3]][dd],x+=xy[0],y+=xy[1],dd=xy[2];
      else if(pdd==1) x--; 
      else if(pdd==2) xy=[[1,0,3],[dx+1,-1,5],[dx,-1,0],[dx,-1,4],[-1,0,1],[-1,0,2]][dd],x+=xy[0],y+=xy[1],dd=xy[2];
      else if(pdd==3) xy=[[1,0,3],[1,0,4],[dx+2,-1,1],[dx+2,-1,5],[dx+1,-1,0],[-1,0,2]][dd],x+=xy[0],y+=xy[1],dd=xy[2];
      else if(pdd==4) x++;
      else if(pdd==5) xy=[[dx+2,1,2],[1,0,4],[1,0,5],[-1,0,0],[dx+2,1,3],[dx+1,1,1]][dd],x+=xy[0],y+=xy[1],dd=xy[2];
      if(!(b=board[y])||!_xo(b[x])||_blocked(x,y,x3,y3)) break;
      if(!dic[k=_k25(x,y)]) dic[k]=1,xy.push(x,y);
    }
  } else {
    pdd=(dd+(i==2?3:0))%6;
    for(;n--;) {
      x3=x,y3=y;
      dx=(y&1)?0:-2;
      if(pdd==0) xy=[[dx+2,1,2],[1,0,4],[1,0,5],[1,0,1],[dx+2,1,3],[1,0,0]][dd];
      else if(pdd==1) xy=[[dx+1,1,4],[dx,1,2],[1,0,5],[-1,0,0],[dx+2,1,3],[dx+1,1,1]][dd];
      else if(pdd==2) xy=[[-1,0,5],[dx,1,2],[-1,0,4],[-1,0,0],[-1,0,1],[dx,1,3]][dd];
      else if(pdd==3) xy=[[-1,0,5],[-1,0,3],[dx,-1,0],[dx,-1,4],[-1,0,1],[-1,0,2]][dd];
      else if(pdd==4) xy=[[1,0,3],[dx+1,-1,5],[dx+2,-1,1],[dx,-1,4],[dx+1,-1,0],[-1,0,2]][dd];
      else if(pdd==5) xy=[[1,0,3],[1,0,4],[dx+2,-1,1],[dx+2,-1,5],[1,0,2],[1,0,0]][dd];
      x+=xy[0],y+=xy[1],dd=xy[2];
      if(!(b=board[y])||!_xo(b[x])||_blocked(x,y,x3,y3)) break;
      if(!dic[k=_k25(x,y)]) dic[k]=1,xy.push(x,y);
    }
  }
}

function _switch21(x,y,mask,d,u) {
  var r=(((y+1)&1)<<1)|((x+1)&1),dic={};
  var i,m,xy=[];

  mask&=0xf,mask=rol(4,mask,d);
  if(mask&1) _line21(x,y,0,dic,xy)
  if(mask&2) _line21(x,y,1,dic,xy)
  if(mask&4) _line21(x,y,2,dic,xy)
  if(mask&8) _line21(x,y,3,dic,xy)
  return _switchi(x,y,xy,u);
}

function _line28(x,y,m,dx,dy,dic,xy) {
  var n=88,x3,y3,d,dd,cx,aa,bx;
  for(;n--;) {
    x3=x,y3=y;
    d=(x+2)%3,bx=y&1?0:-3;
    if(dy) {
      if(dy<0) {
        if(dx<0) aa=[[bx+2,-1],[bx,-1],[-2,0]][d];
        else aa=[[bx+4,-1],[-1,0],[bx+3,-1]][d];
      } else {
        if(dx<0) aa=[[1,0],[bx-1,1],[bx,1]][d];
        else aa=[[2,0],[bx+3,1],[bx+1,1]][d];
      }
    } else {
      if(dx<0) aa=[[-3,0],[-2,0],[-1,0]][d];
      else aa=[[3,0],[1,0],[2,0]][d];
    }
    x+=aa[0],y+=aa[1];
    if(!(b=board[y])||!_xo(b[x])||_blocked(x,y,x3,y3)) break;
    if(!dic[k=_k25(x,y)]) dic[k]=1,xy.push(x,y);
  }
}

function _switch20(x,y,mask,d,u) {
  var r=(x+2)%3,cx=(x+2-d)/3,dic={},lm;
  var i,m2,m,xy=[],dg=d&256,dl=d&15,dh=(d>>4)&15;

  //mask=1;
  d=dl>>1;
  lm=dg?4:dl&1?2:1;
  //console.clear();console.log('switch',x,y,d,mask);
  mask&=0xffff,mask=(mask<<d)|(mask>>(6-d));
  if(mask&(1)) _line20(x,y,lm,0,0,dic,xy)
  if(mask&(2)) _line20(x,y,lm,1,0,dic,xy)
  if(mask&(4)) _line20(x,y,lm,2,0,dic,xy)
  if(mask&(8)) _line20(x,y,lm,3,0,dic,xy)
  if(mask&(16)) _line20(x,y,lm,4,0,dic,xy)
  if(mask&(32)) _line20(x,y,lm,5,0,dic,xy)
  return _switchi(x,y,xy,u);
}

function _line20(x,y,m,dx,dy,dic,xy) {
  var n=88,x2,y2,x3,y3,d,e,dd,cx,aa,bx,l=m&1,r=m&2,b,b2,bi,bx;
  console.log('line',x,y,'dxy=',dx,dy,'d=',(x+2)%3);
  if(m&4) {
    if(!l&&!r) l=r=1;
    d=(x+2)%3;
    if(d!=(dx==0||dx==3?1:dx==1||dx==4?0:2)) {
      console.log('step1',dx,d);
      x3=x,y3=y;
      e=_next(x,y,2*dx,0),x=e[0],y=e[1];
      if(!(b=board[y])||!_xo(b[x])||_blocked(x,y,x3,y3)) return;
      if(!dic[k=_k25(x,y)]) dic[k]=1,xy.push(x,y);
    }
    for(;n--;) {
      x3=x,y3=y;
      d=(x+2)%3,bx=y&1?0:-3;
      e=_next(x,y,2*dx,0),x=e[0],y=e[1];
      e=_next(x3,y3,2*dx+1,0),x2=e[0],y2=e[1];
      c=l&&(b=board[y])&&_xo(b[x])&&!_blocked(x,y,x3,y3);
      c2=r&&(b=board[y2])&&_xo(b[x2])&&!_blocked(x2,y2,x3,y3);
      bi=_blocked(x,y,x2,y2);
      if(l&&!c&&c2&&!bi) c=1;
      else if(r&&!c2&&c&&!bi) c2=1;
      if(!c&&!c2) break;
      if(c&&!dic[k=_k25(x,y)]) dic[k]=1,xy.push(x,y);
      if(c2&&!dic[k=_k25(x2,y2)]) dic[k]=1,xy.push(x2,y2);
      e=_next(x,y,2*dx,0),x3=e[0],y3=e[1];
      if(!(b=board[y3])||!_xo(b[x3])||((!c||_blocked(x3,y3,x,y))&&(!c2||_blocked(x3,y3,x2,y2)))) break;
      x=x3,y=y3;
      if(!dic[k=_k25(x,y)]) dic[k]=1,xy.push(x,y);
    }
  } else
    for(;n--;) {
      x3=x,y3=y;
      d=(x+2)%3,bx=y&1?0:-3;
      if(dx==1) aa=[[bx+(r?1:2),-1],[-1,0],[-2,0]][d];
      else if(dx==2) aa=[[bx+5,-1],[bx+4,-1],[r?-1:-2,0]][d];
      else if(dx==3) aa=[[1,0],[r?4:2,0],[-1,0]][d];
      else if(dx==4) aa=[[r?2:1,0],[bx+2,1],[bx+1,1]][d];
      else if(dx==5) aa=[[2,0],[1,0],[bx+(r?-2:-1),1]][d];
      else aa=[[-2,0],[r?-1:1,0],[-4,0]][d];
      x+=aa[0],y+=aa[1];
      if(!(b=board[y])||!_xo(b[x])||_blocked(x,y,x3,y3)) break;
      if(!dic[k=_k25(x,y)]) dic[k]=1,xy.push(x,y);
    }
}


function _switch28(x,y,mask,d,u) {
  var r=(x+2)%3,dic={};
  var i,m2,m,xy=[];

  console.log(x,y,d,mask);
  mask&=0xffff,mask=(mask<<d)|(mask>>(4-d));
  if(mask&(r==1?1<<2:r==2?1<<3:0)) _line28(x,y,0,-1,0,dic,xy)
  if(mask&(r==1?1<<0:r==2?1<<1:0)) _line28(x,y,0,+1,0,dic,xy)
  if(mask&(r==1?0:r==2?1<<0:1<<1)) _line28(x,y,0,-1,-1,dic,xy)
  if(mask&(r==1?1<<3:r==2?0:1<<2)) _line28(x,y,0,+1,-1,dic,xy)
  if(mask&(r==1?1<<1:r==2?0:1<<0)) _line28(x,y,0,-1,+1,dic,xy)
  if(mask&(r==1?0:r==2?1<<2:1<<3)) _line28(x,y,0,+1,+1,dic,xy)
  return _switchi(x,y,xy,u);
}

function _line29(x,y,m,dx,dy,dic,xy) {
  var x3,y3,n=88;
  for(;n--;) {
    x3=x,y3=y;
    if(dy) {
      var r=(x+2)%3,cx=(x+2-r)/3,dd=1^(y&1)^(cx&1);
      if(dy<0) {
	if(dx>0) {
	  if(dd) r=r==1?3:r==2?4:1;
	  else r=r==1?2:r==2?(y+=dy,2):(y+=dy,0);
	} else {
	  if(dd) r=r==1?-1:r==2?1:-2;
	  else r=r==1?0:r==2?(y+=dy,2):(y+=dy,0);
	}
      } else {
	if(dx>0) {
	  if(dd) r=r==1?2:r==2?(y+=dy,2):(y+=dy,0);
	  else r=r==1?3:r==2?4:1;
	} else {
	  if(dd) r=r==1?0:r==2?(y+=dy,2):(y+=dy,0);
	  else r=r==1?-1:r==2?1:-2;
	}
      }
      x=cx*3-2+r;
    } else {
      x+=2*dx;
    }
    if(!(b=board[y])||!_xo(b[x])||_blocked(x,y,x3,y3)) break;
    if(!dic[k=_k25(x,y)]) dic[k]=1,xy.push(x,y);
  }
}
function _switch29(x,y,mask,d,u) {
  var r=(x+2)%3,cx=(x+2-r)/3,dd=1^(y&1)^(cx&1),dic={};
  var i,m,xy=[];

  //console.log(x,y,d,x1,x2);
  mask&=0xffff;
  mask=0x202;
  var mx=0,a=dd?2*r:(7-2*r)%6,xl=d==0||d==1,xr=d==1||d==2;
  if(xl) mask=mask>>8;
  
  if(mask&1) mx|=1<<((a+(xr?5:0))%6);
  if(mask&2) mx|=1<<((a+(xr?4:1))%6);
  if(mask&4) mx|=1<<((a+(xr?3:2))%6);
  if(mask&8) mx|=1<<((a+(xr?2:3))%6);
  if(mask&16) mx|=1<<((a+(xr?1:4))%6);
  if(mask&32) mx|=1<<((a+(xr?0:5))%6);
  if(mx) {
    if(mx&8) _line29(x,y,0,1,0,dic,xy)
    if(mx&1) _line29(x,y,0,-1,0,dic,xy)
    if(mx&16) _line29(x,y,0,1,1,dic,xy)
    if(mx&32) _line29(x,y,0,-1,1,dic,xy)
    if(mx&4) _line29(x,y,0,1,-1,dic,xy)
    if(mx&2) _line29(x,y,0,-1,-1,dic,xy)
  }
  return _switchi(x,y,xy,u);
}

function _f25(x) { return x+1;}
function _t25(x) { return x-1;}
function _k25(x,y) { return (x<<16)|y;}


function _line25(x,y,m,dx,dy,dic,xy) {
  var x4,px=x,py=y,cx=_f25(x),xy1,v,r=[],k,n=88;
  if(!dic[k=_k25(x,y)]) dic[k]=1,xy.push(x,y)
  var x3=x,y3=y;
  if(dx&&dy) {
    for(;n--;x3=x,y3=y) {
      v=(((x+1)>>1)+y)&1;
      x=_f25(x);
      if(v) {
        if((x&1)==(dx>0)) x=((x+2*dx)&~1)|(dy>0);
        else y+=dy,x=(x&~1)|(dy<0);
      } else {
        if((x&1)==(dy<0)) x=((x+2*dx)&~1)|(dx<0);
        else y+=dy,x=(x&~1)|(dx>0);
      }
      x=_t25(x);
      console.log(x,y,x3,y3);
      if(!(b=board[y])||!_xo(b[x])||_blocked(x,y,x3,y3)) break;
      if(!dic[k=_k25(x,y)]) dic[k]=1,xy.push(x,y);
    }
  } else if(dx||dy) {
    if(dx) {
      b=board[y];
      for(;n--;x3=x,y3=y) {
        v=(((x+1)>>1)+y)&1;
        if(v&&((x&1)==(dx<0))) {
          x4=x+3*dx,c=0,x2=_t25(x);
          if((m&1)&&_xo(b[x2=x+(dx<0?2:1)*dx])&&!_blocked(x2,y,x3,y3)) {c=!_blocked(x2,y,x4,y);if(!dic[k=_k25(x2,y)]) dic[k]=1,xy.push(x2,y);}
          if((m&2)&&_xo(b[x2=x+(dx<0?1:2)*dx])&&!_blocked(x2,y,x3,y3)) {c|=!_blocked(x2,y,x4,y);if(!dic[k=_k25(x2,y)]) dic[k]=1,xy.push(x2,y);}
          if(!c||!_xo(b[x=x4])) break;
          if(!dic[k=_k25(x,y)]) dic[k]=1,xy.push(x,y);
        } else {
          x+=dx;
          if(!v) {
            if(((x&1)!=(dx>0))) x+=dx;
          }
          if(!(b=board[y])||!_xo(b[x])||_blocked(x,y,x3,y3)) break;
          if(!dic[k=_k25(x,y)]) dic[k]=1,xy.push(x,y);
        }
      }
    } else {
      for(;n--;x3=x,y3=y) {
        v=(((x+1)>>1)+y)&1;
        if(!v&&((x&1)==(dy<0))) {
          y+=dy,b=board[y];
          x2=((x-1)&~1)+1,x4=x2+(dy<0),c=0;
          if((m&1)&&b&&_xo(b[x2])&&!_blocked(x2,y,x3,y3)) {c=!_blocked(x2,y,x4,y+dy);if(!dic[k=_k25(x2,y)]) dic[k]=1,xy.push(x2,y);}
          x2++;if((m&2)&&b&&_xo(b[x2])&&!_blocked(x2,y,x3,y3)) {c|=!_blocked(x2,y,x4,y+dy);if(!dic[k=_k25(x2,y)]) dic[k]=1,xy.push(x2,y);}
          x=x4,y+=dy,b=board[y];
          if(!c||!b[x]||!_xo(b[x])) break;
          if(!dic[k=_k25(x,y)]) dic[k]=1,xy.push(x,y);
        } else {
          if(!v) x+=dy;
          else {
            if((x&1)==(dy<0)) x-=dy;
            y+=dy;
          }
          if(!(b=board[y])||!_xo(b[x])||_blocked(x,y,x3,y3)) break;
          if(!dic[k=_k25(x,y)]) dic[k]=1,xy.push(x,y);
        }
      }
    }
  }
}

function _switch25(x,y,mask,d,u) {
  var r,cx=(x+1)/2|0,x1=x&1,sx=brd+cx*cell7,sy=brd+y*cell7,v=(cx+y)&1,c2=cell7/2,c4=c2/2,dic={};
  var i,m,xy=[],b=_border15(x,y);

  mask&=0xfffff,mask=(mask<<d)|(mask>>(20-d));
  if(mask&0xf) {
    var x2=x+b[0],y2=y+b[1],x1=x2&1,v=(((x2+1)>>1)+y2)&1;
    if(!_blocked(x,y,x2,y2)) {
      if(mask&1) _line25(x2,y2,v?x1?2:1:x1?1:2,v?x1?1:-1:0,v?0:x1?1:-1,dic,xy,x,y);
      if(mask&2) r=v?x1?1:2:x1?3:0,_line25(x2,y2,0,r&1?1:-1,r&2?1:-1,dic,xy,x,y);
    }
  }
  if(mask&0xf0) {
    var x2=x+b[2],y2=y+b[3],x1=x2&1,v=(((x2+1)>>1)+y2)&1;
    if(!_blocked(x,y,x2,y2)) {
      if(mask&0x10) _line25(x2,y2,v&&!x1||!v&&!x1?2:1,v?0:x1?1:-1,v?x1?-1:1:0,dic,xy,x,y);
      if(mask&0x20) r=v?x1?0:3:x1?1:2,_line25(x2,y2,0,r&1?1:-1,r&2?1:-1,dic,xy,x,y);
    }
  }
  if(mask&0xf00) {
    var x2=x+b[4],y2=y+b[5],x1=x2&1,v=(((x2+1)>>1)+y2)&1;
    if(!_blocked(x,y,x2,y2)) {
      if(mask&0x100) _line25(x2,y2,!v&&!x1||v&&!x1?2:1,v?0:x1?-1:1,v?x1?1:-1:0,dic,xy,x,y);
      if(mask&0x200) r=v?x1?2:1:x1?0:3,_line25(x2,y2,0,r&1?1:-1,r&2?1:-1,dic,xy,x,y);
    }
  }
  if(mask&0xf000) {
    var x2=x+b[6],y2=y+b[7],x1=x2&1,v=(((x2+1)>>1)+y2)&1;
    if(!_blocked(x,y,x2,y2)) {
      if(mask&0x1000) _line25(x2,y2,v?x1?1:2:x1?2:1,v?x1?1:-1:0,v?0:x1?1:-1,dic,xy,x,y);
      if(mask&0x2000) r=v?x1?3:0:x1?2:1,_line25(x2,y2,0,r&1?1:-1,r&2?1:-1,dic,xy,x,y);
    }
  }
  if(mask&0xf0000) {
    var x2=x+b[8],y2=y+b[9],x1=x2&1,v=(((x2+1)>>1)+y2)&1;
    if(!_blocked(x,y,x2,y2)) {
      if(mask&0x10000) _line25(x2,y2,3,v?x1?-1:1:0,v?0:x1?-1:1,dic,xy,x,y);
      if(mask&0x20000) {
	 r=v?x1?2:1:x1?0:3,_line25(x2,y2,0,r&1?1:-1,r&2?1:-1,dic,xy,x,y);
	 r=v?x1?0:3:x1?1:2,_line25(x2,y2,0,r&1?1:-1,r&2?1:-1,dic,xy,x,y);
      }
    }
  }
  return _switchi(x,y,xy,u);
}

function _switch26(x,y,mask,d,u) {
  var x2,i,j,k,j2,k2,c,b,m,xy=[];

  mask&=63,mask=(mask<<d)|(mask>>(6-d));
  if(mask&1) for(i=1,k2=k=x,j2=j=y;_xo(board[j][k-=1])&&!_blocked(k2,j2,k,j);i++,k2=k,j2=j) xy.push(k,j);
  if(mask&2)  for(i=1,k2=k=x,j2=j=y;(b=board[j-=1])&&_xo(b[k+=j&1?-1:0])&&!_blocked(k2,j2,k,j);i++,k2=k,j2=j) xy.push(k,j);
  if(mask&4)  for(i=1,k2=k=x,j2=j=y;(b=board[j-=1])&&_xo(b[k+=j&1?0:1])&&!_blocked(k2,j2,k,j);i++,k2=k,j2=j) xy.push(k,j);
  if(mask&8) for(i=1,k2=k=x,j2=j=y;_xo(board[j][k+=1])&&!_blocked(k2,j2,k,j);i++,k2=k,j2=j) xy.push(k,j);
  if(mask&16)  for(i=1,k2=k=x,j2=j=y;(b=board[j+=1])&&_xo(b[k+=j&1?0:1])&&!_blocked(k2,j2,k,j);i++,k2=k,j2=j) xy.push(k,j);
  if(mask&32)  for(i=1,k2=k=x,j2=j=y;(b=board[j+=1])&&_xo(b[k+=j&1?-1:0])&&!_blocked(k2,j2,k,j);i++,k2=k,j2=j) xy.push(k,j);
  return _switchi(x,y,xy,u);
}

function _mask(x6,x,y,p3) {
  if(hexa||deca) return x6==9?62:x6==7?43:x6==6?39:x6==5?34:x6==4?9:x6==3?54:x6==2?35:x6==1?21:63;
  if(trap) {
    if(oox) return 1;
    return x6==2?15:x6==1?2:1;
  }
  if(delta) { 
    var m;
    if(oox) return x6==2?3:x6==1?2:1;
    m=x6==3?0x1:x6==2?3:x6==1?0x1111:0xf;
    return m;
  }
  if(cubes) {
    var d=(x+2)%3,b=(p3==4||p3==12),m;
    if(oox) return 1;
    m=x6==6?23:x6==4?8:x6==3?0x3333:x6==2?0x55:x6==1?0x1111:65535;
    if(!b) m=(m&0xf)|((m&0xff00)>>4)|((m&0xf0)<<8);
    return m;
  }
  if(penta) {
    if(oox) return x6==2?0x2:x6==1?0x1:0x11111;
    return x6==6?23:x6==4?18:x6==3?30:x6==2?19:x6==1?13:31;
  }
  if(tria2||tria4) return 1;
  if(tria) {
    if(oox) return x6==4?0xc0300:x6==3?8:x6==2?4:x6==1?0x30303:0xf0f0f;
    return x6==9?0xd0308:x6==7?0x8000f:x6==6?0x10305:x6==4?0x10100:x6==3?0x70707:x6==2?0xd030f:x6==1?0x10101:0xf0f0f;
  }
  return x6==9?192|6:x6==7?131+16:x6==6?119:x6==4?17:x6==3?187:x6==2?69:x6==1?85:255;
}

function _kup(e) {
  var ct=e.ctrlKey,sh=e.shiftKey,kc=e.keyCode;
  console.log('kup'+(ct?' ctrl':'')+(sh?' shift':''),kc,e);
  if(ct&&kc==90) _undo(sh*10);
  if(ct&&kc==89) _redo(sh*10);
  if(ct&&sh&&(kc>=48&&kc<=57)) _setdes(kc==48?9:kc-49);
}
function _mup(e) {
  if(!mp) return;
  mm1=0;
  e.preventDefault();
  sele=[];
  var mxy=_mxy(e),lx=mxy[0],ly=mxy[1],px=mp[0],py=mp[1],qx,qy,rx,ry,qr;
  var nx=board[0].length-1,ny=board.length-1,dm=_design(e);
  //console.log('px='+px+' py='+py+' lx='+lx+' ly='+ly);
  if(dm) {
    if(design==7) mxy[7]=_idx(mxy[5],mxy[6],_points(mxy[0],mxy[1]));
    _mdesign(dm,1,mxy,e);
    return;
  }
  if(lx<1||ly<1||lx>nx||ly>ny||px<0||py<0||px>=nx||py>=ny) return;
  if(shifter) {
    var ua=_shifter(1,mxy,e); ;
    undo.length=redo;undo[redo++]=ua;
    return;
  }
  if(faller) {
    var ua=_faller(1,mxy,e); ;
    //undo.length=redo;undo[redo++]=ua;
    return;
  }
  if(onoff) {
    var c=board[ly][lx];
    if(c=='w'||c=='o'||c=='x') {
      var mc=mxy[4],p=0,p2,p3,x6=+f.onoff6.value,xyc;
      if(oox) {
        hexa?(p=26,_switch26(lx,ly,p2=_mask(x6),p3=_idx(mxy[5],mxy[6],_points16(lx,ly),x6==6)))
        :trap?(p=21,_switch21(lx,ly,p2=_mask(x6),p3=_idx(mxy[5],mxy[6],_points11(lx,ly),x6==6)))
        :deca?(p=20,_switch20(lx,ly,p2=_mask(x6),p3=(diag?256:0)|_dir10(mxy[5],mxy[6],lx,ly)))
        :cubes?(p=28,_switch28(lx,ly,p2=_mask(x6),p3=_idx(mxy[5],mxy[6],_points8(lx,ly),x6==6)))
        :delta?(p=29,_switch29(lx,ly,p2=_mask(x6),p3=_idx(mxy[5],mxy[6],_points9(lx,ly),x6==6)))
        :tria4?(p=22,_switch22(lx,ly,p2=_mask(x6),p3=_idx(mxy[5],mxy[6],_points5(lx,ly),x6==6)))
        :tria2?(p=27,_switch27(lx,ly,p2=_mask(x6),p3=_idx(mxy[5],mxy[6],_points2(lx,ly),x6==6)))
        :penta?(p=25,_switch25(lx,ly,p2=_mask(x6),p3=4*_idx(mxy[5],mxy[6],_points15(lx,ly),x6==6)))
        :tria?(p=23,_switch23(lx,ly,p2=_mask(x6),p3=8*_idx(mxy[5],mxy[6],_points3(lx,ly),x6==6)))
        :(p=24,_switch24(lx,ly,p2=diag&&Math.abs(mxy[2])+Math.abs(mxy[3])>cell?170:_mask(x6),p3=2*_idx(mxy[5],mxy[6],_points14(lx,ly),x6==6)));
      } else if((x6==8)&&(hexa||tria||!(penta|tria4|tria2))) {
        var ix=_idx(mxy[5],mxy[6],(tria?_points3:hexa?_points16:_points14)(lx,ly),2),s=ix&64;
        p3=(tria?8:hexa?1:2)*(ix&63);
        tria?(p=4,_switch3(lx,ly,p2=s?0x30303:0x50505,p3)):hexa?(p=16,_switch16(lx,ly,p2=s?41:11,p3)):(p=13,_switch14(lx,ly,p2=s?129|24:3|48,p3));
      } else 
        trap?(p=11,p3=_idx(mxy[5],mxy[6],_points11(lx,ly),x6>=6),xyc=_switch11(lx,ly,p2=_mask(x6,lx,ly,p3),p3))
        :delta?(p=19,p3=4*_idx(mxy[5],mxy[6],_points9(lx,ly),x6>=6),xyc=_switch19(lx,ly,p2=_mask(x6,lx,ly,p3),p3))
        :deca?(p=7,p3=_idx(mxy[5],mxy[6],_points7(lx,ly),x6>=6),xyc=_switch7(lx,ly,p2=_mask(x6,lx,ly,p3),p3))
        :cubes?(p=18,p3=4*_idx(mxy[5],mxy[6],_points8(lx,ly),x6>=6),xyc=_switch18(lx,ly,p2=_mask(x6,lx,ly,p3),p3))
        :penta?(p=15,xyc=_switch15(lx,ly,p2=_mask(x6),p3=_idx(mxy[5],mxy[6],_points15(lx,ly),x6>=6)))
        :hexa?(p=16,xyc=_switch16(lx,ly,p2=_mask(x6),p3=_idx(mxy[5],mxy[6],_points16(lx,ly),x6==6)))
        :tria?(p=4,xyc=_switch3(lx,ly,p2=_mask(x6),p3=8*_idx(mxy[5],mxy[6],_points3(lx,ly),x6==6))) //tria?(p=4,_switch4(lx,ly))
        :tria4?(p=5,xyc=_switch5(lx,ly)):tria2?(p=2,xyc=_switch2(lx,ly)) //:hexa?_switch16(lx,ly,p=mc&1?5:3)
        :(p=13,xyc=_switch14(lx,ly,p2=diag&&Math.abs(mxy[2])+Math.abs(mxy[3])>cell?170:_mask(x6),p3=2*_idx(mxy[5],mxy[6],_points14(lx,ly),x6==6)));
      undo.length=redo;undo[redo++]=[lx,ly,p,p2,p3,xyc];
      _moves(1);
      _drawboard();
      _beep();
    }
    return;
  }
  var dx,dy,l,r,u,u2,d,d2,ld,lu,rd,ru,s,c=board[py][px],c1,ex;
  if(trap||penta||delta||deca||cubes||hexa||quad||tria|tria2|tria4) {
    if(c=='o'||c=='w') {
      var ja=_jumpsx()(px,py);
      var i,n=_jumpsl(ja);
      for(i=0;i<n;i++) {
        j=ja[i],qx=px+j[0],qy=py+j[1],rx=px+j[2],ry=py+j[3];
        if(((lx==qx&&ly==qy)||(lx==rx&&ly==ry))&&_can5(px,py,qx,qy,rx,ry)) {
          if(dy) {
            var k=ja[dx],kx=px+k[0],ky=py+k[1];
            if(_near(mxy[5],mxy[6],_peg(qx,qy),_peg(kx,ky))) dx=i;
            break;
          } else dx=i,dy=1;
        }
      }
      if(!dy) {
    	if(_full()||_fullxy(px,py)) {
  	  board[py][px]='x';
	  undo.length=redo;undo[redo++]=u=[px,py,0,0,c,_getpgc(px,py),0];
	  _drawboard();
	}
	return;
      }
      j=ja[i=dx],qx=px+j[0],qy=py+j[1],rx=px+j[2],ry=py+j[3];
    } else
      return;
  } else if(tria||hexa) {
    if(tria) {
      ex=mxy[2];
      if(c=='o'||c=='w') {
	l=+_can6(px,py,-1,0),r=+_can6(px,py,1,0),u=+_can6(px,py,-1,-1),d=+_can6(px,py,-1,1);
	u2=+_can6(px,py,1,-1),d2=+_can6(px,py,1,1),s=l+r+u+u2+d+d2;
	if(s>1) {
	  if(l&&lx<px&&ly==py) r=u=d=u2=d2=0;
	  if(r&&lx>px&&ly==py) l=u=d=u2=d2=0;
	  if(u&&(ly<py&&lx<px||lx==px&&ex<0)) l=r=d=d2=u2=0;
	  if(u2&&(ly<py&&lx>px||lx==px&&ex>0)) l=r=d=d2=u=0;
	  if(d&&(ly>py&&lx<px||lx==px&&ex<0)) l=r=d2=u=u2=0;
	  if(d2&&(ly>py&&lx>px||lx==px&&ex>0)) l=r=d=u=u2=0;
	  if(l+r+u+u2+d+d2>1) return;
	} else if(!s) {
	  if(_full()||_fullxy(px,py)) {
	    board[py][px]='x';
            undo.length=redo;undo[redo++]=u=[px,py,0,0,c,_getpgc(qx,qy),0];
	    _drawboard();
	  }
	  return;
	}
      } else
	return;
    } else {
      ex=py&1?0:-1;
      if(c=='o'||c=='w') {
	l=+_can6(px,py,-1,0),r=+_can6(px,py,1,0),u=+_can6(px,py,-1,-1),d=+_can6(px,py,-1,1);
	u2=+_can6(px,py,1,-1),d2=+_can6(px,py,1,1),s=l+r+u+u2+d+d2;
	if(s>1) {
	  if(l&&lx<px&&ly==py) r=u=d=u2=d2=0;
	  if(r&&lx>px&&ly==py) l=u=d=u2=d2=0;
	  if(u&&ly<py&&lx<=px+ex) l=r=d=d2=u2=0;
	  if(u2&&ly<py&&lx>px+ex) l=r=d=d2=u=0;
	  if(d&&ly>py&&lx<=px+ex) l=r=d2=u=u2=0;
	  if(d2&&ly>py&&lx>px+ex) l=r=d=u=u2=0;
	  if(l+r+u+u2+d+d2>1) return;
	} else if(!s) {
	  if(_full()) {
	    board[py][px]='x';
            undo.length=redo;undo[redo++]=u=[px,py,0,0,c,_getpgc(px,py),0];
	    _drawboard();
	  }
	  return;
	}
      } else
	return;
    }
    if(l) dx=-1,dy=0;
    else if(r) dx=1,dy=0;
    else if(u) dx=-1,dy=-1; else if(u2) dx=+1,dy=-1;
    else if(d) dx=-1,dy=+1; else if(d2) dx=+1,dy=+1;
    //if(c=='x') px-=2*dx,py-=2*dy,c=board[py][px];
  } else {
    if(c=='x') {
      l=+_can(px+2,py,-1,0),r=+_can(px-2,py,1,0),u=+_can(px,py+2,0,-1),d=+_can(px,py-2,0,1),s=l+r+u+d;
      if(diag) lu=+_can(px+2,py+2,-1,-1),ld=+_can(px+2,py-2,-1,1),ru=+_can(px-2,py+2,1,-1),rd=+_can(px-2,py-2,1,1),s+=lu+ld+ru+rd;
      else lu=ld=ru=rd=0;
      if(s>1) {
	if(l&&lx>px&&ly==py) r=u=d=lu=ld=ru=rd=0;
	if(r&&lx<px&&ly==py) l=u=d=lu=ld=ru=rd=0;
	if(u&&ly>py&&lx==px) l=r=d=lu=ld=ru=rd=0;
	if(d&&ly<py&&lx==px) l=r=u=lu=ld=ru=rd=0;
	if(lu&&lx>px&&ly>py) l=r=u=d=ld=ru=rd=0;
	if(ld&&lx>px&&ly<py) l=r=u=d=lu=ru=rd=0;
	if(ru&&lx<px&&ly>py) l=r=u=d=lu=ld=rd=0;
	if(rd&&lx<px&&ly<py) l=r=u=d=lu=ld=ru=0;
	if(l+r+u+d+lu+ld+ru+rd>1) return;
      } else if(!s) return;
    } else if(c=='o'||c=='w') { 
      l=+_can(px,py,-1,0),r=+_can(px,py,1,0),u=+_can(px,py,0,-1),d=+_can(px,py,0,1),s=l+r+u+d;
      if(diag) lu=+_can(px,py,-1,-1),ld=+_can(px,py,-1,1),ru=+_can(px,py,1,-1),rd=+_can(px,py,1,1),s+=lu+ld+ru+rd;
      else lu=ld=ru=rd=0;
      if(s>1) {
	if(l&&lx<px&&ly==py) r=u=d=lu=ld=ru=rd=0;
	if(r&&lx>px&&ly==py) l=u=d=lu=ld=ru=rd=0;
	if(u&&ly<py&&lx==px) l=r=d=lu=ld=ru=rd=0;
	if(d&&ly>py&&lx==px) l=r=u=lu=ld=ru=rd=0;
	if(lu&&lx<px&&ly<py) l=r=u=d=ld=ru=rd=0;
	if(ld&&lx<px&&ly>py) l=r=u=d=lu=ru=rd=0;
	if(ru&&lx>px&&ly<py) l=r=u=d=lu=ld=rd=0;
	if(rd&&lx>px&&ly>py) l=r=u=d=lu=ld=ru=0;
	if(l+r+u+d+lu+ld+ru+rd>1) return;
      } else if(!s) {
	if(_full()) {
	  board[py][px]='x';
	  _drawboard();
	}
	return;
      }
    } else
      return;
    if(l) dx=-1,dy=0;
    else if(r) dx=1,dy=0;
    else if(u) dx=0,dy=-1;
    else if(d) dx=0,dy=+1;
    else if(lu) dx=-1,dy=-1;
    else if(ld) dx=-1,dy=+1;
    else if(ru) dx=1,dy=-1;
    else if(rd) dx=1,dy=+1;
    if(c=='x') px-=2*dx,py-=2*dy,c=board[py][px];
  }
  if(!deca&&!trap&&!tria&&!tria4&&!penta&&!delta&&!cubes&&!hexa&&!quad&&!tria2) qr=_jumps(px,py,dx,dy),qx=qr[0],qy=qr[1],rx=qr[2],ry=qr[3];
  c1=board[qy][qx];
  undo.length=redo;undo[redo++]=u=[px,py,dx,dy,c,c1,_getpgc(qx,qy),0];
  _moves(1);
  board[py][px]='x';
  b=u[5];
  if(white) {
    r=2*(c=='w')+(c1=='w');
    r=white[r];
    b=r=='b'?'o':r=='e'?c1:r=='f'?c1=='o'?'w':'o':r=='w'||r=='o'?r:'x';
  } else b=c=='o'?'x':c1=='o'?'w':'o';
  board[qy][qx]=b;
  board[ry][rx]=c;
  _setpgc(rx,ry,_getpgc(px,py));
  _drawboard();
  _beep();
}

function _switchx(x) {
  return x==2?_switch2:x==4?_switch4:x==5?_switch5
   :x==11?_switch11:x==15?_switch15:x==16?_switch16:x==18?_switch18:x==19?_switch19
   :x==21?_switch21:x==22?_switch22:x==23?_switch23:x==24?_switch24:x==25?_switch25:x==26?_switch26:x==27?_switch27:x==28?_switch28:x==29?_switch29:x==20?_switch20
   :_switch14;
}
function _undo(n) {
  if(redo) {
    if(!n) n=1;
    while(redo&&n--) {
      var u=undo[--redo],px=u[0],py=u[1],dx=u[2],dy=u[3],m=-1;
      if(u.length==4) {
        var xy=_shiftxy(px,py,dx[0],dx[1]);
        _shift(xy,-dy);
      } else if(u.length==6) {
        _switchx(u[2])(px,py,u[3],u[4],u[5]);
      } else if(dx||dy) {
	var qr=_jumps(px,py,dx,dy),qx=qr[0],qy=qr[1],rx=qr[2],ry=qr[3];
	board[py][px]=u[4],board[qy][qx]=u[5],board[ry][rx]='x';
        _setpgc(px,py,_getpgc(rx,ry));
        _setpgc(qx,qy,u[6]);
      } else
	m=0,board[py][px]=u[4],_setpgc(px,py,u[5]);
      _moves(m);
    }
    _drawboard();
  }
}

function _redo(n) {
  if(n<1) n=1;
  while(redo<undo.length&&n--) {
    var u=undo[redo++],px=u[0],py=u[1],dx=u[2],dy=u[3],m=1;
    if(u.length==4) {
      var xy=_shiftxy(px,py,dx[0],dx[1]);
      _shift(xy,dy);
    } else if(u.length==6) 
      u[5]=_switchx(u[2])(px,py,u[3],u[4]);
    else if(dx||dy) {
      var qr=_jumps(px,py,dx,dy),qx=qr[0],qy=qr[1],rx=qr[2],ry=qr[3];
      board[py][px]=board[qy][qx]='x',board[ry][rx]=u[4];
      _setpgc(rx,ry,_getpgc(px,py));
      u[6]=_getpgc(qx,qy);
    } else
      m=0,board[py][px]='x',u[5]=_getpgc(px,py);
    _moves(m);
  }
  _drawboard();
}

setInterval(_timer,200);
function _timer() {
  if(mm1&&mm1[0]+Math.max(100,drawms)<+new Date()) {
    var e=mm1[1];mm1=0;
    _mmove(e,1);
  }
}

function _file_open() {
  var txt,i,fa=f.file.files;
  if(fa) for(i=0,f.ta.value='',ugame={},f.uset.innerHTML='';i<fa.length;i++) {
    var fr = new FileReader();
    fr.readAsText(fa[i],"UTF-8");
    fr.onload=function(e) { var txt=e.target.result;_uset(txt); }
  }
}

function _file_save() {
  var asave=document.getElementById("asave");
  asave.href='data:attachment/text,'+encodeURI(f.ta.value);
  a.download='out.txt';
  asave.click();
}

function _u8_st(u8,off,str) {
  var i;
  for(i=0;i<str.length;i++) u8[off+i]=str.charCodeAt(i);
}

function _u8_i2(u8,off,x) { 
  x|=0;
  u8[off]=x,u8[off+1]=x>>8;
}

function _u8_i4(u8,off,x) { 
  x|=0;
  u8[off]=x,u8[off+1]=x>>8,u8[off+2]=x>>16,u8[off+3]=x>>24;
}

function _wav_hdr(u8,freq,chan,samp,bps) {
  var bps=bps>0?bps<8?bps:bps/8:2,len=chan*bps*samp;
  if(!u8) u8=new Uint8Array(44+len);
  _u8_st(u8,0,'RIFF');
  _u8_i4(u8,4,36+len);
  _u8_st(u8,8,'WAVE');
  _u8_st(u8,12,'fmt ');
  _u8_i4(u8,16,16);
  _u8_i2(u8,20,1);
  _u8_i2(u8,22,chan);
  _u8_i4(u8,24,freq);
  _u8_i4(u8,28,freq*bps*chan);
  _u8_i2(u8,32,bps*chan);
  _u8_i2(u8,34,8*bps);
  _u8_st(u8,36,'data');
  _u8_i4(u8,40,len);
  return u8;
}

function _data(u8,type,onload) {
  var d,f=new FileReader(),b=new Blob([u8],type?{type:type}:undefined);
  f.onload=onload;
  f.readAsDataURL(b);
}

function _wav(amp,ms,hz,hz2) {
  var i,g,ph,fq=48000,len=0|(ms*fq/1000),u8=_wav_hdr(0,fq,1,len);
  if(!hz2) hz2=hz;
  for(i=0,g=44;i<len;i++) {
    ph=i*(i*(hz2-hz)/2+hz*fq)/fq/fq*2*Math.PI,v=amp*Math.sin(ph)|0;
    u8[g++]=v,u8[g++]=v>>8;
  }
  return u8;
}

_data(_wav(5e3,220,150,880),'audio/wav',function(e) { beep_aud=new Audio(e.target.result);});

var beep_aud;
function _beep() {
  if(beep_aud) beep_aud.play();
}

</script>
</form>
</html>
